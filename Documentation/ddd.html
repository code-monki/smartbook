<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction_and_scope">1. Introduction and Scope</a></li>
<li><a href="#_data_structure_specification">2. Data Structure Specification</a>
<ul class="sectlevel2">
<li><a href="#_form_definition_json_schema_form_schema_json">2.1. Form Definition JSON Schema (form_schema_json)</a>
<ul class="sectlevel3">
<li><a href="#_top_level_schema_structure">2.1.1. Top-Level Schema Structure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_initial_smartbook_cartridge_sqlite_schema">3. Initial Smartbook Cartridge SQLite Schema</a>
<ul class="sectlevel2">
<li><a href="#_metadata_table_updated">3.1. <code>Metadata</code> Table (UPDATED)</a></li>
<li><a href="#_content_pages_table">3.2. <code>Content_Pages</code> Table</a></li>
<li><a href="#_form_definitions_table">3.3. <code>Form_Definitions</code> Table</a></li>
<li><a href="#_user_data_table">3.4. <code>User_Data</code> Table</a></li>
<li><a href="#_settings_table">3.5. <code>Settings</code> Table</a></li>
<li><a href="#_embedded_apps_table">3.6. <code>Embedded_Apps</code> Table</a></li>
<li><a href="#_settings_table_2">3.7. <code>Settings</code> Table</a></li>
<li><a href="#_content_themes_table">3.8. <code>Content_Themes</code> Table</a></li>
<li><a href="#_cartridge_security_table">3.9. <code>Cartridge_Security</code> Table</a></li>
<li><a href="#_navigation_structure_table">3.10. <code>Navigation_Structure</code> Table</a></li>
</ul>
</li>
<li><a href="#_reader_local_persistence_schema">4. Reader Local Persistence Schema</a>
<ul class="sectlevel2">
<li><a href="#_local_library_manifest_table_updated">4.1. <code>Local_Library_Manifest</code> Table (UPDATED)</a></li>
<li><a href="#_local_trust_registry_table">4.2. <code>Local_Trust_Registry</code> Table</a></li>
<li><a href="#_local_user_settings_table">4.3. <code>Local_User_Settings</code> Table</a></li>
<li><a href="#_local_bookmarks_table">4.4. <code>Local_Bookmarks</code> Table</a></li>
<li><a href="#_local_reading_position_table">4.5. <code>Local_Reading_Position</code> Table</a></li>
<li><a href="#_local_cartridge_groups_table">4.6. <code>Local_Cartridge_Groups</code> Table</a></li>
<li><a href="#_local_cartridge_group_members_table">4.7. <code>Local_Cartridge_Group_Members</code> Table</a></li>
<li><a href="#_local_window_state_table">4.8. <code>Local_Window_State</code> Table</a></li>
</ul>
</li>
<li><a href="#_component_interface_specification">5. Component Interface Specification</a>
<ul class="sectlevel2">
<li><a href="#_webchannel_bridge_api_smartbookbridge">5.1. WebChannel Bridge API (SmartbookBridge)</a>
<ul class="sectlevel3">
<li><a href="#_core_api_methods_summary">5.1.1. Core API Methods Summary</a></li>
<li><a href="#_persistence_layer_interactions_reader_core">5.1.2. Persistence Layer Interactions (Reader Core)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_form_rendering_and_interaction_specification">6. Form Rendering and Interaction Specification</a>
<ul class="sectlevel2">
<li><a href="#_form_embedding_in_content_pages">6.1. Form Embedding in Content Pages</a>
<ul class="sectlevel3">
<li><a href="#_embedding_syntax">6.1.1. Embedding Syntax</a></li>
<li><a href="#_form_detection_and_rendering_flow">6.1.2. Form Detection and Rendering Flow</a></li>
</ul>
</li>
<li><a href="#_form_rendering_algorithm">6.2. Form Rendering Algorithm</a>
<ul class="sectlevel3">
<li><a href="#_field_type_to_html_element_mapping">6.2.1. Field Type to HTML Element Mapping</a></li>
<li><a href="#_form_structure_generation">6.2.2. Form Structure Generation</a></li>
</ul>
</li>
<li><a href="#_form_validation">6.3. Form Validation</a>
<ul class="sectlevel3">
<li><a href="#_client_side_validation">6.3.1. Client-Side Validation</a></li>
<li><a href="#_validation_error_display">6.3.2. Validation Error Display</a></li>
</ul>
</li>
<li><a href="#_form_data_persistence">6.4. Form Data Persistence</a>
<ul class="sectlevel3">
<li><a href="#_persistence_to_cartridge_user_data_table">6.4.1. Persistence to Cartridge (<code>User_Data</code> Table)</a></li>
<li><a href="#_persistence_to_sandbox_file_system">6.4.2. Persistence to Sandbox File System</a></li>
</ul>
</li>
<li><a href="#_form_printing">6.5. Form Printing</a>
<ul class="sectlevel3">
<li><a href="#_print_functionality">6.5.1. Print Functionality</a></li>
</ul>
</li>
<li><a href="#_form_state_management">6.6. Form State Management</a>
<ul class="sectlevel3">
<li><a href="#_auto_save">6.6.1. Auto-Save</a></li>
<li><a href="#_form_reset">6.6.2. Form Reset</a></li>
</ul>
</li>
<li><a href="#_multiple_form_instances">6.7. Multiple Form Instances</a></li>
<li><a href="#_form_versioning_and_data_migration">6.8. Form Versioning and Data Migration</a>
<ul class="sectlevel3">
<li><a href="#_form_versioning_strategy">6.8.1. Form Versioning Strategy</a></li>
<li><a href="#_form_page_structure">6.8.2. Form Page Structure</a></li>
<li><a href="#_form_builder_version_management">6.8.3. Form Builder Version Management</a></li>
<li><a href="#_migration_rules_json_structure">6.8.4. Migration Rules JSON Structure</a></li>
<li><a href="#_form_data_migration_algorithm">6.8.5. Form Data Migration Algorithm</a></li>
<li><a href="#_migration_security_considerations">6.8.6. Migration Security Considerations</a></li>
<li><a href="#_form_builder_migration_interface_specification">6.8.7. Form Builder Migration Interface Specification</a></li>
</ul>
</li>
<li><a href="#_form_field_undoredo">6.9. Form Field Undo/Redo</a></li>
</ul>
</li>
<li><a href="#_custom_navigation_bar_implementation_specification">7. Custom Navigation Bar Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_navigation_structure_loading">7.1. Navigation Structure Loading</a></li>
<li><a href="#_navigation_bar_html_structure">7.2. Navigation Bar HTML Structure</a></li>
<li><a href="#_navigation_target_resolution">7.3. Navigation Target Resolution</a></li>
<li><a href="#_browse_navigation_implementation">7.4. Browse Navigation Implementation</a></li>
<li><a href="#_department_navigation_implementation">7.5. Department Navigation Implementation</a></li>
<li><a href="#_bibliography_navigation_implementation">7.6. Bibliography Navigation Implementation</a></li>
<li><a href="#_navigation_bar_css_styling">7.7. Navigation Bar CSS Styling</a></li>
<li><a href="#_keyboard_navigation">7.8. Keyboard Navigation</a></li>
</ul>
</li>
<li><a href="#_content_navigation_implementation_specification">8. Content Navigation Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_forwardbackward_navigation">8.1. Forward/Backward Navigation</a></li>
<li><a href="#_table_of_contents_generation">8.2. Table of Contents Generation</a></li>
<li><a href="#_tabbed_pane_interface">8.3. Tabbed Pane Interface</a></li>
<li><a href="#_internal_link_navigation">8.4. Internal Link Navigation</a></li>
<li><a href="#_bookmarking_implementation">8.5. Bookmarking Implementation</a></li>
<li><a href="#_reading_position_persistence">8.6. Reading Position Persistence</a></li>
<li><a href="#_navigation_history">8.7. Navigation History</a></li>
</ul>
</li>
<li><a href="#_search_functionality_implementation_specification">9. Search Functionality Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_document_search_implementation">9.1. Document Search Implementation</a>
<ul class="sectlevel3">
<li><a href="#_search_modal_ui">9.1.1. Search Modal UI</a></li>
<li><a href="#_normal_search_algorithm">9.1.2. Normal Search Algorithm</a></li>
<li><a href="#_boolean_search_algorithm">9.1.3. Boolean Search Algorithm</a></li>
<li><a href="#_fuzzy_search_algorithm">9.1.4. Fuzzy Search Algorithm</a></li>
<li><a href="#_regex_search_algorithm">9.1.5. Regex Search Algorithm</a></li>
<li><a href="#_search_results_display">9.1.6. Search Results Display</a></li>
<li><a href="#_search_performance_optimization">9.1.7. Search Performance Optimization</a></li>
</ul>
</li>
<li><a href="#_in_page_search_implementation">9.2. In-Page Search Implementation</a>
<ul class="sectlevel3">
<li><a href="#_find_in_page_dialog">9.2.1. Find-in-Page Dialog</a></li>
<li><a href="#_term_highlighting">9.2.2. Term Highlighting</a></li>
<li><a href="#_match_navigation">9.2.3. Match Navigation</a></li>
<li><a href="#_result_count_display">9.2.4. Result Count Display</a></li>
<li><a href="#_case_sensitivity">9.2.5. Case Sensitivity</a></li>
<li><a href="#_search_persistence_across_pages">9.2.6. Search Persistence Across Pages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_content_theme_manager_implementation_specification">10. Content Theme Manager Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_content_theme_manager_dialog_structure">10.1. Content Theme Manager Dialog Structure</a></li>
<li><a href="#_left_panel_available_themes">10.2. Left Panel - Available Themes</a></li>
<li><a href="#_right_panel_theme_configuration">10.3. Right Panel - Theme Configuration</a>
<ul class="sectlevel3">
<li><a href="#_name_section">10.3.1. Name Section</a></li>
<li><a href="#_core_colors_simple_section">10.3.2. Core Colors (Simple) Section</a></li>
<li><a href="#_live_preview_section">10.3.3. Live Preview Section</a></li>
</ul>
</li>
<li><a href="#_theme_management_operations">10.4. Theme Management Operations</a>
<ul class="sectlevel3">
<li><a href="#_add_new_theme">10.4.1. Add New Theme</a></li>
<li><a href="#_delete_theme">10.4.2. Delete Theme</a></li>
<li><a href="#_copy_theme">10.4.3. Copy Theme</a></li>
<li><a href="#_rename_theme">10.4.4. Rename Theme</a></li>
<li><a href="#_apply_theme">10.4.5. Apply Theme</a></li>
<li><a href="#_save_theme">10.4.6. Save Theme</a></li>
<li><a href="#_revert_theme">10.4.7. Revert Theme</a></li>
</ul>
</li>
<li><a href="#_theme_configuration_storage">10.5. Theme Configuration Storage</a></li>
<li><a href="#_theme_application_to_content">10.6. Theme Application to Content</a></li>
<li><a href="#_built_in_themes">10.7. Built-in Themes</a></li>
</ul>
</li>
<li><a href="#_print_functionality_implementation_specification">11. Print Functionality Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_print_capabilities">11.1. Print Capabilities</a></li>
<li><a href="#_print_css_stylesheets">11.2. Print CSS Stylesheets</a>
<ul class="sectlevel3">
<li><a href="#_us_letter_8_5_11_print_css">11.2.1. US Letter (8.5" × 11") Print CSS</a></li>
<li><a href="#_a4_210mm_297mm_print_css">11.2.2. A4 (210mm × 297mm) Print CSS</a></li>
</ul>
</li>
<li><a href="#_print_rendering_implementation">11.3. Print Rendering Implementation</a></li>
<li><a href="#_print_preview">11.4. Print Preview</a></li>
<li><a href="#_print_quality_considerations">11.5. Print Quality Considerations</a></li>
<li><a href="#_print_css_priority">11.6. Print CSS Priority</a></li>
<li><a href="#_multi_page_document_printing">11.7. Multi-Page Document Printing</a></li>
</ul>
</li>
<li><a href="#_text_selection_and_copy_implementation_specification">12. Text Selection and Copy Implementation Specification</a>
<ul class="sectlevel2">
<li><a href="#_text_selection">12.1. Text Selection</a></li>
<li><a href="#_copy_to_clipboard">12.2. Copy to Clipboard</a></li>
<li><a href="#_paste_functionality">12.3. Paste Functionality</a></li>
<li><a href="#_context_menu">12.4. Context Menu</a></li>
<li><a href="#_clipboard_integration">12.5. Clipboard Integration</a></li>
<li><a href="#_form_field_paste_handling">12.6. Form Field Paste Handling</a></li>
<li><a href="#_selection_persistence">12.7. Selection Persistence</a></li>
<li><a href="#_standard_keyboard_shortcuts">12.8. Standard Keyboard Shortcuts</a></li>
</ul>
</li>
<li><a href="#_cartridge_signature_verification_process_algorithm">13. Cartridge Signature Verification Process Algorithm</a>
<ul class="sectlevel2">
<li><a href="#_4_phase_verification_algorithm_sequence_diagram">13.1. 4-Phase Verification Algorithm Sequence Diagram</a></li>
<li><a href="#_phase_1_integrity_check_and_identity_establishment">13.2. Phase 1: Integrity Check and Identity Establishment</a></li>
<li><a href="#_phase_2_trust_level_assignment">13.3. Phase 2: Trust Level Assignment</a></li>
<li><a href="#_phase_3_local_trust_registry_and_policy_enforcement">13.4. Phase 3: Local Trust Registry and Policy Enforcement</a></li>
<li><a href="#_phase_4_embedded_application_execution_policy">13.5. Phase 4: Embedded Application Execution Policy</a></li>
<li><a href="#_certificate_validation_implementation">13.6. Certificate Validation Implementation</a>
<ul class="sectlevel3">
<li><a href="#_certificate_extraction">13.6.1. Certificate Extraction</a></li>
<li><a href="#_system_certificate_store_integration">13.6.2. System Certificate Store Integration</a></li>
<li><a href="#_certificate_validation_algorithm">13.6.3. Certificate Validation Algorithm</a></li>
<li><a href="#_expired_ca_certificate_handling">13.6.4. Expired CA Certificate Handling</a></li>
<li><a href="#_certificate_revocation_deferred_for_phase_1">13.6.5. Certificate Revocation (Deferred for Phase 1)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_content_hash_algorithm_specification">14. Content Hash Algorithm Specification</a>
<ul class="sectlevel2">
<li><a href="#_hash_algorithm">14.1. Hash Algorithm</a></li>
<li><a href="#_tables_included_in_hash">14.2. Tables Included in Hash</a></li>
<li><a href="#_hash_calculation_algorithm_option_a_concatenate_table_hashes">14.3. Hash Calculation Algorithm (Option A: Concatenate Table Hashes)</a></li>
<li><a href="#_table_ordering">14.4. Table Ordering</a></li>
<li><a href="#_row_ordering">14.5. Row Ordering</a></li>
<li><a href="#_row_serialization">14.6. Row Serialization</a></li>
<li><a href="#_empty_table_handling">14.7. Empty Table Handling</a></li>
<li><a href="#_hash_calculation_pseudocode">14.8. Hash Calculation Pseudocode</a></li>
<li><a href="#_verification_process">14.9. Verification Process</a></li>
<li><a href="#_security_considerations">14.10. Security Considerations</a></li>
<li><a href="#_public_key_extraction_and_fingerprint_verification">14.11. Public Key Extraction and Fingerprint Verification</a>
<ul class="sectlevel3">
<li><a href="#_public_key_source">14.11.1. Public Key Source</a></li>
<li><a href="#_public_key_extraction_process">14.11.2. Public Key Extraction Process</a></li>
<li><a href="#_fingerprint_verification">14.11.3. Fingerprint Verification</a></li>
<li><a href="#_public_key_storage">14.11.4. Public Key Storage</a></li>
<li><a href="#_key_rotation_and_updates">14.11.5. Key Rotation and Updates</a></li>
<li><a href="#_security_considerations_2">14.11.6. Security Considerations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_embedded_application_specification">15. Embedded Application Specification</a>
<ul class="sectlevel2">
<li><a href="#_concept_and_purpose">15.1. Concept and Purpose</a></li>
<li><a href="#_json_structure_embedded_app_manifest">15.2. JSON Structure: <code>Embedded_App_Manifest</code></a></li>
<li><a href="#_embedded_application_execution_flow">15.3. Embedded Application Execution Flow</a></li>
<li><a href="#_sandbox_file_system_api">15.4. Sandbox File System API</a></li>
<li><a href="#_javascript_security_sandbox_and_api_restrictions">15.5. JavaScript Security Sandbox and API Restrictions</a>
<ul class="sectlevel3">
<li><a href="#_qt_webengine_native_sandboxing">15.5.1. Qt WebEngine Native Sandboxing</a></li>
<li><a href="#_network_api_restrictions">15.5.2. Network API Restrictions</a></li>
<li><a href="#_file_system_api_restrictions">15.5.3. File System API Restrictions</a></li>
<li><a href="#_storage_api_restrictions">15.5.4. Storage API Restrictions</a></li>
<li><a href="#_clipboard_api_restrictions">15.5.5. Clipboard API Restrictions</a></li>
<li><a href="#_device_access_api_restrictions">15.5.6. Device Access API Restrictions</a></li>
<li><a href="#_window_and_navigation_api_restrictions">15.5.7. Window and Navigation API Restrictions</a></li>
<li><a href="#_communication_api_restrictions">15.5.8. Communication API Restrictions</a></li>
<li><a href="#_worker_api_restrictions">15.5.9. Worker API Restrictions</a></li>
<li><a href="#_evaluation_api_restrictions">15.5.10. Evaluation API Restrictions</a></li>
<li><a href="#_webassembly_api_restrictions">15.5.11. WebAssembly API Restrictions</a></li>
<li><a href="#_notification_api_restrictions">15.5.12. Notification API Restrictions</a></li>
<li><a href="#_content_security_policy_csp_configuration">15.5.13. Content Security Policy (CSP) Configuration</a></li>
<li><a href="#_network_request_interceptor_implementation">15.5.14. Network Request Interceptor Implementation</a></li>
<li><a href="#_security_layers_summary">15.5.15. Security Layers Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_application_architecture_and_window_management">16. Application Architecture and Window Management</a>
<ul class="sectlevel2">
<li><a href="#_multi_window_design">16.1. Multi-Window Design</a></li>
<li><a href="#_component_isolation">16.2. Component Isolation</a></li>
<li><a href="#_window_opening_mechanisms">16.3. Window Opening Mechanisms</a></li>
<li><a href="#_window_state_persistence">16.4. Window State Persistence</a></li>
<li><a href="#_window_state_restoration">16.5. Window State Restoration</a></li>
<li><a href="#_window_minimize_and_restore_behavior">16.6. Window Minimize and Restore Behavior</a></li>
<li><a href="#_window_closing_behavior">16.7. Window Closing Behavior</a></li>
</ul>
</li>
<li><a href="#_creator_tools_cartridge_packaging_algorithm">17. Creator Tool&#8217;s Cartridge Packaging Algorithm</a>
<ul class="sectlevel2">
<li><a href="#_phase_1_content_assembly_and_guid_generation">17.1. Phase 1: Content Assembly and GUID Generation</a></li>
<li><a href="#_phase_2_hash_calculation_and_security_preparation">17.2. Phase 2: Hash Calculation and Security Preparation</a></li>
<li><a href="#_phase_3_signature_application_and_finalization">17.3. Phase 3: Signature Application and Finalization</a></li>
</ul>
</li>
<li><a href="#_c_class_hierarchy_and_data_flow_implementation_design">18. C++ Class Hierarchy and Data Flow (Implementation Design)</a>
<ul class="sectlevel2">
<li><a href="#_core_application_management_classes">18.1. Core Application Management Classes</a></li>
<li><a href="#_reader_view_instance_classes_per_cartridge">18.2. Reader View Instance Classes (Per Cartridge)</a></li>
</ul>
</li>
<li><a href="#_user_interface_ui_design_specification_final">19. User Interface (UI) Design Specification (FINAL)</a>
<ul class="sectlevel2">
<li><a href="#_window_1_library_manager_the_hub_dual_view_final">19.1. Window 1: Library Manager (The Hub) - Dual View (FINAL)</a>
<ul class="sectlevel3">
<li><a href="#_bookshelf_view_visual_mode">19.1.1. Bookshelf View (Visual Mode)</a></li>
<li><a href="#_list_view_data_grid_mode">19.1.2. List-View (Data Grid Mode)</a></li>
</ul>
</li>
<li><a href="#_window_2_reader_view_the_content">19.2. Window 2: Reader View (The Content)</a>
<ul class="sectlevel3">
<li><a href="#_cartridge_loading_consent_dialog_requirements">19.2.1. Cartridge Loading Consent Dialog Requirements</a></li>
</ul>
</li>
<li><a href="#_dialog_appearance_and_positioning">19.3. Dialog Appearance and Positioning</a></li>
<li><a href="#_dialog_content_and_verbiage">19.4. Dialog Content and Verbiage</a>
<ul class="sectlevel3">
<li><a href="#_for_level_2_self_signed_certificate_cartridges">19.4.1. For Level 2 (Self-Signed Certificate) Cartridges</a></li>
<li><a href="#_for_level_3_no_signature_cartridges">19.4.2. For Level 3 (No Signature) Cartridges</a></li>
</ul>
</li>
<li><a href="#_dismissal_behavior">19.5. Dismissal Behavior</a></li>
<li><a href="#_implementation_details">19.6. Implementation Details</a>
<ul class="sectlevel3">
<li><a href="#_native_app_consent_dialog_requirements">19.6.1. Native App Consent Dialog Requirements</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_qt_webengine_configuration_implementation">20. Qt WebEngine Configuration Implementation</a>
<ul class="sectlevel2">
<li><a href="#_qt_webengine_version_requirements">20.1. Qt WebEngine Version Requirements</a></li>
<li><a href="#_webengine_profile_configuration">20.2. WebEngine Profile Configuration</a>
<ul class="sectlevel3">
<li><a href="#_reader_content_rendering_profile">20.2.1. Reader Content Rendering Profile</a></li>
<li><a href="#_embedded_application_profile">20.2.2. Embedded Application Profile</a></li>
<li><a href="#_creator_tool_editing_profile">20.2.3. Creator Tool Editing Profile</a></li>
</ul>
</li>
<li><a href="#_network_request_interceptor_implementation_2">20.3. Network Request Interceptor Implementation</a>
<ul class="sectlevel3">
<li><a href="#_interceptor_class_definition">20.3.1. Interceptor Class Definition</a></li>
</ul>
</li>
<li><a href="#_content_security_policy_csp_configuration_2">20.4. Content Security Policy (CSP) Configuration</a>
<ul class="sectlevel3">
<li><a href="#_csp_header_for_embedded_applications">20.4.1. CSP Header for Embedded Applications</a></li>
</ul>
</li>
<li><a href="#_webchannel_configuration">20.5. WebChannel Configuration</a>
<ul class="sectlevel3">
<li><a href="#_webchannel_setup_for_reader">20.5.1. WebChannel Setup for Reader</a></li>
</ul>
</li>
<li><a href="#_error_handling_configuration">20.6. Error Handling Configuration</a>
<ul class="sectlevel3">
<li><a href="#_javascript_console_error_handling">20.6.1. JavaScript Console Error Handling</a></li>
<li><a href="#_webengine_process_crash_handling">20.6.2. WebEngine Process Crash Handling</a></li>
</ul>
</li>
<li><a href="#_performance_configuration">20.7. Performance Configuration</a>
<ul class="sectlevel3">
<li><a href="#_memory_management">20.7.1. Memory Management</a></li>
<li><a href="#_cache_configuration">20.7.2. Cache Configuration</a></li>
</ul>
</li>
<li><a href="#_htmlcss_standards_support">20.8. HTML/CSS Standards Support</a>
<ul class="sectlevel3">
<li><a href="#_html5_support">20.8.1. HTML5 Support</a></li>
<li><a href="#_css3_support">20.8.2. CSS3 Support</a></li>
</ul>
</li>
<li><a href="#_javascript_engine_configuration">20.9. JavaScript Engine Configuration</a>
<ul class="sectlevel3">
<li><a href="#_v8_engine_features">20.9.1. V8 Engine Features</a></li>
</ul>
</li>
<li><a href="#_additional_settings">20.10. Additional Settings</a>
<ul class="sectlevel3">
<li><a href="#_accessibility_settings">20.10.1. Accessibility Settings</a></li>
<li><a href="#_developer_tools_optional">20.10.2. Developer Tools (Optional)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_sqlite_configuration_implementation">21. SQLite Configuration Implementation</a>
<ul class="sectlevel2">
<li><a href="#_sqlite_version_requirements">21.1. SQLite Version Requirements</a></li>
<li><a href="#_wal_mode_configuration">21.2. WAL Mode Configuration</a>
<ul class="sectlevel3">
<li><a href="#_wal_mode_overview">21.2.1. WAL Mode Overview</a></li>
<li><a href="#_wal_mode_implementation">21.2.2. WAL Mode Implementation</a></li>
</ul>
</li>
<li><a href="#_database_optimization_configuration">21.3. Database Optimization Configuration</a>
<ul class="sectlevel3">
<li><a href="#_page_size_configuration">21.3.1. Page Size Configuration</a></li>
<li><a href="#_cache_size_configuration">21.3.2. Cache Size Configuration</a></li>
<li><a href="#_synchronous_configuration">21.3.3. Synchronous Configuration</a></li>
<li><a href="#_foreign_key_constraints">21.3.4. Foreign Key Constraints</a></li>
<li><a href="#_query_optimizer_configuration">21.3.5. Query Optimizer Configuration</a></li>
</ul>
</li>
<li><a href="#_connection_configuration">21.4. Connection Configuration</a>
<ul class="sectlevel3">
<li><a href="#_connection_setup">21.4.1. Connection Setup</a></li>
</ul>
</li>
<li><a href="#_transaction_management">21.5. Transaction Management</a>
<ul class="sectlevel3">
<li><a href="#_transaction_usage">21.5.1. Transaction Usage</a></li>
<li><a href="#_savepoint_usage">21.5.2. Savepoint Usage</a></li>
</ul>
</li>
<li><a href="#_database_maintenance">21.6. Database Maintenance</a>
<ul class="sectlevel3">
<li><a href="#_vacuum_operation">21.6.1. Vacuum Operation</a></li>
<li><a href="#_integrity_checks">21.6.2. Integrity Checks</a></li>
<li><a href="#_backup_and_restore">21.6.3. Backup and Restore</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_platform_specific_considerations_implementation">22. Platform-Specific Considerations Implementation</a>
<ul class="sectlevel2">
<li><a href="#_platform_detection_and_configuration">22.1. Platform Detection and Configuration</a></li>
<li><a href="#_qt_fusion_widget_set_configuration">22.2. Qt Fusion Widget Set Configuration</a></li>
<li><a href="#_platform_specific_data_directories">22.3. Platform-Specific Data Directories</a></li>
<li><a href="#_platform_specific_secure_storage">22.4. Platform-Specific Secure Storage</a></li>
<li><a href="#_certificate_validation">22.5. Certificate Validation</a></li>
<li><a href="#_universal_binary_support_macos">22.6. Universal Binary Support (macOS)</a></li>
<li><a href="#_file_associations">22.7. File Associations</a></li>
<li><a href="#_url_scheme_handling">22.8. URL Scheme Handling</a></li>
</ul>
</li>
<li><a href="#_series_and_edition_grouping_implementation">23. Series and Edition Grouping Implementation</a>
<ul class="sectlevel2">
<li><a href="#_series_and_edition_metadata">23.1. Series and Edition Metadata</a></li>
<li><a href="#_auto_grouping_by_series">23.2. Auto-Grouping by Series</a></li>
<li><a href="#_auto_grouping_by_edition">23.3. Auto-Grouping by Edition</a></li>
<li><a href="#_custom_collections">23.4. Custom Collections</a></li>
<li><a href="#_grouping_ui_implementation">23.5. Grouping UI Implementation</a></li>
<li><a href="#_grouping_maintenance">23.6. Grouping Maintenance</a></li>
<li><a href="#_performance_considerations">23.7. Performance Considerations</a></li>
</ul>
</li>
<li><a href="#_help_system_and_user_manual_implementation">24. Help System and User Manual Implementation</a>
<ul class="sectlevel2">
<li><a href="#_help_system_architecture">24.1. Help System Architecture</a></li>
<li><a href="#_help_system_access_implementation">24.2. Help System Access Implementation</a></li>
<li><a href="#_integrated_help_viewer">24.3. Integrated Help Viewer</a></li>
<li><a href="#_pdf_manual_generation">24.4. PDF Manual Generation</a></li>
<li><a href="#_context_sensitive_help">24.5. Context-Sensitive Help</a></li>
<li><a href="#_platform_specific_help_integration">24.6. Platform-Specific Help Integration</a></li>
<li><a href="#_user_manual_content_specification">24.7. User Manual Content Specification</a></li>
<li><a href="#_help_content_maintenance">24.8. Help Content Maintenance</a></li>
</ul>
</li>
<li><a href="#_error_handling_and_logging_implementation">25. Error Handling and Logging Implementation</a>
<ul class="sectlevel2">
<li><a href="#_error_handling_strategy">25.1. Error Handling Strategy</a></li>
<li><a href="#_reader_application_error_handling">25.2. Reader Application Error Handling</a>
<ul class="sectlevel3">
<li><a href="#_cartridge_file_errors">25.2.1. Cartridge File Errors</a></li>
<li><a href="#_database_connection_errors">25.2.2. Database Connection Errors</a></li>
<li><a href="#_signature_verification_errors">25.2.3. Signature Verification Errors</a></li>
<li><a href="#_file_system_errors">25.2.4. File System Errors</a></li>
<li><a href="#_manifest_update_error_handling">25.2.5. Manifest Update Error Handling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_cartridge_import_process_specification">26. Cartridge Import Process Specification</a>
<ul class="sectlevel2">
<li><a href="#_import_mechanisms">26.1. Import Mechanisms</a></li>
<li><a href="#_import_storage_location">26.2. Import Storage Location</a></li>
<li><a href="#_import_progress_dialog">26.3. Import Progress Dialog</a></li>
<li><a href="#_duplicate_detection_and_handling">26.4. Duplicate Detection and Handling</a></li>
<li><a href="#_import_validation">26.5. Import Validation</a></li>
<li><a href="#_import_workflow_algorithm">26.6. Import Workflow Algorithm</a></li>
<li><a href="#_import_error_handling">26.7. Import Error Handling</a></li>
</ul>
</li>
<li><a href="#_database_migration_strategy">27. Database Migration Strategy</a>
<ul class="sectlevel2">
<li><a href="#_cartridge_format_version_migration">27.1. Cartridge Format Version Migration</a>
<ul class="sectlevel3">
<li><a href="#_version_detection">27.1.1. Version Detection</a></li>
<li><a href="#_migration_strategy">27.1.2. Migration Strategy</a></li>
<li><a href="#_format_version_changes">27.1.3. Format Version Changes</a></li>
<li><a href="#_migration_transformations">27.1.4. Migration Transformations</a></li>
<li><a href="#_migration_error_handling">27.1.5. Migration Error Handling</a></li>
</ul>
</li>
<li><a href="#_reader_local_database_schema_migration">27.2. Reader Local Database Schema Migration</a>
<ul class="sectlevel3">
<li><a href="#_version_tracking">27.2.1. Version Tracking</a></li>
<li><a href="#_migration_process">27.2.2. Migration Process</a></li>
<li><a href="#_migration_error_handling_2">27.2.3. Migration Error Handling</a></li>
<li><a href="#_schema_version_history">27.2.4. Schema Version History</a></li>
</ul>
</li>
<li><a href="#_handling_older_format_cartridges">27.3. Handling Older Format Cartridges</a>
<ul class="sectlevel3">
<li><a href="#_webengine_errors">27.3.1. WebEngine Errors</a></li>
</ul>
</li>
<li><a href="#_creator_tool_error_handling">27.4. Creator Tool Error Handling</a>
<ul class="sectlevel3">
<li><a href="#_content_validation_errors">27.4.1. Content Validation Errors</a></li>
<li><a href="#_cartridge_creation_errors">27.4.2. Cartridge Creation Errors</a></li>
<li><a href="#_signing_errors">27.4.3. Signing Errors</a></li>
<li><a href="#_export_errors">27.4.4. Export Errors</a></li>
</ul>
</li>
<li><a href="#_logging_implementation">27.5. Logging Implementation</a>
<ul class="sectlevel3">
<li><a href="#_logging_framework">27.5.1. Logging Framework</a></li>
<li><a href="#_log_file_locations">27.5.2. Log File Locations</a></li>
<li><a href="#_log_format">27.5.3. Log Format</a></li>
<li><a href="#_log_rotation_algorithm">27.5.4. Log Rotation Algorithm</a></li>
<li><a href="#_log_levels">27.5.5. Log Levels</a></li>
<li><a href="#_error_context_logging">27.5.6. Error Context Logging</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_test_suite_requirements_and_acceptance_criteria_expanded">28. Test Suite Requirements and Acceptance Criteria (EXPANDED)</a>
<ul class="sectlevel2">
<li><a href="#_security_and_trust_verification">28.1. Security and Trust Verification</a></li>
<li><a href="#_architectural_and_persistence_validation">28.2. Architectural and Persistence Validation</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_introduction_and_scope">1. Introduction and Scope</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This Detailed Design Document (DDD) specifies the internal structure, data formats, exact interfaces, and core algorithms for the key components of the Smartbook Reader and Creator tools, ensuring synchronized documentation for implementation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structure_specification">2. Data Structure Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines the precise structure for the data persisted within the Smartbook Cartridge.</p>
</div>
<div class="sect2">
<h3 id="_form_definition_json_schema_form_schema_json">2.1. Form Definition JSON Schema (form_schema_json)</h3>
<div class="paragraph">
<p>The JSON schema defining form fields and validation rules, stored in the <code>Form_Definitions</code> table.</p>
</div>
<div class="sect3">
<h4 id="_top_level_schema_structure">2.1.1. Top-Level Schema Structure</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Key</th>
<th class="tableblock halign-center valign-middle">Type</th>
<th class="tableblock halign-center valign-middle">Description</th>
<th class="tableblock halign-center valign-middle">Required?</th>
<th class="tableblock halign-center valign-middle">Example Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schemaVersion</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Versioning for the form schema.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>formId</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unique, permanent identifier for the form.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>character_sheet_v3</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>formTitle</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The human-readable title of the form.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>D&amp;D 5e Character Sheet</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fields</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An ordered array containing field definitions.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;]</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initial_smartbook_cartridge_sqlite_schema">3. Initial Smartbook Cartridge SQLite Schema</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following tables define the structure of the Smartbook Cartridge (<code>.sqlite</code> file).</p>
</div>
<div class="sect2">
<h3 id="_metadata_table_updated">3.1. <code>Metadata</code> Table (UPDATED)</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal primary key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>cartridge_guid</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>TEXT</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>NOT NULL, UNIQUE</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>A UUID Version 4 string. The definitive, immutable unique identifier for the content edition (NFR-3.2).</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>title</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable title of the Smartbook.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>author</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author name(s).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>publisher</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Publisher name. May be NULL for self-published works.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Edition/Revision (e.g., "2.0").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>publication_year</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>TEXT</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>NOT NULL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>The year the content was first published (e.g., "2025").</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tags_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON array of descriptive tags/subjects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cover_image_path</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relative path to the front cover image file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema_version</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smartbook Format Specification version (e.g., "1.0").</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_content_pages_table">3.2. <code>Content_Pages</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the page.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page_order</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, UNIQUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order of the page in the book structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>chapter_title</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Title of the chapter/section this page belongs to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>html_content</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The primary HTML body content.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>associated_css</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inline CSS or reference to a style sheet. This CSS controls the <strong>structure</strong> of the page (layout, positioning, spacing, margins, borders, display properties, etc.). Color and font styling is controlled by content themes (see <code>Content_Themes</code> table).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>CSS vs Theme Distinction:</strong>
* <strong><code>associated_css</code>:</strong> Controls <strong>structural</strong> aspects - layout (flexbox, grid, positioning), spacing (margins, padding), borders, display properties, etc.
* <strong>Content Themes (<code>Content_Themes</code> table):</strong> Controls <strong>visual</strong> aspects - colors (background, text, links), fonts (family, size, weight), typography styling</p>
</div>
</div>
<div class="sect2">
<h3 id="_form_definitions_table">3.3. <code>Form_Definitions</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier referenced by the WebChannel API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form_schema_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The complete JSON schema defining the form fields and validation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form_version</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, DEFAULT 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version number of the form schema. Incremented when form structure changes significantly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>migration_rules_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional JSON structure containing migration rules for upgrading user data from previous form versions. NULL if no migration rules defined.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_user_data_table">3.4. <code>User_Data</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the saved data entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form_key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>form_id</code> that this data belongs to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the form schema when this data was saved. NULL for data saved before versioning was implemented (treated as version 1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>migrated_from_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If this data was migrated from an older form version, this field stores the source version number. NULL if data was saved directly to current version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNIX timestamp of when the data was saved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>serialized_data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The final, validated JSON string of user inputs.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_settings_table">3.5. <code>Settings</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_key</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the setting (e.g., <code>default_font_size</code>, <code>default_font_family</code>, <code>default_theme</code>, <code>page_margins</code>, <code>line_spacing</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_value</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the setting. May be a simple value (e.g., "14") or JSON for complex settings (e.g., <code>{"top": 10, "bottom": 10, "left": 15, "right": 15}</code> for margins).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_type</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data type of the setting: <code>string</code>, <code>integer</code>, <code>float</code>, <code>boolean</code>, <code>json</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional human-readable description of what the setting controls.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores author-defined rendering defaults for the smartbook cartridge. These settings are part of the cartridge itself, defined by the author to provide initial display preferences. Users can override these settings, but the original author-defined defaults are preserved in the cartridge to enable resetting to the author&#8217;s intended appearance.</p>
</div>
<div class="paragraph">
<p><strong>Common Settings:</strong>
* <code>default_font_size</code> - Default font size in points (integer)
* <code>default_font_family</code> - Default font family name (string)
* <code>default_theme</code> - Default theme preference: <code>light</code>, <code>dark</code>, <code>sepia</code> (string)
* <code>page_margins</code> - Page margin settings in pixels (JSON: <code>{"top": X, "bottom": Y, "left": Z, "right": W}</code>)
* <code>line_spacing</code> - Line spacing multiplier (float, e.g., 1.5)
* <code>text_alignment</code> - Default text alignment: <code>left</code>, <code>right</code>, <code>center</code>, <code>justify</code> (string)</p>
</div>
</div>
<div class="sect2">
<h3 id="_embedded_apps_table">3.6. <code>Embedded_Apps</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>app_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the embedded application (matches <code>appId</code> in manifest JSON).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>app_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable name of the application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manifest_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complete <code>Embedded_App_Manifest</code> JSON structure defining the app&#8217;s metadata, entry points, and resource requirements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entry_html</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The primary HTML entry point for the application (SPA root HTML).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>js_code</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compiled or minified JavaScript code for the application. May be NULL if using external scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>css_code</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSS stylesheet code for the application. May be NULL if using external stylesheets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>additional_resources</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZIP archive or JSON manifest of additional resources (images, fonts, data files) required by the app. May be NULL.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Note:</strong> Embedded applications are Single Page Applications (SPAs) or similar interactive components that operate <strong>locally only</strong> within a sandboxed environment. They provide functionality such as character generators, calculators, design tools, etc., but have <strong>no network access</strong> and can only access a local sandbox file system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_settings_table_2">3.7. <code>Settings</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_key</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the setting (e.g., <code>default_font_size</code>, <code>default_font_family</code>, <code>default_theme</code>, <code>page_margins</code>, <code>line_spacing</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_value</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the setting (stored as string, may represent numbers, JSON, or other types).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_type</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the setting value: <code>string</code>, <code>number</code>, <code>boolean</code>, <code>json</code> (for complex settings).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional human-readable description of what the setting controls.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores book-specific rendering defaults defined by the author. These settings provide initial values for how the content should be displayed in the Reader. Users can override these settings, but the original cartridge defaults are preserved to allow resetting to author&#8217;s intended appearance.</p>
</div>
<div class="paragraph">
<p><strong>Common Settings:</strong>
* <code>default_font_size</code> - Default font size in points (e.g., "12")
* <code>default_font_family</code> - Default font family name (e.g., "Georgia", "Arial")
* <code>default_theme</code> - Default theme preference (e.g., "light", "dark", "sepia")
* <code>page_margins</code> - Page margin settings (JSON: <code>{"top": 20, "bottom": 20, "left": 30, "right": 30}</code>)
* <code>line_spacing</code> - Line spacing multiplier (e.g., "1.5")
* <code>text_alignment</code> - Default text alignment (e.g., "left", "justify")
* <code>page_width</code> - Preferred page width (e.g., "800px" or "100%")</p>
</div>
</div>
<div class="sect2">
<h3 id="_content_themes_table">3.8. <code>Content_Themes</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>theme_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the content theme (e.g., "light-content", "dark-content").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>theme_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable name of the theme (e.g., "Light Content", "Dark Content").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is_builtin</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, DEFAULT 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean flag: 1 for built-in themes (immutable), 0 for custom themes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>theme_config_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON structure containing theme configuration (colors, fonts, styling).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is_active</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">DEFAULT 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean flag: 1 if this theme is currently applied to the cartridge.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores content themes for smartbook cartridges. Themes define how content is rendered (colors, fonts, styling) and can be applied to control the appearance of content in the Reader. Built-in themes are immutable; custom themes can be created, modified, and deleted by authors.</p>
</div>
<div class="paragraph">
<p><strong>Theme Configuration JSON Structure:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "coreColors": {
    "primary": "#1976D2",
    "onPrimary": "#FFFFFF",
    "surface": "#FFFFFF",
    "onSurface": "#000000",
    "background": "#F5F5F5"
  },
  "fonts": {
    "heading": "Georgia, serif",
    "body": "Arial, sans-serif",
    "monospace": "Courier New, monospace"
  },
  "styling": {
    "linkColor": "#1976D2",
    "emphasisStyle": "italic",
    "codeBackground": "#F5F5F5"
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cartridge_security_table">3.9. <code>Cartridge_Security</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>digest_type</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash algorithm used. <strong>SHALL</strong> be "SHA-256" for Phase 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hash_digest</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The binary hash of the critical content tables (H1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>digital_signature</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The H1 hash signed by the author&#8217;s private key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>public_key_fingerprint</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fingerprint of the public key used for verification.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>certificate_data</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The X.509 certificate (DER or PEM format) used for signing. Required for Level 1 (CA-signed) and Level 2 (self-signed) cartridges.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_navigation_structure_table">3.10. <code>Navigation_Structure</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nav_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the navigation entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the navigation group (e.g., "Browse", "Departments", "Bibliographies").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_order</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display order of the navigation group (lower numbers appear first).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>item_label</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display label for the menu item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>item_order</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display order of the item within its group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target_type</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of navigation target: <code>page_id</code>, <code>anchor_id</code>, <code>page_and_anchor</code>, <code>custom_handler</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target_value</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Navigation target value:
  * For <code>page_id</code>: The page_id to navigate to
  * For <code>anchor_id</code>: The anchor ID (assumes current page)
  * For <code>page_and_anchor</code>: Format "page_id#anchor_id"
  * For <code>custom_handler</code>: Custom JavaScript handler identifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parent_item_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional parent item ID for hierarchical navigation (sub-menus). NULL for top-level items.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata_json</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional JSON object containing additional metadata (e.g., icon path, tooltip, filter criteria for Browse navigation).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores custom navigation bar structure for cartridges. This enables magazine collections and similar content to provide specialized navigation (Browse by Creator/Issue/Title, Departments, Bibliographies, etc.) separate from the application menu.</p>
</div>
<div class="paragraph">
<p><strong>Navigation Structure Examples:</strong></p>
</div>
<div class="paragraph">
<p><strong>Browse Group:</strong>
* Group: "Browse" (group_order: 1)
  * Item: "By Creator" (item_order: 1, target_type: "custom_handler", target_value: "browse_by_creator")
  * Item: "By Issue" (item_order: 2, target_type: "custom_handler", target_value: "browse_by_issue")
  * Item: "By Title" (item_order: 3, target_type: "custom_handler", target_value: "browse_by_title")</p>
</div>
<div class="paragraph">
<p><strong>Departments Group:</strong>
* Group: "Departments" (group_order: 2)
  * Item: "Department 1" (item_order: 1, target_type: "page_id", target_value: "42")
  * Item: "Department 2" (item_order: 2, target_type: "page_id", target_value: "58")</p>
</div>
<div class="paragraph">
<p><strong>Bibliographies Group:</strong>
* Group: "Bibliographies" (group_order: 3)
  * Item: "APA Format" (item_order: 1, target_type: "page_and_anchor", target_value: "100#apa-bibliography")
  * Item: "CMS Format" (item_order: 2, target_type: "page_and_anchor", target_value: "100#cms-bibliography")</p>
</div>
<div class="paragraph">
<p><strong>Metadata JSON Structure:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "icon": "path/to/icon.png",
  "tooltip": "Browse articles by creator name",
  "filter_criteria": {
    "type": "creator",
    "field": "author"
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reader_local_persistence_schema">4. Reader Local Persistence Schema</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These tables exist in a separate, local SQLite database maintained by the Reader Application for user preferences, security, and library management.</p>
</div>
<div class="sect2">
<h3 id="_local_library_manifest_table_updated">4.1. <code>Local_Library_Manifest</code> Table (UPDATED)</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manifest_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal primary key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, UNIQUE (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID (UUID v4) of the cartridge.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_hash</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The content hash (H2) for integrity checking.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local_path</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full file path on the user&#8217;s system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>title</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extracted Title.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>author</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extracted Author.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>publisher</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached publisher name from cartridge Metadata table (for fast queries).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extracted Content Version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>publication_year</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>TEXT</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>NOT NULL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cached publication year for fast List-View display.</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cover_image_data</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The binary data of the cover image for fast browsing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_opened</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of last access.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location_status</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Phase 2:</strong> Tracks local/remote status (<code>local_only</code>, <code>remote_only</code>, <code>both</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>series_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached series name from cartridge Metadata table (for fast grouping queries).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edition_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached edition name from cartridge Metadata table (for fast grouping queries).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>series_order</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached series order from cartridge Metadata table (for fast series ordering).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_local_trust_registry_table">4.2. <code>Local_Trust_Registry</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trust_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the trust entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, UNIQUE (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID of the cartridge.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trust_level</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The initial signature trust level (Level 1, 2, or 3).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>app_trust_policy</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User&#8217;s decision: <code>PERSISTENT</code>, <code>SESSION</code>, or <code>REVOKED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the trust decision was made.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_local_user_settings_table">4.3. <code>Local_User_Settings</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>settings_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the settings entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID of the cartridge these settings apply to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_key</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The setting key (matches <code>setting_key</code> in cartridge <code>Settings</code> table).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setting_value</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The user&#8217;s override value for this setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the setting was last modified.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores user preference overrides for cartridge rendering settings. These overrides take precedence over author-defined defaults from the cartridge&#8217;s <code>Settings</code> table, but the original author defaults are preserved in the cartridge for reset functionality.</p>
</div>
<div class="paragraph">
<p><strong>Unique Constraint:</strong> <code>(cartridge_guid, setting_key)</code> - One user override per setting per cartridge.</p>
</div>
<div class="paragraph">
<p><strong>Settings Priority:</strong> When loading a cartridge, settings are applied in this order:
. User override from <code>Local_User_Settings</code> (if exists)
. Author default from cartridge <code>Settings</code> table (if exists)
. Application default (hardcoded fallback)</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_bookmarks_table">4.4. <code>Local_Bookmarks</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bookmark_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the bookmark.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID of the cartridge this bookmark belongs to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>page_id</code> from the cartridge&#8217;s <code>Content_Pages</code> table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>anchor_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional anchor identifier (e.g., heading ID, element ID) within the page.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bookmark_label</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-provided label/name for the bookmark.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the bookmark was created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scroll_position</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional scroll position (pixels from top) for precise position restoration.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores user-created bookmarks for quick navigation to specific pages or positions within pages.</p>
</div>
<div class="paragraph">
<p><strong>Unique Constraint:</strong> <code>(cartridge_guid, page_id, anchor_id)</code> - Prevents duplicate bookmarks for the same location.</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_reading_position_table">4.5. <code>Local_Reading_Position</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>position_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the reading position entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, UNIQUE (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID of the cartridge (one reading position per cartridge).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>page_id</code> from the cartridge&#8217;s <code>Content_Pages</code> table where reading stopped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>anchor_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional anchor identifier (e.g., heading ID, element ID) within the page.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scroll_position</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional scroll position (pixels from top) for precise position restoration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_access_timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of when the cartridge was last accessed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores the last reading position for each cartridge, enabling automatic restoration of reading position when cartridge is reopened.</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_cartridge_groups_table">4.6. <code>Local_Cartridge_Groups</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-defined name for the group/collection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_type</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of group: <code>custom_collection</code> (user-defined), <code>series</code> (auto-grouped by series_name), <code>edition</code> (auto-grouped by edition_name).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>created_timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNIX timestamp when the group was created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_modified_timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNIX timestamp when the group was last modified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional user-provided description of the group.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores user-defined custom collections and metadata for auto-grouped series/editions. Custom collections allow users to organize cartridges independently of author-defined series/edition metadata.</p>
</div>
<div class="paragraph">
<p><strong>Group Types:</strong>
* <strong><code>custom_collection</code>:</strong> User-created collection (e.g., "My RPG Collection", "Favorites")
* <strong><code>series</code>:</strong> Auto-grouped by <code>series_name</code> metadata (read-only, managed by system)
* <strong><code>edition</code>:</strong> Auto-grouped by <code>edition_name</code> metadata (read-only, managed by system)</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_cartridge_group_members_table">4.7. <code>Local_Cartridge_Group_Members</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>membership_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the membership record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key to <code>Local_Cartridge_Groups.group_id</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key to <code>Local_Library_Manifest.cartridge_guid</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>added_timestamp</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNIX timestamp when the cartridge was added to the group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>display_order</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional display order within the group (for custom collections). NULL for auto-grouped series/editions (uses series_order from metadata).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Junction table linking cartridges to groups (custom collections, series, or editions). For custom collections, users can manually add/remove cartridges. For series/editions, memberships are automatically maintained based on metadata.</p>
</div>
<div class="paragraph">
<p><strong>Constraints:</strong>
* Unique constraint on (<code>group_id</code>, <code>cartridge_guid</code>) to prevent duplicate memberships
* Foreign key constraints ensure referential integrity</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_window_state_table">4.8. <code>Local_Window_State</code> Table</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Column Name</th>
<th class="tableblock halign-center valign-middle">SQLite Type</th>
<th class="tableblock halign-center valign-middle">Constraints</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state_id</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID for the window state entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL, UNIQUE (FK)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique ID of the cartridge (one window state per cartridge).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window_width</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window width in pixels.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window_height</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window height in pixels.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window_x</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window X position (left edge) in screen coordinates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window_y</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Window Y position (top edge) in screen coordinates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is_maximized</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean flag (0 = false, 1 = true) indicating whether window was maximized.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>last_updated</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp when window state was last saved.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Purpose:</strong> Stores window geometry and state (size, position, maximized state) for each cartridge, enabling restoration of window appearance when cartridge is reopened.</p>
</div>
<div class="paragraph">
<p><strong>Unique Constraint:</strong> <code>(cartridge_guid)</code> - One window state entry per cartridge.</p>
</div>
<div class="paragraph">
<p><strong>Update Strategy:</strong> On cartridge close or page navigation, update or insert record for <code>cartridge_guid</code> with current <code>page_id</code>, <code>anchor_id</code>, <code>scroll_position</code>, and <code>last_access_timestamp</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_component_interface_specification">5. Component Interface Specification</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_webchannel_bridge_api_smartbookbridge">5.1. WebChannel Bridge API (SmartbookBridge)</h3>
<div class="sect3">
<h4 id="_core_api_methods_summary">5.1.1. Core API Methods Summary</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 27.2727%;">
<col style="width: 18.1818%;">
<col style="width: 36.3637%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">C++ Method Name</th>
<th class="tableblock halign-center valign-middle">JS Method Signature</th>
<th class="tableblock halign-center valign-middle">Return Type (JS)</th>
<th class="tableblock halign-center valign-middle">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveFormData</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveFormData(formId, dataJson, callback)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persists user data from a form into the <code>User_Data</code> table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loadFormData</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loadFormData(formId, callback)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">JSON String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves the most recent serialized data for a specific form ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logMessage(level, message)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">void</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sends debug/error messages to the native C++ logging system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requestAppConsent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requestAppConsent(appId, callback)</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggers the native modal dialog for embedded app security consent.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_persistence_layer_interactions_reader_core">5.1.2. Persistence Layer Interactions (Reader Core)</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Core Operation</th>
<th class="tableblock halign-center valign-middle">Database Operation</th>
<th class="tableblock halign-center valign-middle">Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>loadFormData</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT</code> from <code>User_Data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves the <strong>latest</strong> data record: <code>ORDER BY timestamp DESC LIMIT 1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>saveFormData</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT</code> into <code>User_Data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a new, immutable record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Integrity Check</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT</code> from <code>Cartridge_Security</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read security parameters upon cartridge load.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Content Loading</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT</code> from <code>Content_Pages</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves HTML/CSS based on navigation requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Form Rendering</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT</code> from <code>Form_Definitions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves <code>form_schema_json</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_form_rendering_and_interaction_specification">6. Form Rendering and Interaction Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how forms are embedded, rendered, and interacted with in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_form_embedding_in_content_pages">6.1. Form Embedding in Content Pages</h3>
<div class="paragraph">
<p>Forms are embedded within content pages using a special HTML marker element. The Reader detects these markers and dynamically renders the corresponding form definition.</p>
</div>
<div class="sect3">
<h4 id="_embedding_syntax">6.1.1. Embedding Syntax</h4>
<div class="paragraph">
<p>Forms are embedded in <code>Content_Pages.html_content</code> using one of the following patterns:</p>
</div>
<div class="paragraph">
<p><strong>Pattern 1: Data Attribute (Recommended)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;div data-smartbook-form="form_id" data-form-instance="optional_instance_id"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Pattern 2: Custom Element (Alternative)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;smartbook-form form-id="form_id" instance-id="optional_instance_id"&gt;&lt;/smartbook-form&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Parameters:</strong>
* <code>form_id</code> (required): The <code>form_id</code> from the <code>Form_Definitions</code> table
* <code>instance_id</code> (optional): Unique identifier for this form instance, allowing multiple instances of the same form on different pages</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_detection_and_rendering_flow">6.1.2. Form Detection and Rendering Flow</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Content Loading:</strong> Reader loads <code>html_content</code> from <code>Content_Pages</code> table</p>
</li>
<li>
<p><strong>Form Marker Detection:</strong> Reader scans HTML for form markers (<code>data-smartbook-form</code> attribute or <code>&lt;smartbook-form&gt;</code> elements)</p>
</li>
<li>
<p><strong>Form Definition Retrieval:</strong> For each detected marker, Reader queries <code>Form_Definitions</code> table using <code>form_id</code></p>
</li>
<li>
<p><strong>JSON Schema Parsing:</strong> Reader parses <code>form_schema_json</code> to extract field definitions</p>
</li>
<li>
<p><strong>HTML Form Generation:</strong> Reader generates standard HTML form elements based on field definitions</p>
</li>
<li>
<p><strong>Form Injection:</strong> Reader replaces form marker with generated HTML form</p>
</li>
<li>
<p><strong>Data Loading:</strong> Reader loads saved form data (if any) and populates form fields</p>
</li>
<li>
<p><strong>Event Binding:</strong> Reader binds form events (submit, change, validation) to WebChannel API</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_rendering_algorithm">6.2. Form Rendering Algorithm</h3>
<div class="paragraph">
<p>The Reader converts form definition JSON schema to HTML form elements using the following mapping:</p>
</div>
<div class="sect3">
<h4 id="_field_type_to_html_element_mapping">6.2.1. Field Type to HTML Element Mapping</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Field Type</th>
<th class="tableblock halign-center valign-middle">HTML Element</th>
<th class="tableblock halign-center valign-middle">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>text</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="text"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard text input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="number"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numeric input with min/max validation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>email</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="email"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Email input with format validation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="url"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL input with format validation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="date"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date picker input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="time"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time picker input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>textarea</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;textarea&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi-line text input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;select&gt;</code> with <code>&lt;option&gt;</code> elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dropdown selection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>radio</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="radio"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Radio button group</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checkbox</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;input type="checkbox"&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkbox input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;fieldset&gt;</code> with <code>&lt;legend&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grouping container for nested fields</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_form_structure_generation">6.2.2. Form Structure Generation</h4>
<div class="paragraph">
<p><strong>Algorithm:</strong>
. Create <code>&lt;form&gt;</code> element with <code>id="smartbook-form-{formId}-{instanceId}"</code>
. Add form title as <code>&lt;h2&gt;</code> or <code>&lt;legend&gt;</code> if <code>formTitle</code> is defined
. Iterate through <code>fields</code> array in order:
   a. For each field, generate appropriate HTML element based on <code>fieldType</code>
   b. Set <code>name</code> attribute to <code>fieldId</code>
   c. Set <code>id</code> attribute to <code>{formId}-{fieldId}-{instanceId}</code>
   d. Apply <code>defaultValue</code> if present
   e. Apply <code>placeholder</code> if present
   f. Apply validation attributes (<code>required</code>, <code>min</code>, <code>max</code>, <code>pattern</code>, etc.)
   g. For <code>group</code> type, create <code>&lt;fieldset&gt;</code> and recursively process <code>children</code> array
. Add form action buttons: "Save", "Reset", "Print" (if enabled)
. Apply CSS classes for styling: <code>smartbook-form</code>, <code>smartbook-form-field</code>, etc.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_validation">6.3. Form Validation</h3>
<div class="sect3">
<h4 id="_client_side_validation">6.3.1. Client-Side Validation</h4>
<div class="paragraph">
<p>Validation is performed using HTML5 validation attributes and custom JavaScript validation:</p>
</div>
<div class="paragraph">
<p><strong>HTML5 Attributes Applied:</strong>
* <code>required</code> - If <code>validation.required === true</code>
* <code>min</code> / <code>max</code> - For numeric fields (<code>validation.min</code>, <code>validation.max</code>)
* <code>minlength</code> / <code>maxlength</code> - For text fields (<code>validation.minLength</code>, <code>validation.maxLength</code>)
* <code>pattern</code> - For regex validation (<code>validation.pattern</code>)
* <code>type</code> - For email, url, date, time fields</p>
</div>
<div class="paragraph">
<p><strong>Custom Validation:</strong>
* Custom validation rules are enforced via JavaScript event handlers
* Validation errors are displayed inline using HTML5 <code>:invalid</code> pseudo-class and custom error messages
* Error messages are displayed inline using <code>&lt;span class="error-message"&gt;</code> elements</p>
</div>
</div>
<div class="sect3">
<h4 id="_validation_error_display">6.3.2. Validation Error Display</h4>
<div class="paragraph">
<p><strong>Error Display Pattern:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;div class="form-field"&gt;
  &lt;label for="field-id"&gt;Field Label&lt;/label&gt;
  &lt;input type="text" id="field-id" name="fieldId" required&gt;
  &lt;span class="error-message" id="field-id-error" role="alert"&gt;&lt;/span&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Error Message Population:</strong>
* Error messages are populated from <code>validation.errorMessage</code> in form schema
* If no custom message, default HTML5 validation messages are used
* Error messages are displayed immediately on field blur or form submit</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_data_persistence">6.4. Form Data Persistence</h3>
<div class="sect3">
<h4 id="_persistence_to_cartridge_user_data_table">6.4.1. Persistence to Cartridge (<code>User_Data</code> Table)</h4>
<div class="paragraph">
<p><strong>Save Operation:</strong>
. User clicks "Save" button or auto-save triggers
. Form data is serialized to JSON: <code>{ "fieldId1": "value1", "fieldId2": "value2", &#8230;&#8203; }</code>
. JSON is validated against form schema
. WebChannel API <code>saveFormData(formId, dataJson, callback)</code> is called
. C++ core inserts new record into <code>User_Data</code> table:
   * <code>form_key</code> = <code>formId</code>
   * <code>form_version</code> = current form version (from <code>Form_Definitions</code> table)
   * <code>migrated_from_version</code> = NULL (data saved directly to current version)
   * <code>serialized_data</code> = validated JSON string
   * <code>timestamp</code> = current UNIX timestamp</p>
</div>
<div class="paragraph">
<p><strong>Load Operation:</strong>
. Form is rendered
. Reader retrieves current form version from <code>Form_Definitions</code> table
. WebChannel API <code>loadFormData(formId, callback)</code> is called
. C++ core queries <code>User_Data</code> table: <code>SELECT serialized_data, form_version, migrated_from_version FROM User_Data WHERE form_key = formId ORDER BY timestamp DESC LIMIT 1</code>
. If saved data version &lt; current form version, apply migration (see "Form Versioning and Data Migration" section)
. JSON data (migrated if necessary) is returned to JavaScript
. Form fields are populated with loaded values</p>
</div>
</div>
<div class="sect3">
<h4 id="_persistence_to_sandbox_file_system">6.4.2. Persistence to Sandbox File System</h4>
<div class="paragraph">
<p><strong>Save Operation:</strong>
. User selects "Save to Sandbox" option (if available)
. Form data is serialized to JSON
. <strong>File Selection:</strong> Reader presents sandbox file picker dialog:
   a. User can select existing file to overwrite, or
   b. User can enter new filename
   c. File picker is restricted to sandbox directory only (no navigation outside)
   d. Default filename suggested: <code>{formId}_{instanceId}_data.json</code>
. WebChannel API <code>saveSandboxFile(filename, jsonData, callback)</code> is called
. File is saved to embedded app&#8217;s sandbox directory
. Embedded app can access file via <code>loadSandboxFile</code> API</p>
</div>
<div class="paragraph">
<p><strong>Load Operation:</strong>
. Form checks for sandbox file on load
. <strong>File Selection:</strong> Reader provides option to use sandbox file picker:
   a. User can browse available files in sandbox directory
   b. File picker displays list of available JSON files (or all files)
   c. User selects file to load
   d. File picker is restricted to sandbox directory only
. WebChannel API <code>loadSandboxFile(filename, callback)</code> is called with selected filename
. JSON data is loaded and form fields are populated</p>
</div>
<div class="paragraph">
<p><strong>Sandbox File Picker Requirements:</strong>
* <strong>Security:</strong> File picker MUST be restricted to sandbox directory only
* <strong>Navigation:</strong> User MUST NOT be able to navigate outside sandbox directory
* <strong>File Filtering:</strong> Option to filter by file type (e.g., JSON files only)
* <strong>File Listing:</strong> Display available files in sandbox with metadata (size, date modified)
* <strong>File Selection:</strong> User can select existing file or enter new filename
* <strong>Validation:</strong> Filename validation prevents path traversal and invalid characters</p>
</div>
<div class="paragraph">
<p><strong>Use Case:</strong> Enables embedded applications to process form data (e.g., character generators, calculators, design tools)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_printing">6.5. Form Printing</h3>
<div class="sect3">
<h4 id="_print_functionality">6.5.1. Print Functionality</h4>
<div class="paragraph">
<p><strong>Print Button:</strong> Forms include a "Print" button that triggers print functionality.</p>
</div>
<div class="paragraph">
<p><strong>Print Algorithm:</strong>
. User clicks "Print" button
. Form is cloned and transformed for printing:
   a. Remove all <code>&lt;input&gt;</code>, <code>&lt;select&gt;</code>, <code>&lt;textarea&gt;</code> elements
   b. Replace with <code>&lt;span&gt;</code> or <code>&lt;div&gt;</code> elements displaying current field values
   c. Apply print-specific CSS (<code>@media print</code>)
   d. Hide form action buttons
   e. Show field labels and values in print-friendly format
. Browser print dialog is triggered (<code>window.print()</code>)
. Print preview shows form with values, not input controls</p>
</div>
<div class="paragraph">
<p><strong>Print CSS:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css">@media print {
  .smartbook-form input,
  .smartbook-form select,
  .smartbook-form textarea {
    display: none;
  }
  .smartbook-form .print-value {
    display: inline;
    font-weight: bold;
  }
  .smartbook-form button {
    display: none;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_state_management">6.6. Form State Management</h3>
<div class="sect3">
<h4 id="_auto_save">6.6.1. Auto-Save</h4>
<div class="paragraph">
<p><strong>Configuration:</strong>
* Auto-save interval: Configurable (default: 30 seconds)
* Auto-save trigger: Field blur event or interval timer
* Auto-save scope: Current form instance only</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
. Timer starts when form is loaded
. On field blur or timer expiration, form data is serialized
. If data has changed since last save, <code>saveFormData</code> is called
. Visual indicator shows "Saving&#8230;&#8203;" and "Saved" states</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_reset">6.6.2. Form Reset</h4>
<div class="paragraph">
<p><strong>Reset to Defaults:</strong>
. User clicks "Reset" button
. All form fields are restored to <code>defaultValue</code> from form schema
. Unsaved changes are discarded
. Saved data remains in <code>User_Data</code> table (not deleted)</p>
</div>
<div class="paragraph">
<p><strong>Clear Form:</strong>
. User selects "Clear" option
. All form fields are set to empty/null values
. Saved data remains in <code>User_Data</code> table (not deleted)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_form_instances">6.7. Multiple Form Instances</h3>
<div class="paragraph">
<p><strong>Instance Isolation:</strong>
* Each form instance has unique <code>instance_id</code>
* Form data is scoped by <code>formId</code> + <code>instanceId</code> combination
* Multiple instances of same form can exist on different pages
* Each instance maintains independent data state</p>
</div>
<div class="paragraph">
<p><strong>Instance ID Generation:</strong>
* If <code>instance-id</code> attribute is provided, use that value
* If not provided, generate unique ID: <code>{pageId}-{formId}-{timestamp}</code></p>
</div>
<div class="paragraph">
<p><strong>Data Scoping:</strong>
* When saving: <code>saveFormData(formId + "-" + instanceId, dataJson, callback)</code>
* When loading: <code>loadFormData(formId + "-" + instanceId, callback)</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_form_versioning_and_data_migration">6.8. Form Versioning and Data Migration</h3>
<div class="paragraph">
<p>This section defines how form schemas are versioned and how user data is migrated when form definitions change.</p>
</div>
<div class="sect3">
<h4 id="_form_versioning_strategy">6.8.1. Form Versioning Strategy</h4>
<div class="paragraph">
<p><strong>Version Number:</strong>
* Each form has a <code>form_version</code> integer in the <code>Form_Definitions</code> table
* Version starts at 1 for new forms
* Version is incremented when form structure changes significantly (fields added/removed/renamed, validation rules changed, field types changed)</p>
</div>
<div class="paragraph">
<p><strong>Version Increment Triggers:</strong>
* <strong>Breaking Changes:</strong> Field removed, field renamed, field type changed, validation rules changed significantly
* <strong>Non-Breaking Changes:</strong> Field added (with default value), field label changed, placeholder text changed, validation rules made more permissive</p>
</div>
<div class="paragraph">
<p><strong>Version Tracking:</strong>
* Current form version stored in <code>Form_Definitions.form_version</code>
* Form schema JSON also includes <code>schemaVersion</code> field (matches <code>form_version</code>)
* User data stores <code>form_version</code> when saved, allowing Reader to detect version mismatches</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_page_structure">6.8.2. Form Page Structure</h4>
<div class="paragraph">
<p><strong>Dedicated Form Pages:</strong>
* Forms SHALL be placed on dedicated content pages, not intermingled with other content text
* A form page contains only the form marker element: <code>&lt;div data-smartbook-form="form_id"&gt;&lt;/div&gt;</code>
* Form pages may include minimal descriptive text (form title, instructions) but the form itself is the primary content
* Form pages are regular <code>Content_Pages</code> entries with form markers</p>
</div>
<div class="paragraph">
<p><strong>Form Embedding:</strong>
* Forms are embedded using existing form marker mechanism
* Form builder output is injected at the designated point in the content page
* If a form page already exists, form builder can overwrite it with updated form
* Form pages are identified by presence of form marker in <code>html_content</code></p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* Clear separation between forms and content text
* Easier form management and versioning
* Better user experience (forms are clearly distinct from reading content)
* Simplifies form builder workflow</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_builder_version_management">6.8.3. Form Builder Version Management</h4>
<div class="paragraph">
<p><strong>Version Management UI:</strong>
* Form Builder displays current form version
* Version increment button/option when making breaking changes
* Version history view showing changes between versions
* Migration mapping interface for defining field mappings</p>
</div>
<div class="paragraph">
<p><strong>Version Increment Workflow:</strong>
. Author makes changes to form in Form Builder
. Form Builder detects if changes are breaking (field removed, renamed, type changed)
. If breaking changes detected, prompt author to increment version
. Author can choose to:
   * Increment version and define migration rules
   * Revert changes
   * Save as new form (different <code>form_id</code>)</p>
</div>
<div class="paragraph">
<p><strong>Migration Mapping Interface:</strong>
* When version is incremented, Form Builder shows migration mapping interface
* Lists all fields from previous version
* For each field, author can:
   * Map to new field (if renamed)
   * Set default value (if field removed)
   * Map to new field with transformation (if field type changed)
* Author can preview migration results before saving</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_rules_json_structure">6.8.4. Migration Rules JSON Structure</h4>
<div class="paragraph">
<p>Migration rules are stored in <code>Form_Definitions.migration_rules_json</code> as a JSON object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "fromVersion": 1,
  "toVersion": 2,
  "fieldMappings": [
    {
      "oldFieldId": "character_name",
      "newFieldId": "name",
      "action": "rename"
    },
    {
      "oldFieldId": "character_class",
      "newFieldId": "class",
      "action": "rename"
    },
    {
      "oldFieldId": "old_field",
      "action": "remove",
      "defaultValue": ""
    },
    {
      "oldFieldId": "level",
      "newFieldId": "character_level",
      "action": "rename",
      "transform": {
        "type": "type_cast",
        "fromType": "string",
        "toType": "integer"
      }
    }
  ],
  "newFields": [
    {
      "fieldId": "new_field",
      "defaultValue": "default_value"
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Migration Rule Actions:</strong>
* <strong><code>rename</code></strong> - Map old field to new field (field ID changed)
* <strong><code>remove</code></strong> - Field was removed, use default value
* <strong><code>transform</code></strong> - Field exists but type changed, apply transformation
* <strong><code>copy</code></strong> - Copy field value as-is (explicit mapping, optional)</p>
</div>
<div class="paragraph">
<p><strong>New Fields:</strong>
* Fields added in new version get default values from schema
* Migration rules can override defaults if needed</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_data_migration_algorithm">6.8.5. Form Data Migration Algorithm</h4>
<div class="paragraph">
<p><strong>Migration Process:</strong>
. <strong>Load Saved Data:</strong> Retrieve most recent user data for form
. <strong>Check Version:</strong> Compare saved data <code>form_version</code> with current form version
. <strong>If Versions Match:</strong> Return data as-is (no migration needed)
. <strong>If Versions Don&#8217;t Match:</strong>
   a. Load migration rules from <code>Form_Definitions.migration_rules_json</code>
   b. If no migration rules, attempt automatic migration (see below)
   c. Apply migration rules to transform data
   d. Validate migrated data against new form schema
   e. If validation fails, load with defaults and warn user
   f. Save migrated data with new version number and <code>migrated_from_version</code> set</p>
</div>
<div class="paragraph">
<p><strong>Automatic Migration (No Rules Defined):</strong>
* If migration rules are not defined, attempt automatic field mapping:
  * Fields with same <code>fieldId</code> are copied as-is
  * Fields that don&#8217;t exist in new schema are dropped
  * New fields get default values from schema
* Automatic migration only works for compatible changes (field additions, non-breaking changes)
* Breaking changes (field removals, renames, type changes) require explicit migration rules</p>
</div>
<div class="paragraph">
<p><strong>Migration Validation:</strong>
* After migration, validate migrated data against new form schema
* Check required fields are present
* Check data types match field types
* Check validation rules pass
* If validation fails:
  * Log warning
  * Load form with defaults
  * Display message to user: "Form has been updated. Some of your previous data could not be migrated. Please review and update your entries."</p>
</div>
<div class="paragraph">
<p><strong>Migration Data Saving:</strong>
* When migrated data is saved, set:
  * <code>form_version</code> = current form version
  * <code>migrated_from_version</code> = original saved data version
* Original data record is preserved (not deleted) for audit trail
* New record is created with migrated data</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_security_considerations">6.8.6. Migration Security Considerations</h4>
<div class="paragraph">
<p><strong>Input Validation:</strong>
* Validate migration rules JSON structure before saving
* Validate field mappings reference valid fields in both old and new schemas
* Validate transformation rules (prevent code injection)
* Sanitize default values (prevent XSS in migrated data)</p>
</div>
<div class="paragraph">
<p><strong>Data Validation:</strong>
* Always validate migrated data against new form schema
* Reject migrated data that doesn&#8217;t pass validation
* Never execute arbitrary code during migration
* Type transformations must be safe (string to number, etc.)</p>
</div>
<div class="paragraph">
<p><strong>Version Integrity:</strong>
* Prevent version downgrades (could corrupt data)
* Validate version numbers are sequential
* Validate migration rules target correct version range
* Log all migration operations for audit trail</p>
</div>
<div class="paragraph">
<p><strong>User Consent:</strong>
* When migration occurs, inform user that form has been updated
* Show which fields were migrated and which were reset to defaults
* Allow user to review migrated data before saving
* Provide option to start fresh (discard old data)</p>
</div>
</div>
<div class="sect3">
<h4 id="_form_builder_migration_interface_specification">6.8.7. Form Builder Migration Interface Specification</h4>
<div class="paragraph">
<p><strong>Migration Mapping Dialog:</strong>
* Displayed when author increments form version with breaking changes
* Shows side-by-side comparison: old form fields vs new form fields
* For each old field, author can:
  * Map to new field (dropdown of new fields)
  * Mark as removed (set default value)
  * Apply transformation (type conversion, value mapping)
* Preview button to test migration with sample data
* Save migration rules button</p>
</div>
<div class="paragraph">
<p><strong>Migration Preview:</strong>
* Author can enter sample data for old form version
* Preview shows how data would be migrated
* Highlights any fields that would be lost or reset
* Allows author to refine migration rules before saving</p>
</div>
<div class="paragraph">
<p><strong>Version History:</strong>
* Form Builder shows version history for form
* Lists all versions with change descriptions
* Shows migration rules for each version transition
* Allows author to view/edit migration rules for previous versions</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_form_field_undoredo">6.9. Form Field Undo/Redo</h3>
<div class="paragraph">
<p><strong>Undo/Redo Functionality:</strong>
* Support undo/redo operations for text input within form fields
* Maintain undo/redo history per form field independently
* Clear undo/redo history when form field loses focus or when form is saved</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Use browser/WebEngine&#8217;s native undo/redo capabilities for form inputs
* Keyboard shortcuts:
  * <strong>Undo:</strong> Ctrl+Z (Windows/Linux) or Cmd+Z (macOS)
  * <strong>Redo:</strong> Ctrl+Y or Ctrl+Shift+Z (Windows/Linux) or Cmd+Shift+Z (macOS)
* Undo/redo works within the focused form field only
* History is maintained in memory (not persisted)
* History is cleared when:
  * Form field loses focus (blur event)
  * Form data is saved
  * User navigates away from page</p>
</div>
<div class="paragraph">
<p><strong>Undo/Redo Scope:</strong>
* Per-field undo/redo history (each form field has its own history)
* History tracks text changes (insertions, deletions, replacements)
* History does not track field-level operations (clearing field, loading data)
* Maximum history depth: Browser default (typically 50-100 operations)</p>
</div>
<div class="paragraph">
<p><strong>User Experience:</strong>
* Undo/redo works as users expect in standard text editors
* Visual feedback: Text changes immediately when undo/redo is triggered
* No separate undo/redo UI needed (uses standard keyboard shortcuts)
* Context menu may optionally include "Undo" and "Redo" options when appropriate</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_navigation_bar_implementation_specification">7. Custom Navigation Bar Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how custom navigation bars (e.g., Browse, Departments, Bibliographies) are implemented in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_navigation_structure_loading">7.1. Navigation Structure Loading</h3>
<div class="paragraph">
<p><strong>Load Navigation Structure:</strong>
. On cartridge open, query <code>Navigation_Structure</code> table:
   <code>SELECT * FROM Navigation_Structure ORDER BY group_order, item_order</code>
. Group results by <code>group_name</code>
. Build navigation structure object:
   <code>`
   {
     "groups": [
       {
         "name": "Browse",
         "order": 1,
         "items": [
           {
             "label": "By Creator",
             "order": 1,
             "target_type": "custom_handler",
             "target_value": "browse_by_creator",
             "metadata": {&#8230;&#8203;}
           },
           &#8230;&#8203;
         ]
       },
       &#8230;&#8203;
     ]
   }
   </code>`</p>
</div>
<div class="paragraph">
<p><strong>Navigation Bar Rendering:</strong>
. If navigation structure exists, render custom navigation bar
. Navigation bar is rendered as HTML/CSS within the Reader View
. Navigation bar is positioned above main content area
. Navigation bar uses cartridge styling (CSS from <code>Content_Pages</code> or <code>Content_Themes</code>)</p>
</div>
</div>
<div class="sect2">
<h3 id="_navigation_bar_html_structure">7.2. Navigation Bar HTML Structure</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;nav class="smartbook-navbar" id="custom-navbar"&gt;
  &lt;div class="nav-group" data-group="Browse"&gt;
    &lt;button class="nav-group-button"&gt;Browse ▼&lt;/button&gt;
    &lt;ul class="nav-dropdown"&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="custom_handler" data-target-value="browse_by_creator"&gt;By Creator&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="custom_handler" data-target-value="browse_by_issue"&gt;By Issue&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="custom_handler" data-target-value="browse_by_title"&gt;By Title&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;div class="nav-group" data-group="Departments"&gt;
    &lt;button class="nav-group-button"&gt;Departments ▼&lt;/button&gt;
    &lt;ul class="nav-dropdown"&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="page_id" data-target-value="42"&gt;Department 1&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="page_id" data-target-value="58"&gt;Department 2&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;div class="nav-group" data-group="Bibliographies"&gt;
    &lt;button class="nav-group-button"&gt;Bibliographies ▼&lt;/button&gt;
    &lt;ul class="nav-dropdown"&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="page_and_anchor" data-target-value="100#apa-bibliography"&gt;APA Format&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="#" data-target-type="page_and_anchor" data-target-value="100#cms-bibliography"&gt;CMS Format&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/nav&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_navigation_target_resolution">7.3. Navigation Target Resolution</h3>
<div class="paragraph">
<p><strong>Page ID Navigation:</strong>
. Extract <code>target_value</code> (page_id)
. Load page: <code>SELECT html_content FROM Content_Pages WHERE page_id = ?</code>
. Navigate to page (update reading position, add to history)</p>
</div>
<div class="paragraph">
<p><strong>Anchor Navigation:</strong>
. Extract <code>target_value</code> (anchor_id)
. If on current page: Scroll to anchor element
. If anchor is on different page: Load page first, then scroll to anchor
. Update reading position with <code>anchor_id</code></p>
</div>
<div class="paragraph">
<p><strong>Page and Anchor Navigation:</strong>
. Parse <code>target_value</code> format: "page_id#anchor_id"
. Load page: <code>SELECT html_content FROM Content_Pages WHERE page_id = ?</code>
. After page loads, scroll to anchor element
. Update reading position with both <code>page_id</code> and <code>anchor_id</code></p>
</div>
<div class="paragraph">
<p><strong>Custom Handler Navigation:</strong>
. Extract <code>target_value</code> (handler identifier)
. Execute custom JavaScript handler (if defined in embedded app or content)
. Custom handlers may:
   * Filter content by metadata (Browse by Creator/Issue/Title)
   * Display search results
   * Show filtered content views
   * Navigate to dynamically determined targets</p>
</div>
</div>
<div class="sect2">
<h3 id="_browse_navigation_implementation">7.4. Browse Navigation Implementation</h3>
<div class="paragraph">
<p><strong>Browse by Creator:</strong>
. Custom handler: <code>browse_by_creator</code>
. Query <code>Content_Pages</code> for pages with metadata matching creator filter
. Display filtered results or navigate to creator index page
. Filter criteria stored in <code>metadata_json</code>:
   <code><code>json
   {
     "filter_criteria": {
       "type": "creator",
       "field": "author",
       "match": "exact"
     }
   }
   </code></code></p>
</div>
<div class="paragraph">
<p><strong>Browse by Issue:</strong>
. Custom handler: <code>browse_by_issue</code>
. Query pages filtered by issue metadata
. Display issue index or filtered content view</p>
</div>
<div class="paragraph">
<p><strong>Browse by Title:</strong>
. Custom handler: <code>browse_by_title</code>
. Query pages filtered by title metadata
. Display title index or filtered content view</p>
</div>
</div>
<div class="sect2">
<h3 id="_department_navigation_implementation">7.5. Department Navigation Implementation</h3>
<div class="paragraph">
<p><strong>Department Structure:</strong>
. Departments are defined as navigation items in <code>Navigation_Structure</code> table
. Each department item links to a specific page or section
. Departments may have hierarchical structure (parent_item_id for sub-departments)</p>
</div>
<div class="paragraph">
<p><strong>Department Navigation:</strong>
. User selects department from dropdown
. Resolve target (page_id, anchor, or custom handler)
. Navigate to department content
. Update reading position and navigation history</p>
</div>
</div>
<div class="sect2">
<h3 id="_bibliography_navigation_implementation">7.6. Bibliography Navigation Implementation</h3>
<div class="paragraph">
<p><strong>Bibliography Formats:</strong>
. Bibliography items link to citation format reference pages
. Target format: <code>page_and_anchor</code> (e.g., "100#apa-bibliography")
. Navigation loads bibliography reference page and scrolls to format section</p>
</div>
<div class="paragraph">
<p><strong>Bibliography Display:</strong>
. Load target page
. Scroll to anchor (format section)
. Display citation format guidelines and examples</p>
</div>
</div>
<div class="sect2">
<h3 id="_navigation_bar_css_styling">7.7. Navigation Bar CSS Styling</h3>
<div class="paragraph">
<p><strong>Default Navigation Bar Styles:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css">.smartbook-navbar {
  display: flex;
  background-color: #f5f5f5;
  border-bottom: 1px solid #ddd;
  padding: 8px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-group {
  position: relative;
  margin-right: 16px;
}

.nav-group-button {
  background: none;
  border: none;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 14px;
}

.nav-group-button:hover {
  background-color: #e0e0e0;
}

.nav-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background-color: white;
  border: 1px solid #ddd;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  list-style: none;
  padding: 0;
  margin: 0;
  min-width: 200px;
}

.nav-group:hover .nav-dropdown {
  display: block;
}

.nav-dropdown li {
  padding: 0;
}

.nav-dropdown a {
  display: block;
  padding: 8px 16px;
  text-decoration: none;
  color: #333;
}

.nav-dropdown a:hover {
  background-color: #f0f0f0;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Custom Styling:</strong>
* Navigation bar styling can be customized via cartridge CSS
* Styles defined in <code>Content_Pages.associated_css</code> or <code>Content_Themes</code> apply to navigation bar
* Navigation bar respects cartridge theme colors and fonts</p>
</div>
</div>
<div class="sect2">
<h3 id="_keyboard_navigation">7.8. Keyboard Navigation</h3>
<div class="paragraph">
<p><strong>Navigation Bar Keyboard Access:</strong>
. Tab key: Navigate between navigation groups
. Arrow keys: Navigate within dropdown menus
. Enter/Space: Activate selected menu item
. Escape: Close open dropdown menu</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Navigation bar elements have proper ARIA attributes for accessibility
* Keyboard event handlers attached to navigation elements
* Focus management for dropdown menus</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_content_navigation_implementation_specification">8. Content Navigation Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how content navigation, table of contents, bookmarking, and reading position are implemented in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_forwardbackward_navigation">8.1. Forward/Backward Navigation</h3>
<div class="paragraph">
<p><strong>Implementation:</strong>
. Reader maintains current <code>page_id</code> and <code>page_order</code> for active cartridge
. Forward button: Query <code>SELECT page_id FROM Content_Pages WHERE page_order = (SELECT page_order FROM Content_Pages WHERE page_id = ?) + 1 LIMIT 1</code>
. Backward button: Query <code>SELECT page_id FROM Content_Pages WHERE page_order = (SELECT page_order FROM Content_Pages WHERE page_id = ?) - 1 LIMIT 1</code>
. At boundaries: Wrap around (configurable) or disable buttons
. On navigation: Update <code>Local_Reading_Position</code> table with new <code>page_id</code></p>
</div>
<div class="paragraph">
<p><strong>Keyboard Shortcuts:</strong>
* Left Arrow / Page Up: Navigate backward
* Right Arrow / Page Down: Navigate forward
* Home: Navigate to first page
* End: Navigate to last page</p>
</div>
</div>
<div class="sect2">
<h3 id="_table_of_contents_generation">8.2. Table of Contents Generation</h3>
<div class="paragraph">
<p><strong>TOC Generation Algorithm:</strong>
. <strong>Primary Structure (Chapters):</strong>
   a. Query <code>SELECT DISTINCT chapter_title, MIN(page_order) as first_page_order FROM Content_Pages WHERE chapter_title IS NOT NULL GROUP BY chapter_title ORDER BY first_page_order</code>
   b. For each chapter, query pages: <code>SELECT page_id, page_order FROM Content_Pages WHERE chapter_title = ? ORDER BY page_order</code>
   c. Create TOC entry: <code>{ "type": "chapter", "title": chapter_title, "page_id": first_page_id, "children": [&#8230;&#8203;] }</code></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Secondary Structure (Headings):</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>For each page, parse HTML content for heading elements (<code>&lt;h1&gt;</code>, <code>&lt;h2&gt;</code>, <code>&lt;h3&gt;</code>, etc.)</p>
</li>
<li>
<p>Extract heading text and ID (or generate ID if missing)</p>
</li>
<li>
<p>Create nested structure based on heading hierarchy</p>
</li>
<li>
<p>Apply depth limit (default: 2 levels, configurable 1-3)</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>TOC Structure:</strong></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "chapters": [
    {
      "title": "Chapter 1",
      "page_id": 1,
      "page_order": 1,
      "headings": [
        {
          "level": 1,
          "title": "Section 1.1",
          "anchor_id": "section-1-1",
          "page_id": 1
        },
        {
          "level": 2,
          "title": "Subsection 1.1.1",
          "anchor_id": "subsection-1-1-1",
          "page_id": 1
        }
      ],
      "children": []
    }
  ]
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>TOC Display:</strong>
* Tree view with collapsible/expandable nodes
* Click on TOC entry navigates to page and scrolls to anchor (if present)
* Visual indicator for current page/section in TOC
* Search/filter capability within TOC</p>
</div>
</div>
<div class="sect2">
<h3 id="_tabbed_pane_interface">8.3. Tabbed Pane Interface</h3>
<div class="paragraph">
<p><strong>Pane Structure:</strong>
* <strong>Tab 1: Table of Contents</strong>
  * Displays generated TOC tree
  * Collapsible/expandable sections
  * Click to navigate</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tab 2: Search Results</strong></p>
</li>
<li>
<p>Displays search results when search is performed</p>
</li>
<li>
<p>Shows matching pages and context snippets</p>
</li>
<li>
<p>Click to navigate to result location</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Qt <code>QTabWidget</code> or similar tabbed interface
* TOC tab always visible
* Search Results tab appears when search is active
* Both tabs share same navigation target (Reader View)</p>
</div>
</div>
<div class="sect2">
<h3 id="_internal_link_navigation">8.4. Internal Link Navigation</h3>
<div class="paragraph">
<p><strong>Link Processing:</strong>
. Reader intercepts link clicks within content pages
. Parse link href:
   a. <strong>Page reference:</strong> <code>smartbook://page/{page_id}</code> or <code>#page-{page_id}</code>
   b. <strong>Anchor reference:</strong> <code>#anchor-id</code> (within current page) or <code>smartbook://page/{page_id}#anchor-id</code> (cross-page)
   c. <strong>External link:</strong> <code>http://</code> or <code>https://</code> (open in system browser)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Navigation Logic:</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Extract <code>page_id</code> and <code>anchor_id</code> from link</p>
</li>
<li>
<p>Load page: <code>SELECT html_content FROM Content_Pages WHERE page_id = ?</code></p>
</li>
<li>
<p>If <code>anchor_id</code> present, scroll to element with matching ID</p>
</li>
<li>
<p>Update <code>Local_Reading_Position</code> table</p>
</li>
<li>
<p>Add to navigation history stack</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Link Format Examples:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!-- Link to another page --&gt;
&lt;a href="smartbook://page/5"&gt;Go to Chapter 2&lt;/a&gt;

&lt;!-- Link to anchor on current page --&gt;
&lt;a href="#section-1"&gt;Jump to Section 1&lt;/a&gt;

&lt;!-- Link to anchor on another page --&gt;
&lt;a href="smartbook://page/10#character-sheet"&gt;View Character Sheet&lt;/a&gt;

&lt;!-- External link (opens in system browser) --&gt;
&lt;a href="https://example.com"&gt;External Reference&lt;/a&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bookmarking_implementation">8.5. Bookmarking Implementation</h3>
<div class="paragraph">
<p><strong>Add Bookmark:</strong>
. User clicks "Add Bookmark" button or uses keyboard shortcut (Ctrl+B / Cmd+B)
. Reader prompts for bookmark label (default: page title or heading text)
. Reader captures:
   * Current <code>page_id</code>
   * Current <code>anchor_id</code> (if on a heading or anchor)
   * Current <code>scroll_position</code> (optional, for precise restoration)
. Insert into <code>Local_Bookmarks</code> table:
   * <code>cartridge_guid</code> = current cartridge GUID
   * <code>page_id</code> = current page ID
   * <code>anchor_id</code> = current anchor (if any)
   * <code>bookmark_label</code> = user-provided label
   * <code>scroll_position</code> = current scroll position
   * <code>timestamp</code> = current timestamp</p>
</div>
<div class="paragraph">
<p><strong>Bookmark Management:</strong>
* Display bookmarks in dedicated panel or menu
* Show bookmark label, page title, and timestamp
* Allow editing bookmark label
* Allow deleting bookmarks
* Click bookmark to navigate to saved position</p>
</div>
<div class="paragraph">
<p><strong>Navigate to Bookmark:</strong>
. User selects bookmark from list
. Load page: <code>SELECT html_content FROM Content_Pages WHERE page_id = ?</code>
. If <code>anchor_id</code> present, scroll to element
. If <code>scroll_position</code> present, restore scroll position
. Update <code>Local_Reading_Position</code> table</p>
</div>
</div>
<div class="sect2">
<h3 id="_reading_position_persistence">8.6. Reading Position Persistence</h3>
<div class="paragraph">
<p><strong>Save Reading Position:</strong>
. On page navigation or cartridge close:
   a. Capture current <code>page_id</code>
   b. Capture current <code>anchor_id</code> (if on a heading/anchor)
   c. Capture current <code>scroll_position</code> (optional)
   d. Update or insert into <code>Local_Reading_Position</code> table:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cartridge_guid</code> = current cartridge GUID</p>
</li>
<li>
<p><code>page_id</code> = current page ID</p>
</li>
<li>
<p><code>anchor_id</code> = current anchor (if any)</p>
</li>
<li>
<p><code>scroll_position</code> = current scroll position</p>
</li>
<li>
<p><code>last_access_timestamp</code> = current timestamp</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Restore Reading Position:</strong>
. On cartridge open:
   a. Query <code>Local_Reading_Position</code> table: <code>SELECT * FROM Local_Reading_Position WHERE cartridge_guid = ?</code>
   b. If record exists:
      * Load page: <code>SELECT html_content FROM Content_Pages WHERE page_id = ?</code>
      * If <code>anchor_id</code> present, scroll to element after page loads
      * If <code>scroll_position</code> present, restore scroll position
  <br>
   c. If no record exists, load first page (<code>page_order = 1</code>)</p>
</div>
<div class="paragraph">
<p><strong>Position Update Frequency:</strong>
* Update on explicit page navigation (forward/backward buttons, TOC click)
* Update on internal link navigation
* Update on bookmark navigation
* Update on cartridge close/window close
* Optionally update on scroll (debounced, e.g., every 5 seconds)</p>
</div>
</div>
<div class="sect2">
<h3 id="_navigation_history">8.7. Navigation History</h3>
<div class="paragraph">
<p><strong>History Stack:</strong>
* Maintain stack per Reader View Window
* Stack entries: <code>{ page_id, anchor_id, scroll_position }</code>
* Maximum stack size: 50 entries (configurable)</p>
</div>
<div class="paragraph">
<p><strong>Back Navigation:</strong>
. Pop current position from stack (save to end of forward stack)
. Pop previous position from history stack
. Navigate to previous position
. Update <code>Local_Reading_Position</code> table</p>
</div>
<div class="paragraph">
<p><strong>Forward Navigation:</strong>
. Pop next position from forward stack
. Push current position to history stack
. Navigate to next position
. Update <code>Local_Reading_Position</code> table</p>
</div>
<div class="paragraph">
<p><strong>History Management:</strong>
* Clear history on cartridge close
* Maintain separate history per Reader View Window
* Browser-style back/forward buttons or keyboard shortcuts (Alt+Left/Right)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_search_functionality_implementation_specification">9. Search Functionality Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how document search and in-page search are implemented in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_document_search_implementation">9.1. Document Search Implementation</h3>
<div class="sect3">
<h4 id="_search_modal_ui">9.1.1. Search Modal UI</h4>
<div class="paragraph">
<p><strong>Modal Components:</strong>
* <strong>Title:</strong> "Site Search" or "Document Search"
* <strong>Search Input Field:</strong> Text input with placeholder "Search site&#8230;&#8203;" or "Search document&#8230;&#8203;"
* <strong>Case Sensitivity Toggle ("Aa" Button):</strong> Toggle button to enable/disable case-sensitive matching
* <strong>Search Type Dropdown:</strong> Dropdown menu with options:
  * "Normal" - Standard text search (default)
  * "Boolean" - Boolean operator search (AND, OR, NOT)
  * "Fuzzy" - Approximate/fuzzy matching
  * "Regex" - Regular expression pattern matching
* <strong>Search Button:</strong> Execute search button
* <strong>Close Button (X):</strong> Dismiss modal</p>
</div>
<div class="paragraph">
<p><strong>Modal Behavior:</strong>
* Modal appears centered on screen with semi-transparent overlay
* Keyboard shortcut: Ctrl+F / Cmd+F opens modal
* Escape key closes modal
* Enter key in search field executes search</p>
</div>
</div>
<div class="sect3">
<h4 id="_normal_search_algorithm">9.1.2. Normal Search Algorithm</h4>
<div class="paragraph">
<p><strong>Implementation:</strong>
. User enters search term in input field
. If case-sensitive toggle is OFF, convert search term and content to lowercase for comparison
. Query all pages: <code>SELECT page_id, page_order, chapter_title, html_content FROM Content_Pages ORDER BY page_order</code>
. For each page:
   a. Strip HTML tags from <code>html_content</code> to get plain text
   b. Search for search term in plain text
   c. If match found, extract context snippet (e.g., 50 characters before and after match)
   d. Store result: <code>{ page_id, page_order, chapter_title, match_text, context_snippet, match_position }</code>
. Return results sorted by <code>page_order</code></p>
</div>
<div class="paragraph">
<p><strong>Context Snippet Generation:</strong>
* Extract text surrounding match (e.g., 50-100 characters before and after)
* Highlight search term in snippet (bold or different color)
* Truncate with ellipsis if snippet exceeds maximum length</p>
</div>
</div>
<div class="sect3">
<h4 id="_boolean_search_algorithm">9.1.3. Boolean Search Algorithm</h4>
<div class="paragraph">
<p><strong>Boolean Operators:</strong>
* <code>AND</code> - All terms must be present (e.g., "character AND sheet")
* <code>OR</code> - Any term may be present (e.g., "weapon OR armor")
* <code>NOT</code> - Term must not be present (e.g., "magic NOT spell")
* Parentheses for grouping: <code>(character OR player) AND sheet</code></p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
. Parse search query into boolean expression tree
. For each page, evaluate boolean expression against page content
. If expression evaluates to true, include page in results
. Extract context snippets for matched terms</p>
</div>
<div class="paragraph">
<p><strong>Query Parsing:</strong>
* Tokenize input: split on whitespace, identify operators (AND, OR, NOT)
* Build expression tree respecting operator precedence (NOT &gt; AND &gt; OR)
* Evaluate tree against page content</p>
</div>
</div>
<div class="sect3">
<h4 id="_fuzzy_search_algorithm">9.1.4. Fuzzy Search Algorithm</h4>
<div class="paragraph">
<p><strong>Fuzzy Matching:</strong>
* Use edit distance (Levenshtein distance) algorithm
* Allow 1-2 character differences (configurable)
* Match similar words despite typos or misspellings</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
. For each word in search term, find similar words in content
. Calculate edit distance between search term and candidate words
. If edit distance &#8656; threshold (default: 2), consider it a match
. Rank results by similarity score (lower edit distance = higher rank)</p>
</div>
<div class="paragraph">
<p><strong>Performance Optimization:</strong>
* Limit fuzzy search to words of similar length
* Use indexing or caching for frequently searched terms
* Consider limiting fuzzy search to first 1000 pages for performance</p>
</div>
</div>
<div class="sect3">
<h4 id="_regex_search_algorithm">9.1.5. Regex Search Algorithm</h4>
<div class="paragraph">
<p><strong>Implementation:</strong>
. Validate regex pattern syntax
. If invalid, display error message: "Invalid regular expression: [error details]"
. If valid, compile regex pattern
. For each page:
   a. Strip HTML tags to get plain text
   b. Apply regex pattern matching
   c. Extract all matches and context snippets
. Return results with matched patterns highlighted</p>
</div>
<div class="paragraph">
<p><strong>Error Handling:</strong>
* Catch regex compilation errors
* Display user-friendly error messages
* Suggest common regex patterns or provide help link</p>
</div>
</div>
<div class="sect3">
<h4 id="_search_results_display">9.1.6. Search Results Display</h4>
<div class="paragraph">
<p><strong>Results Format (Adobe Reader-style):</strong>
* <strong>Result List:</strong> Scrollable list of results
* <strong>Result Item Structure:</strong>
  * Page/Chapter title (clickable, navigates to page)
  * Context snippet with search term highlighted
  * Match indicator (e.g., "Match 1 of 15")
* <strong>Result Count:</strong> Display total matches found (e.g., "Found 15 matches in 8 pages")
* <strong>Grouping:</strong> Optionally group results by page or chapter</p>
</div>
<div class="paragraph">
<p><strong>Result Item Example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>Chapter 2: Character Creation
...character sheet includes ability scores, skills, and equipment...
Match 1 of 15</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Navigation:</strong>
* Click on result item navigates to corresponding page
* Scrolls to match location within page
* Highlights match on page (temporary highlight)</p>
</div>
</div>
<div class="sect3">
<h4 id="_search_performance_optimization">9.1.7. Search Performance Optimization</h4>
<div class="paragraph">
<p><strong>Indexing Strategy:</strong>
* Option 1: Build search index on cartridge open (one-time cost)
* Option 2: Lazy indexing (index pages as they&#8217;re searched)
* Option 3: No indexing (search on-demand, acceptable for small cartridges)</p>
</div>
<div class="paragraph">
<p><strong>Index Structure:</strong>
* Full-text index: <code>{ word: [page_id, position, context] }</code>
* Store in memory or temporary database
* Rebuild index if cartridge content changes</p>
</div>
<div class="paragraph">
<p><strong>Caching:</strong>
* Cache recent search results
* Cache indexed pages
* Clear cache on cartridge close</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_in_page_search_implementation">9.2. In-Page Search Implementation</h3>
<div class="sect3">
<h4 id="_find_in_page_dialog">9.2.1. Find-in-Page Dialog</h4>
<div class="paragraph">
<p><strong>Dialog Components:</strong>
* Compact bar/overlay at top or bottom of Reader view
* Search input field (auto-focus on open)
* Previous button (up arrow or "Previous")
* Next button (down arrow or "Next")
* Result count display (e.g., "3 of 12")
* Case sensitivity checkbox
* Close button (X)</p>
</div>
<div class="paragraph">
<p><strong>Dialog Behavior:</strong>
* Keyboard shortcut: Ctrl+F / Cmd+F (if document search modal not open) or F3
* Escape key closes dialog
* Enter key moves to next match
* Shift+Enter moves to previous match
* Dialog stays visible while searching</p>
</div>
</div>
<div class="sect3">
<h4 id="_term_highlighting">9.2.2. Term Highlighting</h4>
<div class="paragraph">
<p><strong>Highlighting Implementation:</strong>
. User enters search term in find dialog
. Reader searches current page content for all matches
. Wrap each match in HTML span with highlight class:
   [source,html]
   ----
   &lt;span class="find-highlight"&gt;matched text&lt;/span&gt;
   ----
. Apply CSS styling:
   [source,css]
   ----
   .find-highlight {
     background-color: yellow;
     color: black;
   }
   .find-highlight.active {
     background-color: orange;
     border: 2px solid red;
   }
   ----</p>
</div>
<div class="paragraph">
<p><strong>Dynamic Highlighting:</strong>
* Update highlights as user types (debounced, e.g., 300ms delay)
* Clear highlights when search term is cleared
* Clear highlights when dialog is closed</p>
</div>
</div>
<div class="sect3">
<h4 id="_match_navigation">9.2.3. Match Navigation</h4>
<div class="paragraph">
<p><strong>Navigation Implementation:</strong>
. Maintain array of all match positions: <code>[{ element, offset, text }]</code>
. Track current match index
. On "Next":
   a. Increment current match index
   b. Remove <code>active</code> class from previous match
   c. Add <code>active</code> class to current match
   d. Scroll to current match
. On "Previous":
   a. Decrement current match index
   b. Remove <code>active</code> class from previous match
   c. Add <code>active</code> class to current match
   d. Scroll to current match</p>
</div>
<div class="paragraph">
<p><strong>Scroll to Match:</strong>
* Use <code>element.scrollIntoView({ behavior: 'smooth', block: 'center' })</code>
* Ensure match is centered or visible in viewport
* Handle edge cases (match at top/bottom of page)</p>
</div>
</div>
<div class="sect3">
<h4 id="_result_count_display">9.2.4. Result Count Display</h4>
<div class="paragraph">
<p><strong>Count Calculation:</strong>
* Count total matches on current page
* Track current match position (1-based index)
* Display: "3 of 12" or "Match 3 of 12"</p>
</div>
<div class="paragraph">
<p><strong>Update Frequency:</strong>
* Update count when search term changes
* Update position when navigating between matches
* Display "No matches" when search term not found</p>
</div>
</div>
<div class="sect3">
<h4 id="_case_sensitivity">9.2.5. Case Sensitivity</h4>
<div class="paragraph">
<p><strong>Case-Sensitive Matching:</strong>
* Checkbox or toggle in find dialog
* When enabled, match exact case (e.g., "Character" ≠ "character")
* When disabled, case-insensitive matching (default)
* Re-highlight and re-count when toggled</p>
</div>
</div>
<div class="sect3">
<h4 id="_search_persistence_across_pages">9.2.6. Search Persistence Across Pages</h4>
<div class="paragraph">
<p><strong>Persistence Implementation:</strong>
. Store current search term in Reader View Window state
. When user navigates to new page:
   a. Check if search term exists
   b. If exists, automatically search new page
   c. Highlight matches on new page
   d. Reset match index to 1
   e. Update result count
. Maintain search term until:
   a. User clears search field
   b. User closes find dialog
   c. User opens document search modal</p>
</div>
<div class="paragraph">
<p><strong>State Management:</strong>
* Store search term per Reader View Window
* Persist across page navigation
* Clear on cartridge close</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_content_theme_manager_implementation_specification">10. Content Theme Manager Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how the Content Theme Manager dialog is implemented in the Creator Tool, allowing authors to create and manage themes for smartbook content.</p>
</div>
<div class="sect2">
<h3 id="_content_theme_manager_dialog_structure">10.1. Content Theme Manager Dialog Structure</h3>
<div class="paragraph">
<p><strong>Dialog Layout:</strong>
* <strong>Title:</strong> "Content Theme Manager"
* <strong>Close Button (X):</strong> Top right corner to dismiss dialog
* <strong>Two-Panel Layout:</strong>
  * Left Panel: Available Themes list and management actions
  * Right Panel: Theme configuration and live preview</p>
</div>
</div>
<div class="sect2">
<h3 id="_left_panel_available_themes">10.2. Left Panel - Available Themes</h3>
<div class="paragraph">
<p><strong>Panel Components:</strong>
* <strong>Heading:</strong> "Available Themes" (bold, dark gray)
* <strong>Theme List:</strong> Scrollable list displaying:
  * Theme name (e.g., "Light Content", "Dark Content", "Warm Content")
  * "Apply" button next to each theme
  * Visual indicator for built-in vs custom themes
  * Visual indicator for active theme (currently applied)
* <strong>Action Buttons:</strong> Four buttons below theme list:
  * <strong>Add (+):</strong> Create new custom theme
  * <strong>Delete (-):</strong> Delete selected custom theme (disabled for built-in themes)
  * <strong>Copy:</strong> Duplicate selected theme to create new custom theme
  * <strong>Rename:</strong> Rename selected custom theme (disabled for built-in themes)
* <strong>Checkbox:</strong> "Persist on add" - When enabled, automatically saves theme to cartridge when created/modified</p>
</div>
<div class="paragraph">
<p><strong>Theme List Behavior:</strong>
* Built-in themes (Light Content, Dark Content, Warm Content) are immutable
* Custom themes can be edited, renamed, or deleted
* Clicking a theme selects it and loads its configuration in the right panel
* "Apply" button applies theme to current cartridge immediately</p>
</div>
</div>
<div class="sect2">
<h3 id="_right_panel_theme_configuration">10.3. Right Panel - Theme Configuration</h3>
<div class="paragraph">
<p><strong>Panel Components:</strong></p>
</div>
<div class="sect3">
<h4 id="_name_section">10.3.1. Name Section</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Label:</strong> "Name"</p>
</li>
<li>
<p><strong>Input Field:</strong> Text input for theme name (editable for custom themes, read-only for built-in themes)</p>
</li>
<li>
<p><strong>Action Buttons:</strong></p>
</li>
<li>
<p><strong>Apply:</strong> Apply theme configuration to current cartridge</p>
</li>
<li>
<p><strong>Save:</strong> Save theme configuration (enabled when theme is modified, highlighted in blue)</p>
</li>
<li>
<p><strong>Cancel:</strong> Discard changes and close dialog</p>
</li>
<li>
<p><strong>Revert:</strong> Revert theme to last saved state (enabled when theme has unsaved changes)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_core_colors_simple_section">10.3.2. Core Colors (Simple) Section</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Heading:</strong> "Core Colors (Simple)" (bold, dark gray)</p>
</li>
<li>
<p><strong>Preset Controls:</strong></p>
</li>
<li>
<p><strong>Preset Dropdown:</strong> Select color preset (e.g., "Default", "High Contrast", "Custom")</p>
</li>
<li>
<p><strong>Reset Button:</strong> Reset all colors to default values</p>
</li>
<li>
<p><strong>Show Swatches Checkbox:</strong> Toggle display of color swatches</p>
</li>
<li>
<p><strong>Color Pickers/Swatches:</strong></p>
</li>
<li>
<p><strong>Primary:</strong> Color picker/swatch for primary color</p>
</li>
<li>
<p><strong>On Primary:</strong> Color picker/swatch for text color on primary background</p>
</li>
<li>
<p><strong>Surface:</strong> Color picker/swatch for surface color</p>
</li>
<li>
<p><strong>On Surface:</strong> Color picker/swatch for text color on surface</p>
</li>
<li>
<p><strong>Background:</strong> Color picker/swatch for background color (may have multiple swatches)</p>
</li>
<li>
<p><strong>Descriptive Text:</strong> "Only the core colors are exposed. Background is handled via a decorative pseudo-element so copying text won&#8217;t include background color."</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Color Picker Implementation:</strong>
* Use Qt <code>QColorDialog</code> or custom color picker widget
* Display color swatches showing current color values
* Update live preview when colors change
* Validate color values (hex codes, RGB values)</p>
</div>
</div>
<div class="sect3">
<h4 id="_live_preview_section">10.3.3. Live Preview Section</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Heading:</strong> "Live Preview" (bold, dark gray)</p>
</li>
<li>
<p><strong>Preview Area:</strong> White rectangular area displaying sample content rendered with current theme:</p>
</li>
<li>
<p><strong>Heading:</strong> "Heading Example" (styled with theme heading font/color)</p>
</li>
<li>
<p><strong>Body Text:</strong> "Body text with a link and emphasis. inline code."</p>
</li>
<li>
<p>Link styled with theme link color</p>
</li>
<li>
<p>Emphasis styled with theme emphasis style</p>
</li>
<li>
<p>Inline code styled with theme monospace font and code background</p>
</li>
<li>
<p><strong>Quoted Text:</strong> Indented quoted text example</p>
</li>
<li>
<p><strong>Table:</strong> Two-column table with header row styled with theme colors</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Live Preview Updates:</strong>
* Preview updates in real-time as colors/fonts are modified
* Preview reflects current theme configuration
* Preview uses actual HTML/CSS rendering (Qt WebEngineView or similar)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_theme_management_operations">10.4. Theme Management Operations</h3>
<div class="sect3">
<h4 id="_add_new_theme">10.4.1. Add New Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User clicks "Add (+)" button</p>
</li>
<li>
<p>Create new theme with default configuration:</p>
<div class="ulist">
<ul>
<li>
<p>Generate unique <code>theme_id</code> (e.g., "custom-theme-{timestamp}")</p>
</li>
<li>
<p>Set <code>theme_name</code> to "New Theme" or prompt for name</p>
</li>
<li>
<p>Set <code>is_builtin</code> = 0</p>
</li>
<li>
<p>Set default <code>theme_config_json</code> (copy from "Default" preset)</p>
</li>
<li>
<p>Set <code>is_active</code> = 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add theme to list in left panel</p>
</li>
<li>
<p>Select new theme (loads in right panel for editing)</p>
</li>
<li>
<p>If "Persist on add" is checked, automatically save to cartridge</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_delete_theme">10.4.2. Delete Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User selects custom theme in list</p>
</li>
<li>
<p>User clicks "Delete (-)" button</p>
</li>
<li>
<p>Confirm deletion dialog: "Are you sure you want to delete '{theme_name}'?"</p>
</li>
<li>
<p>If confirmed:</p>
<div class="ulist">
<ul>
<li>
<p>Delete theme from <code>Content_Themes</code> table</p>
</li>
<li>
<p>Remove from theme list</p>
</li>
<li>
<p>If deleted theme was active, apply default theme (Light Content)</p>
</li>
</ul>
</div>
</li>
<li>
<p>If theme is built-in, disable delete button (cannot delete built-in themes)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_copy_theme">10.4.3. Copy Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User selects theme in list (built-in or custom)</p>
</li>
<li>
<p>User clicks "Copy" button</p>
</li>
<li>
<p>Create new theme:</p>
<div class="ulist">
<ul>
<li>
<p>Generate unique <code>theme_id</code></p>
</li>
<li>
<p>Set <code>theme_name</code> to "{original_name} Copy" or prompt for name</p>
</li>
<li>
<p>Copy <code>theme_config_json</code> from selected theme</p>
</li>
<li>
<p>Set <code>is_builtin</code> = 0</p>
</li>
<li>
<p>Set <code>is_active</code> = 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add copied theme to list</p>
</li>
<li>
<p>Select copied theme for editing</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_rename_theme">10.4.4. Rename Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User selects custom theme in list</p>
</li>
<li>
<p>User clicks "Rename" button</p>
</li>
<li>
<p>Prompt for new name (or edit name field directly)</p>
</li>
<li>
<p>Validate name (not empty, unique within cartridge)</p>
</li>
<li>
<p>Update <code>theme_name</code> in <code>Content_Themes</code> table</p>
</li>
<li>
<p>Update theme list display</p>
</li>
<li>
<p>If "Persist on add" is checked, save changes</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_apply_theme">10.4.5. Apply Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User clicks "Apply" button (either in theme list or configuration panel)</p>
</li>
<li>
<p>Update <code>Content_Themes</code> table:</p>
<div class="ulist">
<ul>
<li>
<p>Set <code>is_active</code> = 0 for all themes</p>
</li>
<li>
<p>Set <code>is_active</code> = 1 for selected theme</p>
</li>
</ul>
</div>
</li>
<li>
<p>Generate theme CSS from theme configuration (colors and fonts only)</p>
</li>
<li>
<p>Apply theme CSS to cartridge content (update <code>Settings</code> table or inject CSS)</p>
</li>
<li>
<p>Theme CSS works <strong>in conjunction with</strong> structural CSS (<code>associated_css</code> field)</p>
</li>
<li>
<p>Update preview pane in Creator Tool</p>
</li>
<li>
<p>Visual indicator shows active theme in theme list</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The theme CSS controls colors and fonts, while the CSS stylesheet (<code>associated_css</code>) controls structure (layout, positioning, spacing). Both are applied together for final rendering.</p>
</div>
</div>
<div class="sect3">
<h4 id="_save_theme">10.4.6. Save Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User modifies theme configuration (colors, fonts, etc.)</p>
</li>
<li>
<p>"Save" button becomes enabled (highlighted in blue)</p>
</li>
<li>
<p>User clicks "Save" button</p>
</li>
<li>
<p>Update <code>theme_config_json</code> in <code>Content_Themes</code> table</p>
</li>
<li>
<p>If "Persist on add" is checked, also save to cartridge file</p>
</li>
<li>
<p>"Save" button becomes disabled (changes saved)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_revert_theme">10.4.7. Revert Theme</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User modifies theme configuration</p>
</li>
<li>
<p>"Revert" button becomes enabled</p>
</li>
<li>
<p>User clicks "Revert" button</p>
</li>
<li>
<p>Reload theme configuration from <code>Content_Themes</code> table (last saved state)</p>
</li>
<li>
<p>Reset all color pickers and inputs to saved values</p>
</li>
<li>
<p>Update live preview</p>
</li>
<li>
<p>"Revert" button becomes disabled</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_theme_configuration_storage">10.5. Theme Configuration Storage</h3>
<div class="paragraph">
<p><strong>Database Operations:</strong>
* <strong>Load Themes:</strong> <code>SELECT * FROM Content_Themes ORDER BY is_builtin DESC, theme_name</code>
* <strong>Save Theme:</strong> <code>INSERT OR REPLACE INTO Content_Themes (theme_id, theme_name, is_builtin, theme_config_json, is_active) VALUES (?, ?, ?, ?, ?)</code>
* <strong>Delete Theme:</strong> <code>DELETE FROM Content_Themes WHERE theme_id = ? AND is_builtin = 0</code>
* <strong>Apply Theme:</strong> <code>UPDATE Content_Themes SET is_active = CASE WHEN theme_id = ? THEN 1 ELSE 0 END</code></p>
</div>
<div class="paragraph">
<p><strong>Theme Configuration JSON Schema:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "version": "1.0",
  "coreColors": {
    "primary": "#1976D2",
    "onPrimary": "#FFFFFF",
    "surface": "#FFFFFF",
    "onSurface": "#000000",
    "background": "#F5F5F5"
  },
  "fonts": {
    "heading": "Georgia, serif",
    "body": "Arial, sans-serif",
    "monospace": "Courier New, monospace"
  },
  "styling": {
    "linkColor": "#1976D2",
    "emphasisStyle": "italic",
    "codeBackground": "#F5F5F5",
    "quoteIndent": "20px"
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_theme_application_to_content">10.6. Theme Application to Content</h3>
<div class="paragraph">
<p><strong>Theme vs CSS Distinction:</strong>
* <strong>CSS Stylesheet (<code>associated_css</code> in <code>Content_Pages</code>):</strong> Controls <strong>structure</strong> - layout, positioning, spacing, margins, borders, display properties, flexbox/grid layouts, etc.
* <strong>Content Theme (<code>Content_Themes</code> table):</strong> Controls <strong>colors and fonts</strong> - color schemes, typography (font families, sizes, weights), text colors, background colors, link colors, etc.</p>
</div>
<div class="paragraph">
<p><strong>Design Rationale:</strong>
By separating structural concerns (CSS) from visual appearance concerns (themes), the system achieves a balanced approach:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Author Control:</strong> Authors maintain control over page structure, layout, and organization through CSS, ensuring content is presented as intended</p>
</li>
<li>
<p><strong>User Customization:</strong> Users can customize visual appearance (colors, fonts) through theme selection and user settings, accommodating personal preferences and accessibility needs</p>
</li>
<li>
<p><strong>Middle Ground:</strong> This separation provides a reasonable middle ground between strict author control (no customization) and complete user control (which could break author intent), allowing both parties to achieve their goals without conflict</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Theme CSS Generation:</strong>
. Load active theme from <code>Content_Themes</code> table
. Parse <code>theme_config_json</code> to extract colors, fonts, styling
. Generate CSS rules using CSS custom properties (variables) for <strong>colors and fonts only</strong>:
   [source,css]
   ----
   :root {
     /* Color variables */
     --theme-primary: #1976D2;
     --theme-on-primary: #FFFFFF;
     --theme-surface: #FFFFFF;
     --theme-on-surface: #000000;
     --theme-background: #F5F5F5;
     --theme-link: #1976D2;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  /* Font variables */
  --theme-font-heading: Georgia, serif;
  --theme-font-body: Arial, sans-serif;
  --theme-font-monospace: Courier New, monospace;
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/* Apply colors and fonts only - structure handled by CSS stylesheet */
body {
  background-color: var(--theme-background);
  color: var(--theme-on-surface);
  font-family: var(--theme-font-body);
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>h1, h2, h3 {
  font-family: var(--theme-font-heading);
  color: var(--theme-on-surface);
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>a {
  color: var(--theme-link);
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   code {
     background-color: var(--theme-code-background);
     font-family: var(--theme-font-monospace);
   }
   ----
. Inject theme CSS into cartridge content (add to `Settings` table or inject into HTML)
. Theme CSS works **in conjunction with** the structural CSS stylesheet (`associated_css`)
. Apply to Creator Tool preview pane
. Theme will be applied when cartridge is opened in Reader</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Rendering Priority:</strong>
. Structural CSS (<code>associated_css</code>) is applied first (layout, positioning, spacing)
. Theme CSS is applied second (colors, fonts override defaults)
. User settings (from <code>Local_User_Settings</code>) can override theme colors/fonts</p>
</div>
</div>
<div class="sect2">
<h3 id="_built_in_themes">10.7. Built-in Themes</h3>
<div class="paragraph">
<p><strong>Default Built-in Themes:</strong>
* <strong>Light Content:</strong> Light background, dark text, blue links
* <strong>Dark Content:</strong> Dark background, light text, light blue links
* <strong>Warm Content:</strong> Warm beige/sepia background, dark brown text, warm accent colors</p>
</div>
<div class="paragraph">
<p><strong>Built-in Theme Characteristics:</strong>
* Immutable (cannot be edited, renamed, or deleted)
* Always available in theme list
* Can be copied to create custom variants
* Stored in application, not in cartridge (but can be applied to cartridge)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_print_functionality_implementation_specification">11. Print Functionality Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how print functionality is implemented in the Reader application, including print capabilities, CSS handling, and rendering.</p>
</div>
<div class="sect2">
<h3 id="_print_capabilities">11.1. Print Capabilities</h3>
<div class="paragraph">
<p><strong>Print Options:</strong>
* <strong>Print Entire Document:</strong> Print all pages in the cartridge
* <strong>Print Current Page:</strong> Print only the currently displayed page
* <strong>Print Selection:</strong> Print only selected text/content (if text is selected)</p>
</div>
<div class="paragraph">
<p><strong>Print Dialog:</strong>
* Use Qt <code>QPrintDialog</code> for native system print dialog
* Allow user to configure:
  * Printer selection
  * Page range (for document printing)
  * Number of copies
  * Paper size (US Letter, A4, etc.)
  * Orientation (Portrait, Landscape)
  * Other standard print options (color/grayscale, quality, etc.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_print_css_stylesheets">11.2. Print CSS Stylesheets</h3>
<div class="paragraph">
<p><strong>Built-in Print Stylesheets:</strong>
The Reader provides built-in print CSS optimized for common paper sizes:</p>
</div>
<div class="sect3">
<h4 id="_us_letter_8_5_11_print_css">11.2.1. US Letter (8.5" × 11") Print CSS</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css">@media print {
  @page {
    size: letter;
    margin: 0.75in;
  }

  body {
    font-size: 12pt;
    line-height: 1.5;
  }

  /* Hide non-printable elements */
  .smartbook-navigation,
  .smartbook-controls,
  .smartbook-forms input,
  .smartbook-forms select,
  .smartbook-forms textarea,
  button {
    display: none;
  }

  /* Optimize page breaks */
  h1, h2, h3 {
    page-break-after: avoid;
  }

  p, li {
    page-break-inside: avoid;
  }

  /* Print-friendly link styling */
  a::after {
    content: " (" attr(href) ")";
    font-size: 0.8em;
    color: #666;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a4_210mm_297mm_print_css">11.2.2. A4 (210mm × 297mm) Print CSS</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css">@media print {
  @page {
    size: A4;
    margin: 20mm;
  }

  body {
    font-size: 12pt;
    line-height: 1.5;
  }

  /* Same hide/show rules as US Letter */
  .smartbook-navigation,
  .smartbook-controls,
  .smartbook-forms input,
  .smartbook-forms select,
  .smartbook-forms textarea,
  button {
    display: none;
  }

  h1, h2, h3 {
    page-break-after: avoid;
  }

  p, li {
    page-break-inside: avoid;
  }

  a::after {
    content: " (" attr(href) ")";
    font-size: 0.8em;
    color: #666;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Print CSS Application:</strong>
. Detect selected paper size from print dialog
. Load appropriate built-in print CSS (US Letter or A4)
. Merge with author&#8217;s structural CSS (<code>associated_css</code>)
. Apply theme colors/fonts (from active content theme)
. Apply print-specific overrides via <code>@media print</code> rules
. Ensure print CSS takes precedence for print-specific rules</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_print_rendering_implementation">11.3. Print Rendering Implementation</h3>
<div class="paragraph">
<p><strong>Rendering Strategy:</strong>
. <strong>Content Preparation:</strong>
   a. Load content from <code>Content_Pages</code> table
   b. Apply structural CSS (<code>associated_css</code>)
   c. Apply active theme CSS (colors/fonts)
   d. Apply print CSS based on selected paper size
   e. Remove/hide non-printable elements</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Offscreen Rendering (if required):</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Create offscreen <code>QWebEngineView</code> or <code>QWebEnginePage</code></p>
</li>
<li>
<p>Load prepared HTML content with all CSS applied</p>
</li>
<li>
<p>Wait for content to fully render</p>
</li>
<li>
<p>Capture rendered content for printing</p>
</li>
<li>
<p>Use Qt <code>QPrinter</code> to render to print device</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Qt Print Integration:</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Use <code>QPrintDialog</code> for user print configuration</p>
</li>
<li>
<p>Use <code>QPrinter</code> to handle print rendering</p>
</li>
<li>
<p>Use <code>QWebEnginePage::printToPdf()</code> or <code>QWebEnginePage::print()</code> for WebEngine content</p>
</li>
<li>
<p>Handle page breaks and multi-page documents</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Print Algorithm:</strong>
. User triggers print (menu item, keyboard shortcut Ctrl+P / Cmd+P, or toolbar button)
. Determine print scope:
   * If text selected: Print selection only
   * If "Print Current Page" selected: Print current page only
   * If "Print Document" selected: Print all pages
. Open <code>QPrintDialog</code> for user configuration
. User selects printer, paper size, orientation, etc.
. For each page to print:
   a. Load page content from <code>Content_Pages</code> table
   b. Apply CSS (structural + theme + print)
   c. Render content (onscreen or offscreen)
   d. Send to printer via <code>QPrinter</code>
. Handle page breaks between pages
. Complete print job</p>
</div>
</div>
<div class="sect2">
<h3 id="_print_preview">11.4. Print Preview</h3>
<div class="paragraph">
<p><strong>Preview Implementation:</strong>
. User selects "Print Preview" option
. Prepare content with print CSS applied (same as print rendering)
. Display preview in dialog or separate window
. Show preview with selected paper size and orientation
. Allow user to navigate through pages
. Allow user to adjust print settings and refresh preview
. User can print from preview or cancel</p>
</div>
<div class="paragraph">
<p><strong>Preview Dialog:</strong>
* Display preview pages in scrollable view
* Show page boundaries and margins
* Display page numbers
* Provide zoom controls
* Show print settings summary
* "Print" and "Cancel" buttons</p>
</div>
</div>
<div class="sect2">
<h3 id="_print_quality_considerations">11.5. Print Quality Considerations</h3>
<div class="paragraph">
<p><strong>Text Rendering:</strong>
* Use appropriate font sizes for print (typically 10-12pt)
* Ensure sufficient line spacing for readability
* Use high-quality font rendering
* Handle font fallbacks appropriately</p>
</div>
<div class="paragraph">
<p><strong>Image Handling:</strong>
* Scale images appropriately for print resolution
* Maintain aspect ratios
* Use high-resolution images when available
* Handle image formats appropriately (convert if needed)</p>
</div>
<div class="paragraph">
<p><strong>Color Handling:</strong>
* Preserve color information for color printers
* Provide grayscale option for monochrome printers
* Handle transparency appropriately
* Ensure sufficient contrast for readability</p>
</div>
<div class="paragraph">
<p><strong>Background Handling:</strong>
* Option to print backgrounds (default: off for ink savings)
* Handle decorative backgrounds appropriately
* Ensure text remains readable</p>
</div>
</div>
<div class="sect2">
<h3 id="_print_css_priority">11.6. Print CSS Priority</h3>
<div class="paragraph">
<p><strong>CSS Application Order:</strong>
. <strong>Structural CSS</strong> (<code>associated_css</code>) - Base layout and structure
. <strong>Theme CSS</strong> (from <code>Content_Themes</code>) - Colors and fonts
. <strong>Print CSS</strong> (<code>@media print</code> rules) - Print-specific optimizations</p>
</div>
<div class="paragraph">
<p><strong>Print CSS Overrides:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Print CSS can override structural CSS for print-specific layout</p>
</li>
<li>
<p>Print CSS can override theme colors for print optimization (e.g., force black text)</p>
</li>
<li>
<p>Print CSS takes precedence within <code>@media print</code> blocks</p>
</li>
<li>
<p>User print settings (from print dialog) can further override CSS</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_multi_page_document_printing">11.7. Multi-Page Document Printing</h3>
<div class="paragraph">
<p><strong>Page Handling:</strong>
* For document printing, iterate through all pages in <code>page_order</code>
* Load each page&#8217;s content sequentially
* Apply consistent CSS across all pages
* Handle page breaks between pages
* Maintain consistent margins and formatting
* Optionally add page numbers (if implemented in future)</p>
</div>
<div class="paragraph">
<p><strong>Page Break Handling:</strong>
* Avoid breaking content awkwardly (headings, paragraphs, lists)
* Use CSS <code>page-break-after</code>, <code>page-break-before</code>, <code>page-break-inside</code> properties
* Ensure content flows naturally across pages
* Handle edge cases (very long content, tables, etc.)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_text_selection_and_copy_implementation_specification">12. Text Selection and Copy Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how text selection, copying, and pasting are implemented in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_text_selection">12.1. Text Selection</h3>
<div class="paragraph">
<p><strong>Selection Methods:</strong>
* <strong>Mouse Selection:</strong> Click and drag to select text
* <strong>Keyboard Selection:</strong> Shift+Arrow keys to extend selection
* <strong>Word Selection:</strong> Double-click to select word
* <strong>Paragraph Selection:</strong> Triple-click to select paragraph
* <strong>Select All:</strong> Ctrl+A / Cmd+A to select all text on current page (or all text in focused form field)</p>
</div>
<div class="paragraph">
<p><strong>Select All Behavior:</strong>
* <strong>On Content Pages:</strong> Selects all text content on the current page
* <strong>In Form Fields:</strong> When a form field (input, textarea) is focused, selects all text within that field only
* <strong>Context Menu:</strong> "Select All" option available in context menu when appropriate
* <strong>Keyboard Shortcut:</strong> Ctrl+A (Windows/Linux) or Cmd+A (macOS)</p>
</div>
<div class="paragraph">
<p><strong>Selection Behavior:</strong>
* Selection works with all rendered HTML content
* Selection respects text flow and layout
* Selection can span multiple elements (headings, paragraphs, lists)
* Selection highlights with standard platform selection color
* Selection is cleared when clicking outside selected area or navigating to new page</p>
</div>
<div class="paragraph">
<p><strong>Selection Implementation:</strong>
* Use Qt WebEngine&#8217;s native text selection capabilities
* Enable text selection in <code>QWebEngineView</code> settings
* Handle selection events via JavaScript or Qt signals
* Display selection highlight using platform-standard selection styling</p>
</div>
</div>
<div class="sect2">
<h3 id="_copy_to_clipboard">12.2. Copy to Clipboard</h3>
<div class="paragraph">
<p><strong>Copy Functionality:</strong>
* <strong>Keyboard Shortcut:</strong> Ctrl+C / Cmd+C copies selected text to clipboard
* <strong>Context Menu:</strong> Right-click on selected text shows "Copy" option
* <strong>Menu Bar:</strong> Edit menu provides "Copy" option when text is selected</p>
</div>
<div class="paragraph">
<p><strong>Copy Implementation:</strong>
. User selects text and triggers copy (keyboard shortcut, context menu, or menu bar)
. Reader captures selected text from WebEngine
. <strong>Background Removal:</strong> Strip background colors and styling from copied text
. Convert to plain text format
. Copy plain text to system clipboard</p>
</div>
<div class="paragraph">
<p><strong>Background Removal Algorithm:</strong>
. Get selected HTML content from WebEngine
. Parse HTML to extract text nodes
. For each text node:
   a. Extract text content
   b. Remove inline styles (background-color, background, color if it matches background)
   c. Remove CSS classes that apply backgrounds
   d. Preserve text content only
. Combine text nodes with appropriate whitespace
. Copy plain text to clipboard</p>
</div>
<div class="paragraph">
<p><strong>Alternative Approach (Simpler):</strong>
* Use WebEngine&#8217;s built-in copy functionality
* Intercept clipboard data before it&#8217;s set
* Strip HTML formatting, keeping only plain text
* Set plain text to clipboard instead of HTML</p>
</div>
</div>
<div class="sect2">
<h3 id="_paste_functionality">12.3. Paste Functionality</h3>
<div class="paragraph">
<p><strong>Paste into Forms:</strong>
. User focuses on a form field (input, textarea, etc.)
. User triggers paste (Ctrl+V / Cmd+V or context menu)
. Reader retrieves plain text from system clipboard
. Insert text into focused form field
. Form field validation applies (if any)</p>
</div>
<div class="paragraph">
<p><strong>Paste Implementation:</strong>
* Use WebEngine&#8217;s native paste handling for form fields
* Ensure clipboard content is accessible to form fields
* Handle paste events in form input elements
* Apply form validation after paste</p>
</div>
<div class="paragraph">
<p><strong>Paste into External Documents:</strong>
* Text copied from Reader is plain text in clipboard
* External applications receive plain text when pasting
* No background formatting or styling is transferred
* Text can be pasted into any application that accepts plain text</p>
</div>
</div>
<div class="sect2">
<h3 id="_context_menu">12.4. Context Menu</h3>
<div class="paragraph">
<p><strong>Context Menu Implementation:</strong>
* Display context menu on right-click
* Menu options:
  * <strong>Copy:</strong> Copy selected text to clipboard (shown when text is selected)
  * <strong>Select All:</strong> Select all text on current page or in focused form field (shown when appropriate)
  * <strong>Cut:</strong> Cut selected text from form field (shown when text is selected in form field)
  * <strong>Paste:</strong> Paste text from clipboard (shown when clipboard contains text and cursor is in form field)
* Menu follows platform conventions (native OS context menu styling)
* Menu appears near cursor position
* Menu is dismissed when clicking outside or selecting option</p>
</div>
<div class="paragraph">
<p><strong>Context Menu Behavior:</strong>
* Show "Copy" option when text is selected
* Show "Cut" option when text is selected in a form field (not in content pages)
* Show "Paste" option when clipboard contains text and cursor is in a form field
* Show "Select All" option when appropriate (no text selected, or in form field)
* Hide context menu when clicking outside
* Handle keyboard navigation (arrow keys, Enter to select)</p>
</div>
</div>
<div class="sect2">
<h3 id="_clipboard_integration">12.5. Clipboard Integration</h3>
<div class="paragraph">
<p><strong>System Clipboard:</strong>
* Use Qt <code>QClipboard</code> for clipboard operations
* Access system clipboard via <code>QApplication::clipboard()</code>
* Set text using <code>clipboard&#8594;setText(plainText, QClipboard::Clipboard)</code>
* Get text using <code>clipboard&#8594;text(QClipboard::Clipboard)</code></p>
</div>
<div class="paragraph">
<p><strong>Clipboard Formats:</strong>
* <strong>Primary Format:</strong> Plain text (UTF-8)
* <strong>No HTML Format:</strong> Do not copy HTML to clipboard
* <strong>No Rich Text Format:</strong> Do not copy RTF or other formatted text
* <strong>Plain Text Only:</strong> Ensure only plain text is available for pasting</p>
</div>
<div class="paragraph">
<p><strong>Cross-Platform Considerations:</strong>
* Windows: Use <code>QClipboard::Clipboard</code> (standard clipboard)
* macOS: Use <code>QClipboard::Clipboard</code> (standard clipboard)
* Linux: Use <code>QClipboard::Clipboard</code> (standard clipboard) or <code>QClipboard::Selection</code> (primary selection) based on platform conventions</p>
</div>
</div>
<div class="sect2">
<h3 id="_form_field_paste_handling">12.6. Form Field Paste Handling</h3>
<div class="paragraph">
<p><strong>Form Field Focus:</strong>
* Detect when form field receives focus
* Enable paste functionality for focused form field
* Handle paste events in form input elements</p>
</div>
<div class="paragraph">
<p><strong>Paste into Form Fields:</strong>
. User focuses on form field (click or Tab navigation)
. User triggers paste (Ctrl+V / Cmd+V)
. WebEngine handles paste event in form field
. Plain text from clipboard is inserted into form field
. Form field&#8217;s input event is triggered
. Form validation applies (if any)</p>
</div>
<div class="paragraph">
<p><strong>Paste Validation:</strong>
* Form field validation rules apply to pasted content
* Invalid content may be rejected or sanitized
* User receives feedback if paste is rejected
* Valid content is inserted normally</p>
</div>
</div>
<div class="sect2">
<h3 id="_selection_persistence">12.7. Selection Persistence</h3>
<div class="paragraph">
<p><strong>Selection Behavior:</strong>
* Selection is cleared when:
  * User clicks outside selected area
  * User navigates to new page
  * User scrolls significantly
  * User performs other actions (search, etc.)
* Selection is NOT persisted across page navigation
* Selection is NOT saved in reading position</p>
</div>
<div class="paragraph">
<p><strong>Selection State:</strong>
* Track selection state per Reader View Window
* Clear selection on page navigation
* Clear selection on window focus loss (optional, platform-dependent)</p>
</div>
</div>
<div class="sect2">
<h3 id="_standard_keyboard_shortcuts">12.8. Standard Keyboard Shortcuts</h3>
<div class="paragraph">
<p><strong>Text Selection and Copy Shortcuts:</strong>
* <strong>Select All:</strong> Ctrl+A (Windows/Linux) or Cmd+A (macOS)
  * Selects all text on current page when no form field is focused
  * Selects all text in focused form field when form field has focus
* <strong>Copy:</strong> Ctrl+C (Windows/Linux) or Cmd+C (macOS)
  * Copies selected text to clipboard
  * Works with content page text and form field text
* <strong>Paste:</strong> Ctrl+V (Windows/Linux) or Cmd+V (macOS)
  * Pastes text from clipboard into focused form field
  * Works when form field has focus
* <strong>Cut:</strong> Ctrl+X (Windows/Linux) or Cmd+X (macOS)
  * Cuts selected text from form field (removes text and copies to clipboard)
  * Only works in form fields, not in content pages (content is read-only)</p>
</div>
<div class="paragraph">
<p><strong>Shortcut Implementation:</strong>
* Use Qt&#8217;s keyboard shortcut handling (<code>QShortcut</code> or menu actions)
* Ensure shortcuts work consistently across all Reader View Windows
* Handle focus properly (shortcuts apply to focused element)
* Follow platform conventions (Ctrl on Windows/Linux, Cmd on macOS)
* Shortcuts should not conflict with WebEngine&#8217;s native shortcuts</p>
</div>
<div class="paragraph">
<p><strong>Shortcut Priority:</strong>
. Form field shortcuts take precedence when form field is focused
. Content page shortcuts apply when no form field is focused
. Application-level shortcuts (menu items) always available</p>
</div>
<div class="paragraph">
<p><strong>WCAG Compliance:</strong>
* Keyboard shortcuts are essential for WCAG 2.1 Level AA compliance
* All essential functions must be accessible via keyboard without requiring a mouse
* Standard keyboard shortcuts ensure users can perform all operations using only the keyboard
* Keyboard shortcuts follow platform conventions for consistency and familiarity</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cartridge_signature_verification_process_algorithm">13. Cartridge Signature Verification Process Algorithm</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_4_phase_verification_algorithm_sequence_diagram">13.1. 4-Phase Verification Algorithm Sequence Diagram</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <code>diagrams.adoc</code> (4-Phase Verification Algorithm sequence diagram) for a complete visual representation of the security verification process showing all four phases: Identity, Integrity Check, Trust Lookup, and Policy Determination.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_phase_1_integrity_check_and_identity_establishment">13.2. Phase 1: Integrity Check and Identity Establishment</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Step</th>
<th class="tableblock halign-center valign-middle">Action by Reader C++ Core</th>
<th class="tableblock halign-center valign-middle">Output/Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1. Extract IDs &amp; Security Data</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read <code>cartridge_guid</code> from <code>Metadata</code>. Read security parameters (H1, Signature, Certificate, Fingerprint) from <code>Cartridge_Security</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code>, H1, Signature, Certificate, Fingerprint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>2. Recalculate Content Hash</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read the binary content of critical tables. Calculate H2 using the Content Hash Algorithm (see "Content Hash Algorithm Specification" section below).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H2 (Recalculated Content Hash)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3. Extract Certificate and Public Key</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extract certificate from <code>certificate_data</code>. Extract public key from certificate using <code>QSslCertificate::publicKey()</code>. If certificate is missing or invalid, set Public Key Status to <code>MISSING</code> or <code>INVALID</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate Object, Public Key Object, Public Key Status</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4. Verify Public Key Fingerprint</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calculate fingerprint of extracted public key (using same algorithm as stored fingerprint, typically SHA-256). Compare calculated fingerprint with stored <code>public_key_fingerprint</code>. If mismatch, set Fingerprint Status to <code>MISMATCH</code> (indicates potential tampering).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fingerprint Status: <code>MATCH</code> or <code>MISMATCH</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>5. Verify Digital Signature</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use extracted Public Key to verify <code>digital_signature</code> matches the stored H1. If fingerprint mismatch detected in Step 4, reject signature verification.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Status: <code>VALID</code>, <code>INVALID</code>, or <code>UNVERIFIED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>6. Extract and Validate Certificate</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validate certificate using system CA store and check expiration. See "Certificate Validation" section below.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate Status: <code>CA_VALID</code>, <code>CA_EXPIRED</code>, <code>SELF_SIGNED</code>, <code>INVALID</code>, or <code>NONE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>7. Check Tampering (Content vs. Signature)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare H1 vs. H2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integrity Status: <code>MATCH</code> or <code>MISMATCH</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_phase_2_trust_level_assignment">13.3. Phase 2: Trust Level Assignment</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Condition</th>
<th class="tableblock halign-center valign-middle">Initial Trust Level</th>
<th class="tableblock halign-center valign-middle">Required Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Invalid OR Hash Mismatch OR Fingerprint Mismatch OR Public Key Missing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Rejected</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halt loading. Block all execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Valid AND Certificate Status = <code>CA_VALID</code> (valid, non-expired CA-signed) AND Fingerprint Match.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Level 1: Commercial Trust</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whitelist apps by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Valid AND Certificate Status = <code>CA_EXPIRED</code> (expired CA-signed certificate) AND Fingerprint Match.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Level 2: Self-Signed Trust</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Downgrade to Level 2. Display integrity warning. Apps require consent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Valid AND Certificate Status = <code>SELF_SIGNED</code> (self-signed certificate) AND Fingerprint Match.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Level 2: Self-Signed Trust</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apps require consent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Valid AND Certificate Status = <code>INVALID</code> (certificate validation failed).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Rejected</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halt loading. Block all execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Signature OR Certificate Status = <code>NONE</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Level 3: No Signature</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apps require consent.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_phase_3_local_trust_registry_and_policy_enforcement">13.4. Phase 3: Local Trust Registry and Policy Enforcement</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Check Local Persistent Trust:</strong> Query the <code>Local_Trust_Registry</code> using the <code>cartridge_guid</code>.</p>
</li>
<li>
<p><strong>Tampering Check on Trusted Files:</strong> If persistent trust exists, compare <strong>H2</strong> against the hash in the <strong><code>Local_Library_Manifest</code></strong>. A mismatch sets policy to <strong>Rejected (Tampered)</strong>.</p>
</li>
<li>
<p><strong>Final Policy:</strong> Policy is <code>WHITELISTED</code> if Level 1 OR Persistent Trust exists and is valid. Otherwise, the policy requires explicit consent.</p>
</li>
<li>
<p><strong>Update Manifest:</strong> Update the <code>Local_Library_Manifest</code> using the current <code>cartridge_guid</code> and H2. If manifest update fails, log error and display user-friendly error dialog (see "Manifest Update Error Handling" section).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_phase_4_embedded_application_execution_policy">13.5. Phase 4: Embedded Application Execution Policy</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Policy Status</th>
<th class="tableblock halign-center valign-middle">Native Application Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>WHITELISTED</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return <code>TRUE</code>. Execute app.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Level 2 / Level 3</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display the Consent Dialog.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Rejected (Tampered/Invalid)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return <code>FALSE</code>. Block app execution.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_certificate_validation_implementation">13.6. Certificate Validation Implementation</h3>
<div class="paragraph">
<p>This section details how certificates are validated in the Reader application.</p>
</div>
<div class="sect3">
<h4 id="_certificate_extraction">13.6.1. Certificate Extraction</h4>
<div class="paragraph">
<p><strong>Process:</strong>
. Read <code>certificate_data</code> BLOB from <code>Cartridge_Security</code> table
. Parse certificate data (supports DER and PEM formats)
. Create <code>QSslCertificate</code> object from certificate data
. If certificate data is missing or invalid, set Certificate Status to <code>NONE</code> or <code>INVALID</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_system_certificate_store_integration">13.6.2. System Certificate Store Integration</h4>
<div class="paragraph">
<p><strong>Platform-Specific Certificate Stores:</strong>
* <strong>Windows:</strong> Windows Certificate Store (automatically accessed via Qt&#8217;s SSL implementation)
* <strong>macOS:</strong> Keychain System Roots (automatically accessed via Qt&#8217;s SSL implementation)
* <strong>Linux:</strong> System CA bundle (typically <code>/etc/ssl/certs/ca-certificates.crt</code> or <code>/etc/pki/tls/certs/ca-bundle.crt</code>)</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Qt&#8217;s <code>QSslCertificate</code> class automatically validates certificates against the system&#8217;s trusted root CA store
* No manual CA list maintenance required
* System certificate store updates are automatically used by Qt</p>
</div>
</div>
<div class="sect3">
<h4 id="_certificate_validation_algorithm">13.6.3. Certificate Validation Algorithm</h4>
<div class="paragraph">
<p><strong>Step 1: Determine Certificate Type</strong>
. Extract certificate from <code>certificate_data</code>
. Use <code>QSslCertificate::verify()</code> to check if certificate is signed by a trusted CA:
  * If <code>verify()</code> returns <code>QSslCertificate::Valid</code> → Certificate is CA-signed
  * If <code>verify()</code> returns <code>QSslCertificate::SelfSigned</code> → Certificate is self-signed
  * If <code>verify()</code> returns <code>QSslCertificate::Invalid</code> → Certificate validation failed</p>
</div>
<div class="paragraph">
<p><strong>Step 2: Check Certificate Expiration</strong>
. Get certificate validity dates:
   * <code>QSslCertificate::effectiveDate()</code> - Certificate becomes valid
   * <code>QSslCertificate::expiryDate()</code> - Certificate expires
. Get current system date/time
. Compare dates and determine status:
  * If current date &lt; <code>effectiveDate</code> → Certificate not yet valid → Certificate Status = <code>INVALID</code>
  * If current date &gt; <code>expiryDate</code> → Certificate expired → Certificate Status = <code>CA_EXPIRED</code> (if CA-signed) or <code>INVALID</code> (if self-signed)
  * If current date is within validity period → Certificate is valid</p>
</div>
<div class="paragraph">
<p><strong>Step 3: Determine Final Certificate Status</strong>
* <strong>CA-signed AND valid AND not expired:</strong> Certificate Status = <code>CA_VALID</code>
* <strong>CA-signed AND valid BUT expired:</strong> Certificate Status = <code>CA_EXPIRED</code> (downgrade to Level 2)
* <strong>Self-signed AND valid:</strong> Certificate Status = <code>SELF_SIGNED</code>
* <strong>Certificate validation failed:</strong> Certificate Status = <code>INVALID</code>
* <strong>No certificate data:</strong> Certificate Status = <code>NONE</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_expired_ca_certificate_handling">13.6.4. Expired CA Certificate Handling</h4>
<div class="paragraph">
<p><strong>Decision:</strong> Expired CA-signed certificates are downgraded to Level 2 (Self-Signed Trust) rather than being rejected.</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* Expired certificates may still be valid for content that was signed when the certificate was valid
* Downgrading to Level 2 allows users to make informed trust decisions
* Users can still trust the cartridge via the Local Trust Registry if desired</p>
</div>
<div class="paragraph">
<p><strong>User Experience:</strong>
* Expired CA certificates trigger the same integrity warning as self-signed certificates
* Embedded applications require explicit user consent (same as Level 2)
* Users can grant persistent trust via the consent dialog</p>
</div>
</div>
<div class="sect3">
<h4 id="_certificate_revocation_deferred_for_phase_1">13.6.5. Certificate Revocation (Deferred for Phase 1)</h4>
<div class="paragraph">
<p><strong>Decision:</strong> Certificate revocation checking (OCSP/CRL) is deferred for Phase 1.</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* Revocation checking requires network access, which conflicts with offline-first design
* Adds complexity and latency to certificate validation
* Most use cases for Phase 1 do not require revocation checking
* Can be added in future phases if needed</p>
</div>
<div class="paragraph">
<p><strong>Future Consideration:</strong>
* OCSP (Online Certificate Status Protocol) checking
* CRL (Certificate Revocation List) checking
* Cached revocation status for offline operation</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_content_hash_algorithm_specification">14. Content Hash Algorithm Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines the exact algorithm used to calculate content hashes (H1 and H2) for cartridge integrity verification and tampering detection.</p>
</div>
<div class="sect2">
<h3 id="_hash_algorithm">14.1. Hash Algorithm</h3>
<div class="paragraph">
<p><strong>Algorithm:</strong> SHA-256 (Secure Hash Algorithm 256-bit)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* <strong>Security:</strong> 256-bit output provides strong collision resistance
* <strong>Performance:</strong> Efficient computation suitable for large content
* <strong>Standard:</strong> Widely supported in Qt, OpenSSL, and cryptographic libraries
* <strong>Future-proof:</strong> No known vulnerabilities; recommended by NIST</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Use Qt&#8217;s <code>QCryptographicHash</code> class with <code>QCryptographicHash::Sha256</code> algorithm
* Or use OpenSSL&#8217;s SHA-256 implementation
* Hash output is 32 bytes (256 bits)</p>
</div>
</div>
<div class="sect2">
<h3 id="_tables_included_in_hash">14.2. Tables Included in Hash</h3>
<div class="paragraph">
<p>The content hash includes the following tables, which represent author-controlled content and potential attack surfaces:</p>
</div>
<div class="paragraph">
<p><strong>Included Tables:</strong>
. <strong><code>Content_Pages</code></strong> - Primary content (HTML pages, chapter structure)
. <strong><code>Embedded_Apps</code></strong> - Embedded JavaScript applications (critical attack surface)
. <strong><code>Form_Definitions</code></strong> - Form schemas and validation rules
. <strong><code>Settings</code></strong> - Author-defined rendering defaults
. <strong><code>Content_Themes</code></strong> - Theme configurations (colors, fonts, styling)
. <strong><code>Metadata</code></strong> (partial) - Author metadata fields (see below for specific fields)</p>
</div>
<div class="paragraph">
<p><strong>Excluded Tables:</strong>
* <strong><code>User_Data</code></strong> - User input data (not part of author content, changes per user)
* <strong><code>Cartridge_Security</code></strong> - Security metadata (circular dependency - contains the hash itself)</p>
</div>
<div class="paragraph">
<p><strong>Metadata Fields Included:</strong>
From the <code>Metadata</code> table, include the following fields in the hash:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code></p>
</li>
<li>
<p><code>author</code></p>
</li>
<li>
<p><code>version</code></p>
</li>
<li>
<p><code>publication_year</code></p>
</li>
<li>
<p><code>tags_json</code></p>
</li>
<li>
<p><code>cover_image_path</code></p>
</li>
<li>
<p><code>schema_version</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Metadata Fields Excluded:</strong>
* <code>cartridge_guid</code> - Used separately for identification, not part of content integrity</p>
</div>
</div>
<div class="sect2">
<h3 id="_hash_calculation_algorithm_option_a_concatenate_table_hashes">14.3. Hash Calculation Algorithm (Option A: Concatenate Table Hashes)</h3>
<div class="paragraph">
<p><strong>Approach:</strong> Hash each table independently, then concatenate table hashes and hash the result.</p>
</div>
<div class="paragraph">
<p><strong>Step 1: Hash Each Table Independently</strong></p>
</div>
<div class="paragraph">
<p>For each table in the specified order (see "Table Ordering" below):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Query all rows</strong> from the table, ordered by primary key</p>
</li>
<li>
<p><strong>Serialize each row</strong> to a deterministic byte representation (see "Row Serialization" below)</p>
</li>
<li>
<p><strong>Concatenate all serialized rows</strong> in primary key order</p>
</li>
<li>
<p><strong>Calculate SHA-256 hash</strong> of the concatenated row data</p>
</li>
<li>
<p><strong>Store table hash</strong> (32 bytes) for later concatenation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Step 2: Concatenate Table Hashes</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Concatenate all table hashes</strong> in the specified table order</p>
</li>
<li>
<p><strong>Include table name</strong> as a 4-byte prefix for each table hash (to prevent hash collisions between tables)</p>
<div class="ulist">
<ul>
<li>
<p>Table name prefix: First 4 bytes of SHA-256 hash of table name (ensures deterministic, fixed-size prefix)</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Result:</strong> Single byte array containing: <code>[table1_prefix][table1_hash][table2_prefix][table2_hash]&#8230;&#8203;</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Step 3: Calculate Final Hash</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Calculate SHA-256 hash</strong> of the concatenated table hashes byte array</p>
</li>
<li>
<p><strong>Result:</strong> H1 (or H2) - 32-byte content hash</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_table_ordering">14.4. Table Ordering</h3>
<div class="paragraph">
<p>Tables are processed in the following fixed order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Content_Pages</code></p>
</li>
<li>
<p><code>Content_Themes</code></p>
</li>
<li>
<p><code>Embedded_Apps</code></p>
</li>
<li>
<p><code>Form_Definitions</code></p>
</li>
<li>
<p><code>Metadata</code> (partial fields only)</p>
</li>
<li>
<p><code>Settings</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Fixed order ensures deterministic hash calculation regardless of database insertion order.</p>
</div>
</div>
<div class="sect2">
<h3 id="_row_ordering">14.5. Row Ordering</h3>
<div class="paragraph">
<p>Within each table, rows are ordered by primary key in ascending order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>Content_Pages</code>:</strong> Ordered by <code>page_order</code> (ascending)</p>
</li>
<li>
<p><strong><code>Content_Themes</code>:</strong> Ordered by <code>theme_id</code> (alphabetical)</p>
</li>
<li>
<p><strong><code>Embedded_Apps</code>:</strong> Ordered by <code>app_id</code> (alphabetical)</p>
</li>
<li>
<p><strong><code>Form_Definitions</code>:</strong> Ordered by <code>form_id</code> (alphabetical)</p>
</li>
<li>
<p><strong><code>Metadata</code>:</strong> Single row (no ordering needed)</p>
</li>
<li>
<p><strong><code>Settings</code>:</strong> Ordered by <code>setting_key</code> (alphabetical)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_row_serialization">14.6. Row Serialization</h3>
<div class="paragraph">
<p>Each row is serialized to a deterministic byte representation using the following rules:</p>
</div>
<div class="paragraph">
<p><strong>Column Ordering:</strong>
* Columns are serialized in alphabetical order by column name
* This ensures deterministic output regardless of table schema definition order</p>
</div>
<div class="paragraph">
<p><strong>Value Serialization:</strong>
* <strong>TEXT fields:</strong> UTF-8 encoded bytes
* <strong>INTEGER fields:</strong> 8-byte big-endian representation
* <strong>BLOB fields:</strong> Raw bytes (no encoding)
* <strong>NULL values:</strong> Single byte <code>0x00</code> (null marker)</p>
</div>
<div class="paragraph">
<p><strong>Row Delimiter:</strong>
* Each row is terminated with a single newline byte (<code>0x0A</code>)
* This prevents concatenation issues when rows are combined</p>
</div>
<div class="paragraph">
<p><strong>Example Serialization:</strong>
For a row in <code>Content_Pages</code> with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>page_id</code> = 1 (INTEGER)</p>
</li>
<li>
<p><code>page_order</code> = 1 (INTEGER)</p>
</li>
<li>
<p><code>chapter_title</code> = "Introduction" (TEXT)</p>
</li>
<li>
<p><code>html_content</code> = "&lt;p&gt;Hello&lt;/p&gt;" (TEXT)</p>
</li>
<li>
<p><code>associated_css</code> = NULL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Serialized as (hex representation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[page_id: 8 bytes big-endian 1][page_order: 8 bytes big-endian 1][associated_css: 0x00][chapter_title: UTF-8 "Introduction"][html_content: UTF-8 "&lt;p&gt;Hello&lt;/p&gt;"][0x0A]</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Column Name Order:</strong> <code>associated_css</code>, <code>chapter_title</code>, <code>html_content</code>, <code>page_id</code>, <code>page_order</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_empty_table_handling">14.7. Empty Table Handling</h3>
<div class="paragraph">
<p><strong>Empty Tables:</strong>
* If a table has no rows, still include it in the hash calculation
* Hash of empty table = SHA-256 of empty byte array (32 bytes of zeros)
* Table name prefix is still included</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Ensures hash changes if a table is added/removed, even if initially empty.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hash_calculation_pseudocode">14.8. Hash Calculation Pseudocode</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">function calculateContentHash(database):
    tableHashes = []

    // Define table order
    tables = ["Content_Pages", "Content_Themes", "Embedded_Apps",
              "Form_Definitions", "Metadata", "Settings"]

    for each table in tables:
        // Get table name prefix (first 4 bytes of SHA-256 of table name)
        tableNameHash = SHA256(table)
        tablePrefix = tableNameHash[0:4]

        // Query all rows ordered by primary key
        rows = database.query("SELECT * FROM " + table + " ORDER BY primary_key")

        // Serialize all rows
        rowData = []
        for each row in rows:
            serializedRow = serializeRow(row, table)  // Alphabetical column order
            rowData.append(serializedRow)
            rowData.append(0x0A)  // Row delimiter

        // Hash concatenated row data
        tableHash = SHA256(concatenate(rowData))

        // Store prefix + hash
        tableHashes.append(tablePrefix)
        tableHashes.append(tableHash)

    // Concatenate all table hashes
    concatenatedHashes = concatenate(tableHashes)

    // Calculate final hash
    H1 = SHA256(concatenatedHashes)

    return H1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verification_process">14.9. Verification Process</h3>
<div class="paragraph">
<p><strong>H1 (Stored Hash):</strong>
* Calculated by Creator Tool during cartridge finalization
* Stored in <code>Cartridge_Security.hash_digest</code> column
* Represents the content state at signing time</p>
</div>
<div class="paragraph">
<p><strong>H2 (Recalculated Hash):</strong>
* Calculated by Reader during cartridge loading
* Uses the same algorithm as H1
* Represents the current content state</p>
</div>
<div class="paragraph">
<p><strong>Tampering Detection:</strong>
* Compare H1 (stored) vs H2 (recalculated)
* If H1 == H2: Content is intact (no tampering)
* If H1 != H2: Content has been modified (tampering detected)</p>
</div>
</div>
<div class="sect2">
<h3 id="_security_considerations">14.10. Security Considerations</h3>
<div class="paragraph">
<p><strong>Attack Surface Coverage:</strong>
* <strong>Content Pages:</strong> Prevents modification of HTML content
* <strong>Embedded Apps:</strong> Critical - prevents injection of malicious JavaScript code
* <strong>Form Definitions:</strong> Prevents modification of form validation rules
* <strong>Settings &amp; Themes:</strong> Prevents modification of rendering behavior</p>
</div>
<div class="paragraph">
<p><strong>Hash Collision Resistance:</strong>
* SHA-256 provides 2^256 possible hash values
* Extremely low probability of collision (cryptographically secure)
* Table name prefixes prevent cross-table hash collisions</p>
</div>
<div class="paragraph">
<p><strong>Deterministic Calculation:</strong>
* Fixed table order ensures consistent hashing
* Fixed row order (by primary key) ensures consistent hashing
* Fixed column order (alphabetical) ensures consistent hashing
* UTF-8 encoding ensures consistent text representation</p>
</div>
</div>
<div class="sect2">
<h3 id="_public_key_extraction_and_fingerprint_verification">14.11. Public Key Extraction and Fingerprint Verification</h3>
<div class="paragraph">
<p>This section details how public keys are obtained and verified during signature verification.</p>
</div>
<div class="sect3">
<h4 id="_public_key_source">14.11.1. Public Key Source</h4>
<div class="paragraph">
<p><strong>Primary Method: Extract from Certificate</strong>
* Public keys are <strong>NOT</strong> distributed separately
* Public keys are <strong>extracted from the X.509 certificate</strong> stored in <code>certificate_data</code>
* The certificate is embedded in the cartridge itself, making each cartridge self-contained
* No external public key distribution mechanism is required</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Use Qt&#8217;s <code>QSslCertificate::publicKey()</code> method to extract the public key from the certificate
* The public key is extracted on-demand during signature verification
* No persistent storage of public keys in the Reader is required</p>
</div>
</div>
<div class="sect3">
<h4 id="_public_key_extraction_process">14.11.2. Public Key Extraction Process</h4>
<div class="paragraph">
<p><strong>Step 1: Certificate Parsing</strong>
. Read <code>certificate_data</code> BLOB from <code>Cartridge_Security</code> table
. Parse certificate data (supports DER and PEM formats)
. Create <code>QSslCertificate</code> object from certificate data</p>
</div>
<div class="paragraph">
<p><strong>Step 2: Public Key Extraction</strong>
. Call <code>QSslCertificate::publicKey()</code> to extract the public key
. The public key is returned as a <code>QSslKey</code> object
. If certificate is missing or invalid, public key extraction fails → Public Key Status = <code>MISSING</code> or <code>INVALID</code></p>
</div>
<div class="paragraph">
<p><strong>Step 3: Public Key Usage</strong>
* Use extracted public key to verify the <code>digital_signature</code>
* The public key is used to decrypt/verify that the signature matches the stored H1 hash
* Public key is not stored persistently; it is extracted fresh for each verification</p>
</div>
</div>
<div class="sect3">
<h4 id="_fingerprint_verification">14.11.3. Fingerprint Verification</h4>
<div class="paragraph">
<p><strong>Purpose:</strong>
* The <code>public_key_fingerprint</code> stored in <code>Cartridge_Security</code> serves as an integrity check
* Verifying the fingerprint ensures the certificate (and thus the public key) has not been tampered with
* Fingerprint mismatch indicates potential tampering or corruption</p>
</div>
<div class="paragraph">
<p><strong>Fingerprint Calculation:</strong>
. Extract public key from certificate (as described above)
. Calculate fingerprint of the public key using the same algorithm used when creating the cartridge (typically SHA-256)
. Convert fingerprint to the same format as stored <code>public_key_fingerprint</code> (typically hexadecimal string)</p>
</div>
<div class="paragraph">
<p><strong>Fingerprint Verification Process:</strong>
. Calculate fingerprint of extracted public key
. Compare calculated fingerprint with stored <code>public_key_fingerprint</code> from <code>Cartridge_Security</code> table
. If fingerprints match → Fingerprint Status = <code>MATCH</code>
. If fingerprints do not match → Fingerprint Status = <code>MISMATCH</code> (indicates potential tampering)</p>
</div>
<div class="paragraph">
<p><strong>Fingerprint Mismatch Handling:</strong>
* Fingerprint mismatch is treated as a security violation
* Cartridge is rejected (same as signature invalid or hash mismatch)
* User is not prompted; cartridge loading is blocked immediately
* This prevents attacks where an attacker might replace the certificate with a different one</p>
</div>
</div>
<div class="sect3">
<h4 id="_public_key_storage">14.11.4. Public Key Storage</h4>
<div class="paragraph">
<p><strong>Reader Storage:</strong>
* <strong>No persistent storage required</strong> - public keys are extracted on-demand from certificates
* Public keys are not cached in the Reader&#8217;s local database
* Each verification extracts the public key fresh from the certificate</p>
</div>
<div class="paragraph">
<p><strong>Cartridge Storage:</strong>
* Public key is embedded in the certificate stored in <code>certificate_data</code> column
* <code>public_key_fingerprint</code> is stored as a TEXT field for quick integrity checking
* Both are stored in the <code>Cartridge_Security</code> table</p>
</div>
</div>
<div class="sect3">
<h4 id="_key_rotation_and_updates">14.11.5. Key Rotation and Updates</h4>
<div class="paragraph">
<p><strong>Cartridge Independence:</strong>
* Each cartridge is <strong>self-contained</strong> with its own certificate and public key
* Cartridges are <strong>immutable</strong> once signed - they cannot be updated with new keys
* Old cartridges remain valid with their original certificates indefinitely</p>
</div>
<div class="paragraph">
<p><strong>Key Rotation Strategy:</strong>
* <strong>No cross-cartridge key management</strong> is required
* If an author obtains a new certificate/key pair:
  * New cartridges can be signed with the new certificate
  * Old cartridges continue to work with their original certificates
  * No need to update or re-sign existing cartridges</p>
</div>
<div class="paragraph">
<p><strong>Certificate Expiration:</strong>
* Expired certificates are handled as described in "Expired CA Certificate Handling" section
* Expired certificates do not invalidate the cartridge; they are downgraded to Level 2
* The public key remains valid for signature verification even if the certificate is expired</p>
</div>
<div class="paragraph">
<p><strong>Key Compromise:</strong>
* If an author&#8217;s private key is compromised:
  * Existing cartridges signed with that key remain valid (they were signed before compromise)
  * New cartridges should be signed with a new key pair
  * Authors should obtain a new certificate and use it for future cartridges
  * No mechanism exists to revoke signatures on existing cartridges (by design, for offline operation)</p>
</div>
</div>
<div class="sect3">
<h4 id="_security_considerations_2">14.11.6. Security Considerations</h4>
<div class="paragraph">
<p><strong>Advantages of Certificate-Embedded Public Keys:</strong>
* <strong>Self-contained:</strong> Each cartridge includes everything needed for verification
* <strong>No external dependencies:</strong> No need for public key servers or distribution mechanisms
* <strong>Tamper-resistant:</strong> Fingerprint verification detects certificate replacement
* <strong>Standard practice:</strong> Follows PKI best practices</p>
</div>
<div class="paragraph">
<p><strong>Limitations:</strong>
* <strong>No key revocation:</strong> Once a cartridge is signed, the signature cannot be revoked
* <strong>Key compromise handling:</strong> Compromised keys cannot invalidate existing cartridges
* <strong>Offline-first design:</strong> These limitations are intentional to support offline operation</p>
</div>
<div class="paragraph">
<p><strong>Fingerprint Verification Benefits:</strong>
* Detects certificate tampering even if signature verification would pass
* Provides additional layer of integrity checking
* Quick comparison (fingerprint is small, fast to compute and compare)
* Prevents certificate substitution attacks</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_embedded_application_specification">15. Embedded Application Specification</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_concept_and_purpose">15.1. Concept and Purpose</h3>
<div class="paragraph">
<p>Embedded applications are <strong>Single Page Applications (SPAs)</strong> or similar interactive components that provide functionality such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Character generators (e.g., RPG character creation)</p>
</li>
<li>
<p>Design tools (vehicle/weapon/armor design)</p>
</li>
<li>
<p>Calculators and computational tools</p>
</li>
<li>
<p>Artifact generators</p>
</li>
<li>
<p>Interactive data visualization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Security Model:</strong>
* <strong>Local Operation Only:</strong> Embedded apps operate entirely locally with <strong>no network access</strong>
* <strong>Sandboxed File System:</strong> Apps can only access a local sandbox directory for storing/retrieving files
* <strong>Isolated Execution:</strong> Each app runs in its own isolated context within the WebEngine
* <strong>User Consent Required:</strong> Apps require explicit user consent (except Level 1 trusted cartridges)</p>
</div>
</div>
<div class="sect2">
<h3 id="_json_structure_embedded_app_manifest">15.2. JSON Structure: <code>Embedded_App_Manifest</code></h3>
<div class="paragraph">
<p>The <code>Embedded_App_Manifest</code> is stored as JSON in the <code>manifest_json</code> column of the <code>Embedded_Apps</code> table. This structure defines the application&#8217;s metadata and resource requirements.</p>
</div>
<div class="paragraph">
<p><strong>Creation and Update:</strong>
* Embedded App Manifest is created/updated when the cartridge is created or updated by the Creator Tool
* Manifest is stored as part of the cartridge database during cartridge packaging
* Manifest is validated before being saved to the cartridge</p>
</div>
<div class="paragraph">
<p><strong>Error Handling:</strong>
* If manifest creation/update fails in Creator Tool, user is notified with error dialog
* Error dialog includes: operation type (create/update), app ID, error message, and suggested resolution
* Manifest validation errors are caught before saving to cartridge</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Key</th>
<th class="tableblock halign-center valign-middle">Type</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>appId</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for this application instance. <strong>MUST</strong> match the <code>app_id</code> in the <code>Embedded_Apps</code> table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable name displayed in the consent prompt and UI.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brief explanation of the app&#8217;s function and purpose.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application version (e.g., "1.0.0").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryFile</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The primary HTML entry point. For SPAs, this is typically <code>index.html</code> or similar. The HTML content is stored in the <code>entry_html</code> column.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requiredScripts</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of JavaScript file names or identifiers. Code stored in <code>js_code</code> BLOB or referenced from <code>additional_resources</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requiredStyles</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of CSS file names or identifiers. Styles stored in <code>css_code</code> BLOB or referenced from <code>additional_resources</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sandboxPermissions</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for future granular sandbox permission requests (e.g., <code>["read", "write"]</code>).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_embedded_application_execution_flow">15.3. Embedded Application Execution Flow</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Step</th>
<th class="tableblock halign-center valign-middle">Action</th>
<th class="tableblock halign-center valign-middle">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1. App Request</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content page calls <code>SmartbookBridge.requestAppConsent(appId)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaScript in content page requests to load an embedded app</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>2. Consent Check</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reader checks Effective Trust Policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If WHITELISTED, proceed. If CONSENT_REQUIRED, show native dialog.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3. App Loading</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reader queries <code>Embedded_Apps</code> table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieve app record by <code>app_id</code>, extract <code>manifest_json</code>, <code>entry_html</code>, <code>js_code</code>, <code>css_code</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4. Sandbox Creation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reader creates isolated sandbox directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create unique sandbox directory: <code>{cartridge_guid}/{app_id}/sandbox/</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>5. Resource Injection</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reader injects app resources into WebEngine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load <code>entry_html</code> as base, inject <code>js_code</code> and <code>css_code</code>, make sandbox API available</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>6. App Execution</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WebEngine executes app JavaScript</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App runs in isolated context with access only to sandbox file system via WebChannel API</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>7. Isolation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Each app instance isolated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple apps can run simultaneously, each with its own sandbox directory</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_sandbox_file_system_api">15.4. Sandbox File System API</h3>
<div class="paragraph">
<p>Embedded applications access the sandbox file system through the WebChannel Bridge API (see WebChannel API Specification for complete details):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>saveSandboxFile(filename, data, callback)</code> - Save file to app&#8217;s sandbox directory</p>
</li>
<li>
<p><code>loadSandboxFile(filename, callback)</code> - Load file from app&#8217;s sandbox directory</p>
</li>
<li>
<p><code>listSandboxFiles(callback)</code> - List files in app&#8217;s sandbox directory</p>
</li>
<li>
<p><code>deleteSandboxFile(filename, callback)</code> - Delete file from sandbox directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Security Constraints:</strong>
* Sandbox directory is scoped to <code>{cartridge_guid}/{app_id}/sandbox/</code>
* Apps <strong>cannot</strong> access files outside their sandbox
* Apps <strong>cannot</strong> access the host file system
* Apps <strong>cannot</strong> make network requests
* Sandbox is cleared when cartridge is deleted (optional: user preference to retain)</p>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_security_sandbox_and_api_restrictions">15.5. JavaScript Security Sandbox and API Restrictions</h3>
<div class="paragraph">
<p>Qt WebEngine provides native sandboxing capabilities, but additional restrictions are required to ensure embedded applications operate securely within the local-only, sandboxed environment.</p>
</div>
<div class="sect3">
<h4 id="_qt_webengine_native_sandboxing">15.5.1. Qt WebEngine Native Sandboxing</h4>
<div class="paragraph">
<p><strong>Built-in Security Features:</strong>
* <strong>Process Isolation:</strong> Each <code>QWebEngineView</code> runs in a separate renderer process (Chromium&#8217;s multi-process architecture)
* <strong>V8 JavaScript Engine:</strong> Isolated JavaScript execution context per view
* <strong>Network Interceptor:</strong> <code>QWebEngineUrlRequestInterceptor</code> can block network requests at the profile level
* <strong>CSP Support:</strong> Content Security Policy headers can be enforced</p>
</div>
<div class="paragraph">
<p><strong>Isolation Strategy:</strong>
* Each embedded app runs in its own <code>QWebEngineView</code> instance
* Complete JavaScript isolation between apps
* Each view has its own WebChannel bridge instance
* Apps cannot access each other&#8217;s JavaScript or DOM</p>
</div>
</div>
<div class="sect3">
<h4 id="_network_api_restrictions">15.5.2. Network API Restrictions</h4>
<div class="paragraph">
<p><strong>Blocked APIs (via Interceptor + CSP):</strong>
* <strong><code>fetch()</code></strong> - All network requests blocked
* <strong><code>XMLHttpRequest</code></strong> - All network requests blocked
* <strong><code>WebSocket</code></strong> - All WebSocket connections blocked
* <strong><code>EventSource</code> (Server-Sent Events)</strong> - All SSE connections blocked
* <strong><code>&lt;script src="http&#8230;&#8203;"&gt;</code></strong> - External script loading blocked
* <strong><code>&lt;link href="http&#8230;&#8203;"&gt;</code></strong> - External stylesheet loading blocked
* <strong><code>&lt;img src="http&#8230;&#8203;"&gt;</code></strong> - External image loading blocked (unless cached)
* <strong><code>&lt;iframe src="http&#8230;&#8203;"&gt;</code></strong> - External iframe loading blocked</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* <code>QWebEngineUrlRequestInterceptor</code> blocks all HTTP/HTTPS requests
* CSP header: <code>connect-src 'none';</code> prevents network connections
* CSP header: <code>default-src 'self';</code> restricts resource loading to local content only</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_system_api_restrictions">15.5.3. File System API Restrictions</h4>
<div class="paragraph">
<p><strong>Blocked APIs:</strong>
* <strong>File System Access API</strong> (<code>window.showOpenFilePicker()</code>, <code>window.showSaveFilePicker()</code>) - Blocked (use WebChannel sandbox API instead)
* <strong>FileReader API</strong> (for local files) - Restricted (can only read files provided via sandbox API)
* <strong>FileWriter API</strong> - Blocked (use WebChannel sandbox API instead)</p>
</div>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong>FileReader API</strong> (for Blob/ArrayBuffer) - Allowed (for in-memory file processing)
* <strong>Blob API</strong> - Allowed (for creating in-memory file objects)
* <strong>URL.createObjectURL()</strong> - Allowed (for creating blob URLs)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Direct file system access is blocked to prevent access outside the sandbox. All file operations must go through the WebChannel sandbox API, which enforces path validation and sandbox boundaries.</p>
</div>
</div>
<div class="sect3">
<h4 id="_storage_api_restrictions">15.5.4. Storage API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong><code>localStorage</code></strong> - Allowed (scoped to app&#8217;s origin, isolated per app instance)
* <strong><code>sessionStorage</code></strong> - Allowed (scoped to app&#8217;s origin, cleared on app unload)
* <strong><code>IndexedDB</code></strong> - Allowed (scoped to app&#8217;s origin, isolated per app instance)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Browser storage APIs are isolated per origin/view, providing natural isolation. Apps can use these for temporary data storage without security risks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clipboard_api_restrictions">15.5.5. Clipboard API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong><code>navigator.clipboard.readText()</code></strong> - Allowed (read from clipboard)
* <strong><code>navigator.clipboard.writeText()</code></strong> - Allowed (write to clipboard)
* <strong><code>navigator.clipboard.read()</code></strong> - Allowed (read clipboard data)
* <strong><code>navigator.clipboard.write()</code></strong> - Allowed (write clipboard data)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Clipboard access is safe and useful for user experience (copy/paste functionality). Users control clipboard content, so no security risk.</p>
</div>
</div>
<div class="sect3">
<h4 id="_device_access_api_restrictions">15.5.6. Device Access API Restrictions</h4>
<div class="paragraph">
<p><strong>Blocked APIs:</strong>
* <strong><code>navigator.geolocation</code></strong> - Blocked (privacy concern, not needed for local apps)
* <strong><code>navigator.mediaDevices.getUserMedia()</code></strong> - Blocked (camera/microphone access not needed)
* <strong><code>navigator.mediaDevices.enumerateDevices()</code></strong> - Blocked (device enumeration not needed)
* <strong><code>navigator.getBattery()</code></strong> - Blocked (battery API not needed)
* <strong><code>navigator.vibrate()</code></strong> - Blocked (vibration API not needed)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Device access APIs are not needed for local-only applications and pose privacy/security risks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_window_and_navigation_api_restrictions">15.5.7. Window and Navigation API Restrictions</h4>
<div class="paragraph">
<p><strong>Blocked APIs:</strong>
* <strong><code>window.open()</code></strong> - Blocked (prevents opening external windows/URLs)
* <strong><code>window.location.href = "http&#8230;&#8203;"</code></strong> - Blocked (prevents navigation to external URLs)
* <strong><code>window.location.replace()</code></strong> - Restricted (can only navigate within app&#8217;s local context)
* <strong><code>window.location.assign()</code></strong> - Restricted (can only navigate within app&#8217;s local context)
* <strong><code>window.history.pushState()</code></strong> - Allowed (for SPA navigation within app)
* <strong><code>window.history.replaceState()</code></strong> - Allowed (for SPA navigation within app)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> External navigation is blocked to prevent network access. Internal navigation (SPA routing) is allowed for app functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="_communication_api_restrictions">15.5.8. Communication API Restrictions</h4>
<div class="paragraph">
<p><strong>Blocked APIs:</strong>
* <strong><code>window.postMessage()</code></strong> - Restricted (can only communicate within same origin/app instance)
* <strong><code>BroadcastChannel</code></strong> - Restricted (can only communicate within same origin/app instance)
* <strong><code>SharedWorker</code></strong> - Blocked (not needed, potential security risk)
* <strong><code>Service Worker</code></strong> - Blocked (not needed, potential security risk, network access risk)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Cross-origin communication is blocked. Same-origin communication is allowed for app internal functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="_worker_api_restrictions">15.5.9. Worker API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong><code>new Worker()</code></strong> - Allowed (Web Workers for performance, isolated execution)
* <strong><code>new SharedWorker()</code></strong> - Blocked (not needed, potential security risk)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Web Workers are allowed for performance (offloading computation), but SharedWorkers are blocked as they&#8217;re not needed and pose potential security risks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_evaluation_api_restrictions">15.5.10. Evaluation API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs (with CSP):</strong>
* <strong><code>eval()</code></strong> - Allowed (required for many SPAs, controlled via CSP)
* <strong><code>Function()</code> constructor</strong> - Allowed (required for many SPAs, controlled via CSP)
* <strong><code>setTimeout(codeString)</code></strong> - Allowed (required for some frameworks, controlled via CSP)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Dynamic code evaluation is necessary for many SPA frameworks. CSP provides some protection, but primary security comes from network blocking and sandbox isolation.</p>
</div>
<div class="paragraph">
<p><strong>CSP Configuration:</strong>
* <code>script-src 'self' 'unsafe-inline' 'unsafe-eval';</code> - Allows inline scripts and eval (required for SPAs)</p>
</div>
</div>
<div class="sect3">
<h4 id="_webassembly_api_restrictions">15.5.11. WebAssembly API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong><code>WebAssembly.compile()</code></strong> - Allowed
* <strong><code>WebAssembly.instantiate()</code></strong> - Allowed
* <strong><code>WebAssembly.compileStreaming()</code></strong> - Blocked (requires network, use compile() instead)
* <strong><code>WebAssembly.instantiateStreaming()</code></strong> - Blocked (requires network, use instantiate() instead)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> WebAssembly is allowed for performance, but streaming APIs are blocked as they require network access.</p>
</div>
</div>
<div class="sect3">
<h4 id="_notification_api_restrictions">15.5.12. Notification API Restrictions</h4>
<div class="paragraph">
<p><strong>Allowed APIs:</strong>
* <strong><code>new Notification()</code></strong> - Allowed (for user notifications within app)
* <strong><code>Notification.requestPermission()</code></strong> - Allowed (for permission requests)</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong> Notifications are safe and useful for user experience. They&#8217;re scoped to the app instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="_content_security_policy_csp_configuration">15.5.13. Content Security Policy (CSP) Configuration</h4>
<div class="paragraph">
<p><strong>CSP Header for Embedded Apps:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>default-src 'self';
script-src 'self' 'unsafe-inline' 'unsafe-eval';
style-src 'self' 'unsafe-inline';
connect-src 'none';
img-src 'self' data: blob:;
font-src 'self' data:;
object-src 'none';
base-uri 'self';
form-action 'none';
frame-ancestors 'none';</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>CSP Directives Explained:</strong>
* <code>default-src 'self'</code> - Only load resources from same origin (local app content)
* <code>script-src 'self' 'unsafe-inline' 'unsafe-eval'</code> - Allow inline scripts and eval (required for SPAs)
* <code>style-src 'self' 'unsafe-inline'</code> - Allow inline styles (required for SPAs)
* <code>connect-src 'none'</code> - Block all network connections (fetch, XHR, WebSocket, etc.)
* <code>img-src 'self' data: blob:</code> - Allow images from same origin, data URIs, and blob URLs
* <code>font-src 'self' data:</code> - Allow fonts from same origin and data URIs
* <code>object-src 'none'</code> - Block plugins (Flash, etc.)
* <code>base-uri 'self'</code> - Restrict base tag URLs
* <code>form-action 'none'</code> - Block form submissions (not needed, apps use WebChannel API)
* <code>frame-ancestors 'none'</code> - Prevent embedding in iframes</p>
</div>
</div>
<div class="sect3">
<h4 id="_network_request_interceptor_implementation">15.5.14. Network Request Interceptor Implementation</h4>
<div class="paragraph">
<p><strong>Implementation Approach:</strong>
* Create custom <code>QWebEngineUrlRequestInterceptor</code> subclass
* Override <code>interceptRequest()</code> method
* Block all HTTP/HTTPS requests (return <code>QWebEngineUrlRequestInterceptor::RequestIntercepted</code>)
* Allow only <code>data:</code>, <code>blob:</code>, and <code>file://</code> URLs (for local content)
* Log blocked requests for debugging (optional)</p>
</div>
<div class="paragraph">
<p><strong>Code Structure (Conceptual):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class EmbeddedAppRequestInterceptor : public QWebEngineUrlRequestInterceptor {
public:
    void interceptRequest(QWebEngineUrlRequestInfo &amp;info) override {
        QUrl url = info.requestUrl();
        QString scheme = url.scheme().toLower();

        // Block all network requests
        if (scheme == "http" || scheme == "https") {
            info.block(true);
            return;
        }

        // Allow local schemes
        if (scheme == "data" || scheme == "blob" || scheme == "file") {
            info.block(false);
            return;
        }

        // Block everything else
        info.block(true);
    }
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_security_layers_summary">15.5.15. Security Layers Summary</h4>
<div class="paragraph">
<p><strong>Defense in Depth:</strong>
. <strong>Process Isolation</strong> (Qt WebEngine native) - Apps run in separate renderer processes
. <strong>Network Interceptor</strong> (Primary defense) - Blocks all network requests at the profile level
. <strong>CSP Headers</strong> (Secondary defense) - Restricts resource loading and connections
. <strong>API Restrictions</strong> (Tertiary defense) - Blocks/restricts dangerous JavaScript APIs
. <strong>Sandbox File System</strong> (Controlled access) - All file operations go through validated WebChannel API</p>
</div>
<div class="paragraph">
<p><strong>Security Model:</strong>
* <strong>Default Deny:</strong> All network access denied by default
* <strong>Whitelist Approach:</strong> Only explicitly allowed APIs are available
* <strong>Isolation:</strong> Each app runs in its own isolated context
* <strong>Validation:</strong> All file operations validated for path traversal prevention</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_architecture_and_window_management">16. Application Architecture and Window Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_multi_window_design">16.1. Multi-Window Design</h3>
<div class="paragraph">
<p>The Smartbook Reader SHALL implement a Multi-Window Architecture: a single <strong>Library Manager</strong> and multiple, independent <strong>Reader View</strong> instances, allowing simultaneous viewing of multiple cartridges.</p>
</div>
</div>
<div class="sect2">
<h3 id="_component_isolation">16.2. Component Isolation</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Database Isolation:</strong> Each Reader View is isolated to its single cartridge file.</p>
</li>
<li>
<p><strong>WebChannel Scope:</strong> The <code>SmartbookBridge</code> is uniquely instantiated per Reader View instance.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_window_opening_mechanisms">16.3. Window Opening Mechanisms</h3>
<div class="paragraph">
<p><strong>Double-Click Opening:</strong>
* <strong>List View:</strong> Double-clicking a cartridge title opens the cartridge in a new Reader View Window
* <strong>Grid View:</strong> Double-clicking a cartridge cover opens the cartridge in a new Reader View Window
* Visual feedback: Brief highlight or selection indicator when double-click is detected
* Opens new window immediately (no confirmation dialog)</p>
</div>
<div class="paragraph">
<p><strong>Context Menu Opening:</strong>
* <strong>List View:</strong> Right-clicking a cartridge title displays a context menu
* <strong>Grid View:</strong> Right-clicking a cartridge cover displays a context menu
* Context menu options:
  * <strong>Open</strong> - Opens cartridge in new Reader View Window (primary action)
  * <strong>Open in New Window</strong> - Explicitly opens in new window (redundant but follows platform conventions)
  * <strong>Properties</strong> - Display cartridge metadata (optional, Phase 2)
  * <strong>Delete</strong> - Remove cartridge from library (existing functionality)
* Context menu follows platform conventions (e.g., macOS: native context menu, Windows: Qt context menu)</p>
</div>
<div class="paragraph">
<p><strong>Platform Conventions:</strong>
* Behavior should mimic established e-book applications:
  * <strong>Calibre:</strong> Double-click opens book, right-click shows context menu
  * <strong>Apple Books:</strong> Click opens book, right-click shows context menu
  * <strong>Adobe Digital Editions:</strong> Double-click opens book, right-click shows context menu
* Follow platform-specific UI guidelines (macOS Human Interface Guidelines, Windows UI Guidelines, Linux desktop environment guidelines)</p>
</div>
</div>
<div class="sect2">
<h3 id="_window_state_persistence">16.4. Window State Persistence</h3>
<div class="paragraph">
<p><strong>Window State Components:</strong>
* <strong>Window Geometry:</strong>
  * Width (pixels)
  * Height (pixels)
  * X position (screen coordinates, left edge)
  * Y position (screen coordinates, top edge)
* <strong>Window State:</strong>
  * Maximized flag (boolean)
  * Note: Minimized state is not persisted (window restores to previous non-minimized state)
* <strong>Reading Position:</strong> (See "Reading Position Persistence" section)
  * <code>page_id</code>
  * <code>anchor_id</code> (optional)
  * <code>scroll_position</code> (pixels from top)</p>
</div>
<div class="paragraph">
<p><strong>Save Window State:</strong>
* Triggered when Reader View Window is closed (user closes window or application quits)
* Save to <code>Local_Window_State</code> table:
  * Insert or update entry for <code>cartridge_guid</code>
  * Store window geometry (width, height, x, y)
  * Store maximized state
  * Update <code>last_updated</code> timestamp
* Save reading position to <code>Local_Reading_Position</code> table (see "Reading Position Persistence" section)
* Both saves occur atomically (in same transaction if possible)</p>
</div>
<div class="paragraph">
<p><strong>Window State Save Algorithm:</strong>
. <strong>On Window Close Event:</strong>
   a. Get current window geometry: <code>QMainWindow::geometry()</code> or <code>QMainWindow::frameGeometry()</code>
   b. Get window state: <code>QMainWindow::isMaximized()</code>
   c. Get reading position from WebEngine view (current page, scroll position)
   d. Open transaction on local database
   e. Insert or update <code>Local_Window_State</code> entry
   f. Insert or update <code>Local_Reading_Position</code> entry
   g. Commit transaction
   h. Close window</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>On Application Quit:</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Iterate through all open Reader View Windows</p>
</li>
<li>
<p>For each window, save window state and reading position (as above)</p>
</li>
<li>
<p>Close all windows</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Window State Validation:</strong>
* Before restoring window state, validate saved geometry:
  * Check if saved position is within current screen bounds (accounting for multi-monitor setups)
  * Check if saved size is within reasonable bounds (minimum: 400x300, maximum: screen size)
  * If validation fails, use default window size and position</p>
</div>
</div>
<div class="sect2">
<h3 id="_window_state_restoration">16.5. Window State Restoration</h3>
<div class="paragraph">
<p><strong>Restore Window State:</strong>
* Triggered when cartridge is opened in new Reader View Window
* Query <code>Local_Window_State</code> table for <code>cartridge_guid</code>
* If entry exists:
  * Restore window geometry (width, height, x, y)
  * Restore maximized state (if was maximized, restore maximized)
  * If entry doesn&#8217;t exist, use default window size and position
* Query <code>Local_Reading_Position</code> table for <code>cartridge_guid</code>
* If entry exists:
  * Navigate to saved <code>page_id</code>
  * Navigate to saved <code>anchor_id</code> (if present)
  * Scroll to saved <code>scroll_position</code>
* If no reading position exists, navigate to first page</p>
</div>
<div class="paragraph">
<p><strong>Window State Restoration Algorithm:</strong>
. <strong>On Cartridge Open:</strong>
   a. Create new <code>ReaderViewInstance</code> window
   b. Query <code>Local_Window_State</code> for <code>cartridge_guid</code>
   c. If entry found:
      * Validate saved geometry (see "Window State Validation" above)
      * If valid: Set window geometry using <code>QMainWindow::setGeometry()</code> or <code>QMainWindow::resize()</code> and <code>QMainWindow::move()</code>
      * If was maximized: Call <code>QMainWindow::showMaximized()</code>
      * If invalid: Use default geometry
  <br>
   d. If entry not found:
      * Use default window size (e.g., 1024x768) and center on screen
  <br>
   e. Show window
   f. Load cartridge content
   g. Query <code>Local_Reading_Position</code> for <code>cartridge_guid</code>
   h. If entry found:
      * Navigate to saved <code>page_id</code>
      * If <code>anchor_id</code> present, scroll to anchor
      * If <code>scroll_position</code> present, scroll to position
  <br>
   i. If entry not found:
      * Navigate to first page</p>
</div>
<div class="paragraph">
<p><strong>Default Window Geometry:</strong>
* <strong>Default Size:</strong> 1024x768 pixels (or 80% of primary screen size, whichever is smaller)
* <strong>Default Position:</strong> Centered on primary screen
* <strong>Default State:</strong> Normal (not maximized)</p>
</div>
<div class="paragraph">
<p><strong>Multi-Monitor Handling:</strong>
* If saved window position is on a monitor that no longer exists:
  * Move window to primary monitor
  * Center window on primary monitor
* If saved window size exceeds current screen size:
  * Resize to fit within screen bounds
  * Maintain aspect ratio if possible</p>
</div>
</div>
<div class="sect2">
<h3 id="_window_minimize_and_restore_behavior">16.6. Window Minimize and Restore Behavior</h3>
<div class="paragraph">
<p><strong>Standard OS Behavior:</strong>
* <strong>Minimize:</strong> Follow platform conventions:
  * <strong>Windows:</strong> Window minimizes to taskbar
  * <strong>macOS:</strong> Window minimizes to Dock (if enabled) or hides
  * <strong>Linux:</strong> Window minimizes to taskbar/panel (desktop environment dependent)
* <strong>Restore:</strong> Follow platform conventions:
  * <strong>Windows:</strong> Click taskbar icon to restore
  * <strong>macOS:</strong> Click Dock icon or use Mission Control
  * <strong>Linux:</strong> Click taskbar/panel icon to restore</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong>
* Use Qt&#8217;s standard window management:
  * <code>QMainWindow::showMinimized()</code> - Minimize window
  * <code>QMainWindow::showNormal()</code> - Restore from minimized/maximized
  * <code>QMainWindow::showMaximized()</code> - Maximize window
* Minimized state is NOT persisted (window restores to previous non-minimized state)
* Window state (normal/maximized) is persisted, but minimized state is transient</p>
</div>
<div class="paragraph">
<p><strong>Window State Transitions:</strong>
* <strong>Normal → Minimized:</strong> Window minimizes, state not saved
* <strong>Minimized → Normal:</strong> Window restores to previous size/position (from <code>Local_Window_State</code>)
* <strong>Normal → Maximized:</strong> Window maximizes, state saved on close
* <strong>Maximized → Normal:</strong> Window restores to saved size/position, state saved on close
* <strong>Maximized → Minimized:</strong> Window minimizes, maximized state preserved (restores to maximized when unminimized)</p>
</div>
</div>
<div class="sect2">
<h3 id="_window_closing_behavior">16.7. Window Closing Behavior</h3>
<div class="paragraph">
<p><strong>User-Initiated Close:</strong>
* User clicks window close button (X button)
* User selects File → Close from menu
* User presses platform-specific close shortcut (e.g., Ctrl+W, Cmd+W)
* Before closing:
  * Save window state (geometry, position, maximized state)
  * Save reading position (page, anchor, scroll position)
  * Close window</p>
</div>
<div class="paragraph">
<p><strong>Application Quit:</strong>
* User quits application (File → Quit, platform-specific quit shortcut)
* Before quitting:
  * Save window state for all open Reader View Windows
  * Save reading position for all open Reader View Windows
  * Close all windows
  * Exit application</p>
</div>
<div class="paragraph">
<p><strong>Close Confirmation (Optional):</strong>
* No confirmation dialog by default (follows platform conventions)
* Reading position and window state are automatically saved
* User can immediately reopen cartridge to continue reading</p>
</div>
<div class="paragraph">
<p><strong>Multiple Windows:</strong>
* Each Reader View Window is independent
* Closing one window does not affect other open windows
* Each window saves its own state independently
* Library Manager window state is NOT persisted (always opens with default geometry)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creator_tools_cartridge_packaging_algorithm">17. Creator Tool&#8217;s Cartridge Packaging Algorithm</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_phase_1_content_assembly_and_guid_generation">17.1. Phase 1: Content Assembly and GUID Generation</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Step</th>
<th class="tableblock halign-center valign-middle">Action by Creator Tool</th>
<th class="tableblock halign-center valign-middle">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1. Initialize Database</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new, empty SQLite file and define all required table schemas.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty Cartridge DB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>2. Generate GUID</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate a new, globally unique <strong>UUID Version 4</strong> string.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cartridge_guid</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3. Populate Metadata</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert <code>cartridge_guid</code>, <code>title</code>, and other metadata (including <code>publication_year</code>) into <code>Metadata</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata Table Populated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4. Insert Content</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert all content data into <code>Content_Pages</code>, <code>Form_Definitions</code>, etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Tables Populated</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_phase_2_hash_calculation_and_security_preparation">17.2. Phase 2: Hash Calculation and Security Preparation</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Step</th>
<th class="tableblock halign-center valign-middle">Action by Creator Tool</th>
<th class="tableblock halign-center valign-middle">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1. Serialize Critical Tables</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Export the binary representation of the critical tables using the Content Hash Algorithm (see "Content Hash Algorithm Specification" section below).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary Content Blob</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>2. Calculate Content Hash (H1)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calculate the hash using SHA-256 algorithm as specified in the Content Hash Algorithm Specification.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H1 (Content Hash)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3. Determine Signing Method</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prompt author to choose signing method (Level 1, 2, or 3).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signing Intent</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_phase_3_signature_application_and_finalization">17.3. Phase 3: Signature Application and Finalization</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Step</th>
<th class="tableblock halign-center valign-middle">Action by Creator Tool</th>
<th class="tableblock halign-center valign-middle">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1. Apply Signature</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>If Level 1/2 selected:</strong> Use Private Key to sign H1, creating the <code>digital_signature</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>digital_signature</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>2. Extract Key Info</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extract the <code>digest_type</code> and the <code>public_key_fingerprint</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Info</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>3. Populate Security Table</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert one row into the <code>Cartridge_Security</code> table with H1, <code>digital_signature</code>, and key info. <strong>If Level 3 selected, this table remains empty.</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cartridge_Security</code> Table Populated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>4. Finalize Cartridge</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Close and optimize the SQLite database connection. Export the final <code>.sqlite</code> file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final, Secured Cartridge File</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_c_class_hierarchy_and_data_flow_implementation_design">18. C++ Class Hierarchy and Data Flow (Implementation Design)</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <code>diagrams.adoc</code> for visual representations including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Component Interaction Diagram - Shows how components interact during cartridge loading</p>
</li>
<li>
<p>Data Flow Diagrams - Illustrate cartridge data flow and form data persistence flow</p>
</li>
<li>
<p>Sequence Diagrams - Cartridge loading, embedded app execution, form data save, import, and trust revocation processes</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_core_application_management_classes">18.1. Core Application Management Classes</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Class Name</th>
<th class="tableblock halign-center valign-middle">Inheritance</th>
<th class="tableblock halign-center valign-middle">Responsibility</th>
<th class="tableblock halign-center valign-middle">Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>SmartbookApp</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>QApplication</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manages the application lifecycle, initialization of the local DB, and the set of active <code>ReaderViewInstance</code> windows.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDBManager</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>LocalDBManager</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>QObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manages connections to the <code>Local_Library_Manifest</code> and <code>Local_Trust_Registry</code>. Provides centralized trust/metadata lookup.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLite API</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_reader_view_instance_classes_per_cartridge">18.2. Reader View Instance Classes (Per Cartridge)</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Class Name</th>
<th class="tableblock halign-center valign-middle">Inheritance</th>
<th class="tableblock halign-center valign-middle">Responsibility</th>
<th class="tableblock halign-center valign-middle">Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>ReaderViewInstance</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>QMainWindow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Primary Session Container.</strong> Owns the WebEngine, Bridge, and DB Connector for a single cartridge. Executes the final load based on Policy.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>QWebEngineView</code>, <code>SignatureVerifier</code>, <code>SmartbookBridge</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>CartridgeDBConnector</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>QObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manages the SQLite connection to the active cartridge file. Executes all persistence CRUD operations (<code>User_Data</code>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQLite API</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>SignatureVerifier</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>QObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes the 4-phase Verification Algorithm (Sec 6). Outputs the <strong>Effective Trust Policy</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDBManager</code> (read access)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>SmartbookBridge</code></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>QObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exposes C++ methods to JS via <strong>Qt WebChannel</strong>. Checks the internal trust policy before triggering the native consent dialog.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReaderViewInstance</code> (parent), <code>QWebChannel</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_interface_ui_design_specification_final">19. User Interface (UI) Design Specification (FINAL)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The UI is divided into two primary windows, adhering to the Multi-Window Architecture.</p>
</div>
<div class="sect2">
<h3 id="_window_1_library_manager_the_hub_dual_view_final">19.1. Window 1: Library Manager (The Hub) - Dual View (FINAL)</h3>
<div class="paragraph">
<p>The Library Manager MUST allow the user to toggle between two modes: the visual <strong>Bookshelf View</strong> and the detailed <strong>List-View</strong>.</p>
</div>
<div class="sect3">
<h4 id="_bookshelf_view_visual_mode">19.1.1. Bookshelf View (Visual Mode)</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Element</th>
<th class="tableblock halign-center valign-middle">Specification Detail</th>
<th class="tableblock halign-center valign-middle">Visual/Interaction Focus</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Layout</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Responsive grid simulating a bookshelf (3-4 columns).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prioritizes visual browsing speed (NFR-3.1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cartridge Tile Content</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prominent <strong>Cover Image</strong> (<code>cover_image_data</code>). If null, a generic image must be used with the <strong>Title</strong> centered.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimal text to maintain visual focus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Security Status Badge</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Color-coded icon (L1/L2/L3) in the tile&#8217;s corner.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual indication of trust level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Location Status Icon</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dedicated icon for local/remote status (Cloud/Checkmark).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Phase 2 requirement.</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Delete Action</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Context Menu entry on the tile.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggers native confirmation dialog (FR-2.5.5).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_list_view_data_grid_mode">19.1.2. List-View (Data Grid Mode)</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Element</th>
<th class="tableblock halign-center valign-middle">Specification Detail</th>
<th class="tableblock halign-center valign-middle">Visual/Interaction Focus</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Layout</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sortable, filterable tabular data grid (<code>QTableView</code>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prioritizes data management and sorting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Mandatory Columns</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Title, Author, Edition/Version, Year of Publication.</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sourced from <code>Local_Library_Manifest</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Delete Action</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Context Menu and <strong>Delete</strong> keyboard shortcut.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggers native confirmation dialog (FR-2.5.5).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Trust Management</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dedicated button or right-click context menu entry.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access point for <strong>Trust Revocation</strong> (FR-2.4.3).</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_window_2_reader_view_the_content">19.2. Window 2: Reader View (The Content)</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Element</th>
<th class="tableblock halign-center valign-middle">Component / Function</th>
<th class="tableblock halign-center valign-middle">Security Display Requirement</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Integrity Warning Bar</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistent, non-dismissible colored banner fixed above content.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be visible for Level 2 and Level 3 cartridges.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cartridge Loading Consent Dialog</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Native modal dialog displayed when opening Level 2 or Level 3 cartridges.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Detailed requirements in 11.2.1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>App Consent Dialog</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Native modal window triggered by <code>requestAppConsent</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Detailed requirements in 11.2.2.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_cartridge_loading_consent_dialog_requirements">19.2.1. Cartridge Loading Consent Dialog Requirements</h4>
<div class="paragraph">
<p>This dialog appears when a user attempts to open a Level 2 (Self-Signed Trust) or Level 3 (No Signature) cartridge, before the cartridge content is loaded. The dialog allows the user to decide whether to load the cartridge and optionally add it to the whitelist for future loads.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dialog_appearance_and_positioning">19.3. Dialog Appearance and Positioning</h3>
<div class="paragraph">
<p><strong>Modal Dialog Requirements:</strong>
* <strong>Type:</strong> Native OS modal dialog (Qt <code>QMessageBox</code> or custom modal dialog)
* <strong>Positioning:</strong> Centered horizontally and vertically on the primary screen
* <strong>Size:</strong> Minimum 400px width, auto-height based on content (maximum 600px height)
* <strong>Modal Behavior:</strong> Blocks all interaction with the Reader application until dismissed
* <strong>Accessibility:</strong> Keyboard navigation (Tab, Enter, Escape), screen reader support</p>
</div>
</div>
<div class="sect2">
<h3 id="_dialog_content_and_verbiage">19.4. Dialog Content and Verbiage</h3>
<div class="sect3">
<h4 id="_for_level_2_self_signed_certificate_cartridges">19.4.1. For Level 2 (Self-Signed Certificate) Cartridges</h4>
<div class="paragraph">
<p><strong>Title:</strong> "Security Warning: Self-Signed Cartridge"</p>
</div>
<div class="paragraph">
<p><strong>Main Message:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>This cartridge is signed with a self-signed certificate and cannot be verified by a trusted authority.

Cartridge: [Title]
Author: [Author Name]
Security Level: Level 2 (Self-Signed Trust)

⚠️ WARNING: This cartridge has not been verified by a trusted certificate authority. The content may have been modified or could contain potentially unsafe embedded applications.

Do you want to load this cartridge?</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Options:</strong>
. "Load and Always Trust" (Adds to whitelist) — Default button
. "Load for This Session Only" (Temporary trust)
. "Cancel" (Do not load)</p>
</div>
</div>
<div class="sect3">
<h4 id="_for_level_3_no_signature_cartridges">19.4.2. For Level 3 (No Signature) Cartridges</h4>
<div class="paragraph">
<p><strong>Title:</strong> "Security Warning: Unsigned Cartridge"</p>
</div>
<div class="paragraph">
<p><strong>Main Message:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>This cartridge has no digital signature and cannot be verified.

Cartridge: [Title]
Author: [Author Name]
Security Level: Level 3 (No Signature)

⚠️ WARNING: This cartridge has no digital signature. The content cannot be verified and may have been modified. Embedded applications may pose security risks.

Do you want to load this cartridge?</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Options:</strong>
. "Load and Always Trust" (Adds to whitelist)
. "Load for This Session Only" (Temporary trust)
. "Cancel" (Do not load)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dismissal_behavior">19.5. Dismissal Behavior</h3>
<div class="paragraph">
<p><strong>When "Load and Always Trust" is selected:</strong>
* Cartridge is added to the <code>Local_Trust_Registry</code> with <code>trust_type = 'PERSISTENT'</code>
* Cartridge is loaded and displayed in the Reader View Window
* Future loads of this cartridge bypass the consent dialog
* Integrity warning bar is still displayed (as per FR-2.3.2/2.3.3)</p>
</div>
<div class="paragraph">
<p><strong>When "Load for This Session Only" is selected:</strong>
* Cartridge is loaded and displayed in the Reader View Window
* No entry is added to <code>Local_Trust_Registry</code>
* Consent dialog will appear again on next load
* Integrity warning bar is displayed</p>
</div>
<div class="paragraph">
<p><strong>When "Cancel" is selected (or dialog closed via Escape/X button):</strong>
* Cartridge is <strong>not loaded</strong>
* Reader View Window is <strong>not opened</strong>
* User is returned to the Library Manager
* No entry is added to <code>Local_Trust_Registry</code>
* No error message is displayed (user choice)</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_details">19.6. Implementation Details</h3>
<div class="paragraph">
<p><strong>Dialog Trigger:</strong>
* Dialog appears immediately when user attempts to open a Level 2 or Level 3 cartridge
* Triggered before cartridge content is loaded into memory
* If cartridge is already in <code>Local_Trust_Registry</code> with valid trust, dialog is skipped</p>
</div>
<div class="paragraph">
<p><strong>Dialog Dismissal Methods:</strong>
* Clicking one of the three action buttons
* Pressing Escape key (treated as "Cancel")
* Clicking the window close button (X) (treated as "Cancel")
* Alt+F4 / Cmd+Q (application quit) — treated as "Cancel" for that cartridge</p>
</div>
<div class="paragraph">
<p><strong>Error Handling:</strong>
* If dialog cannot be displayed (UI error), log error and treat as "Cancel"
* If trust registry update fails after "Load and Always Trust", load cartridge but show warning that persistent trust was not saved</p>
</div>
<div class="sect3">
<h4 id="_native_app_consent_dialog_requirements">19.6.1. Native App Consent Dialog Requirements</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Element</th>
<th class="tableblock halign-center valign-middle">Specification Detail</th>
<th class="tableblock halign-center valign-middle">Required Functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Appearance</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be a native OS modal dialog.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conveys security authority to the user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Required Content</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cartridge Security Level, App Name, App Description.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear presentation of risk and function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Trust Options (FR-2.4.2)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Three mutually exclusive radio button choices:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="olist arabic">
<ol class="arabic">
<li>
<p>Trust for this session.</p>
</li>
<li>
<p><strong>Always trust this cartridge.</strong></p>
</li>
<li>
<p>Block execution.</p>
</li>
</ol>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_qt_webengine_configuration_implementation">20. Qt WebEngine Configuration Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section specifies the detailed configuration of Qt WebEngine for the Reader and Creator Tool applications, including profile settings, security configuration, performance optimization, and standards compliance.</p>
</div>
<div class="sect2">
<h3 id="_qt_webengine_version_requirements">20.1. Qt WebEngine Version Requirements</h3>
<div class="paragraph">
<p><strong>Minimum Qt Version:</strong>
* <strong>Qt 6.2+</strong> (recommended: Qt 6.5+)
* <strong>Qt WebEngine Module:</strong> Required module, must be included in build configuration</p>
</div>
<div class="paragraph">
<p><strong>Chromium Version:</strong>
* Qt WebEngine 6.2+ uses Chromium 91+
* Qt WebEngine 6.5+ uses Chromium 108+
* <strong>Documentation Requirement:</strong> Application SHALL document the exact Chromium version at build time (display in About dialog or log at startup)</p>
</div>
<div class="paragraph">
<p><strong>V8 JavaScript Engine:</strong>
* V8 version is determined by Chromium version
* Qt WebEngine 6.2+ uses V8 9.1+
* Qt WebEngine 6.5+ uses V8 10.8+
* <strong>Documentation Requirement:</strong> Application SHALL document the exact V8 version at build time</p>
</div>
<div class="paragraph">
<p><strong>HTML/CSS Standards:</strong>
* <strong>HTML5 Support:</strong> Full support for HTML5 specification as implemented by Chromium version (typically 95%+ compliance)
* <strong>CSS3 Support:</strong> Full support for CSS3 specification as implemented by Chromium version (typically 90%+ compliance)
* <strong>ECMAScript Support:</strong> Full support for ECMAScript 2022 (ES13) and earlier versions</p>
</div>
</div>
<div class="sect2">
<h3 id="_webengine_profile_configuration">20.2. WebEngine Profile Configuration</h3>
<div class="sect3">
<h4 id="_reader_content_rendering_profile">20.2.1. Reader Content Rendering Profile</h4>
<div class="paragraph">
<p><strong>Profile Purpose:</strong> Render cartridge content pages (HTML content from <code>Content_Pages</code> table)</p>
</div>
<div class="paragraph">
<p><strong>Profile Configuration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">QWebEngineProfile* contentProfile = new QWebEngineProfile("ContentProfile", this);

// Security Settings
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessRemoteUrls, false);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessFileUrls, true);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::JavascriptEnabled, true);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::PluginsEnabled, false);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::WebGLEnabled, true);

// Performance Settings
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::Accelerated2dCanvasEnabled, true);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::AcceleratedCompositingEnabled, true);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::SpatialNavigationEnabled, false);

// Cache Settings
contentProfile-&gt;setHttpCacheType(QWebEngineProfile::DiskHttpCache);
contentProfile-&gt;setHttpCacheMaximumSize(50 * 1024 * 1024); // 50MB cache

// Storage Settings
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalStorageEnabled, true);
contentProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::SessionStorageEnabled, true);

// Service Workers (disabled for security)
contentProfile-&gt;setHttpCacheType(QWebEngineProfile::DiskHttpCache); // Note: Service workers disabled via NoCache for embedded apps</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Settings Rationale:</strong>
* <code>LocalContentCanAccessRemoteUrls: false</code> - Prevents local content from accessing remote URLs (security)
* <code>LocalContentCanAccessFileUrls: true</code> - Allows loading local resources (images, fonts, etc.)
* <code>JavascriptEnabled: true</code> - Required for interactive content and embedded applications
* <code>PluginsEnabled: false</code> - Disables Flash and other plugins (security, plugins are deprecated)
* <code>WebGLEnabled: true</code> - Enables WebGL for graphics rendering (if needed by content)
* <code>Accelerated2dCanvasEnabled: true</code> - Hardware acceleration for canvas operations (performance)
* <code>AcceleratedCompositingEnabled: true</code> - Hardware-accelerated compositing (performance)
* <code>LocalStorageEnabled: true</code> - Allows localStorage for content persistence
* <code>SessionStorageEnabled: true</code> - Allows sessionStorage for temporary data</p>
</div>
</div>
<div class="sect3">
<h4 id="_embedded_application_profile">20.2.2. Embedded Application Profile</h4>
<div class="paragraph">
<p><strong>Profile Purpose:</strong> Execute embedded JavaScript applications (from <code>Embedded_Apps</code> table)</p>
</div>
<div class="paragraph">
<p><strong>Profile Configuration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">QWebEngineProfile* embeddedAppProfile = new QWebEngineProfile("EmbeddedAppProfile", this);

// Security Settings (Strict)
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessRemoteUrls, false);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessFileUrls, false);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::JavascriptEnabled, true);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::PluginsEnabled, false);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::WebGLEnabled, true);

// Performance Settings
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::Accelerated2dCanvasEnabled, true);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::AcceleratedCompositingEnabled, true);

// Cache Settings (No cache to prevent service workers)
embeddedAppProfile-&gt;setHttpCacheType(QWebEngineProfile::NoCache);

// Storage Settings (Isolated per app)
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalStorageEnabled, true);
embeddedAppProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::SessionStorageEnabled, true);

// Network Interceptor (Blocks all HTTP/HTTPS)
EmbeddedAppRequestInterceptor* interceptor = new EmbeddedAppRequestInterceptor(this);
embeddedAppProfile-&gt;setUrlRequestInterceptor(interceptor);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Key Differences from Content Profile:</strong>
* <code>LocalContentCanAccessFileUrls: false</code> - Embedded apps cannot access file: URLs (must use sandbox API)
* <code>HttpCacheType: NoCache</code> - Prevents service workers and caching (security)
* Network interceptor attached to block all network requests</p>
</div>
</div>
<div class="sect3">
<h4 id="_creator_tool_editing_profile">20.2.3. Creator Tool Editing Profile</h4>
<div class="paragraph">
<p><strong>Profile Purpose:</strong> WYSIWYG HTML editing interface in Creator Tool</p>
</div>
<div class="paragraph">
<p><strong>Profile Configuration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">QWebEngineProfile* editorProfile = new QWebEngineProfile("EditorProfile", this);

// Security Settings (Less restrictive for editing)
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessRemoteUrls, false);
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalContentCanAccessFileUrls, true);
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::JavascriptEnabled, true);
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::PluginsEnabled, false);

// Performance Settings
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::Accelerated2dCanvasEnabled, true);
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::AcceleratedCompositingEnabled, true);

// Cache Settings (Larger cache for editing performance)
editorProfile-&gt;setHttpCacheType(QWebEngineProfile::DiskHttpCache);
editorProfile-&gt;setHttpCacheMaximumSize(100 * 1024 * 1024); // 100MB cache

// Storage Settings
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::LocalStorageEnabled, true);
editorProfile-&gt;settings()-&gt;setAttribute(QWebEngineSettings::SessionStorageEnabled, true);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Key Differences:</strong>
* Larger cache (100MB vs 50MB) for better editing performance
* File URL access enabled for loading local resources during editing
* No network interceptor (editing interface may need to load local resources)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_network_request_interceptor_implementation_2">20.3. Network Request Interceptor Implementation</h3>
<div class="sect3">
<h4 id="_interceptor_class_definition">20.3.1. Interceptor Class Definition</h4>
<div class="paragraph">
<p><strong>Purpose:</strong> Block all HTTP/HTTPS requests from embedded applications while allowing local resource loading</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class EmbeddedAppRequestInterceptor : public QWebEngineUrlRequestInterceptor {
    Q_OBJECT
public:
    explicit EmbeddedAppRequestInterceptor(QObject* parent = nullptr)
        : QWebEngineUrlRequestInterceptor(parent) {}

    void interceptRequest(QWebEngineUrlRequestInfo &amp;info) override {
        QUrl url = info.requestUrl();
        QString scheme = url.scheme().toLower();

        // Allow data: and blob: URLs (for inline resources)
        if (scheme == "data" || scheme == "blob") {
            return; // Allow request
        }

        // Block all HTTP/HTTPS requests
        if (scheme == "http" || scheme == "https") {
            qWarning() &lt;&lt; "Blocked network request:" &lt;&lt; url.toString();
            info.block(true);
            return;
        }

        // Block file: URLs (apps should use sandbox API instead)
        if (scheme == "file") {
            qWarning() &lt;&lt; "Blocked file URL request:" &lt;&lt; url.toString();
            info.block(true);
            return;
        }

        // Allow other schemes (about:, chrome:, etc.) - these are internal
        // Note: Most internal schemes are already handled by WebEngine
    }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Interceptor Usage:</strong>
* Attach interceptor to embedded application profile: <code>embeddedAppProfile&#8594;setUrlRequestInterceptor(interceptor)</code>
* Interceptor applies to all requests from views using that profile
* Log all blocked requests for debugging and security monitoring</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_content_security_policy_csp_configuration_2">20.4. Content Security Policy (CSP) Configuration</h3>
<div class="sect3">
<h4 id="_csp_header_for_embedded_applications">20.4.1. CSP Header for Embedded Applications</h4>
<div class="paragraph">
<p><strong>CSP Policy String:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>default-src 'self' 'unsafe-inline' 'unsafe-eval';
script-src 'self' 'unsafe-inline' 'unsafe-eval';
style-src 'self' 'unsafe-inline';
connect-src 'none';
img-src 'self' data: blob:;
font-src 'self' data:;
object-src 'none';
base-uri 'self';
form-action 'none';</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Policy Directive Explanation:</strong>
* <code>default-src 'self' 'unsafe-inline' 'unsafe-eval'</code> - Default policy allows same-origin resources, inline scripts/styles, and eval (required for SPAs)
* <code>script-src 'self' 'unsafe-inline' 'unsafe-eval'</code> - Scripts from same origin, inline scripts, and eval() allowed
* <code>style-src 'self' 'unsafe-inline'</code> - Styles from same origin and inline styles allowed
* <code>connect-src 'none'</code> - <strong>No network connections allowed</strong> (primary security directive)
* <code>img-src 'self' data: blob:</code> - Images from same origin, data URIs, and blob URLs
* <code>font-src 'self' data:</code> - Fonts from same origin and data URIs
* <code>object-src 'none'</code> - No plugins/objects (Flash, etc.)
* <code>base-uri 'self'</code> - Base tag can only point to same origin
* <code>form-action 'none'</code> - Forms cannot submit (apps use WebChannel API instead)</p>
</div>
<div class="paragraph">
<p><strong>CSP Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ReaderViewInstance::setCSPHeaders(QWebEnginePage* page) {
    QString cspPolicy =
        "default-src 'self' 'unsafe-inline' 'unsafe-eval'; "
        "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
        "style-src 'self' 'unsafe-inline'; "
        "connect-src 'none'; "
        "img-src 'self' data: blob:; "
        "font-src 'self' data:; "
        "object-src 'none'; "
        "base-uri 'self'; "
        "form-action 'none'";

    // Set CSP header via custom request interceptor or page load
    // Note: CSP can be set via QWebEngineHttpRequest::setHeader() or
    // by injecting meta tag into HTML content
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>CSP Enforcement:</strong>
* CSP is a <strong>secondary defense layer</strong> - primary network blocking is via <code>QWebEngineUrlRequestInterceptor</code>
* CSP violations are logged by Chromium (can be captured via JavaScript console)
* CSP provides defense-in-depth security</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_webchannel_configuration">20.5. WebChannel Configuration</h3>
<div class="sect3">
<h4 id="_webchannel_setup_for_reader">20.5.1. WebChannel Setup for Reader</h4>
<div class="paragraph">
<p><strong>Bridge Registration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ReaderViewInstance::setupWebChannel(QWebEngineView* view) {
    QWebChannel* channel = new QWebChannel(this);
    SmartbookBridge* bridge = new SmartbookBridge(this, m_cartridgeConnector);

    // Register bridge object with name "SmartbookBridge"
    channel-&gt;registerObject("SmartbookBridge", bridge);

    // Set channel on page
    view-&gt;page()-&gt;setWebChannel(channel);

    // Inject WebChannel script (required for JavaScript-to-C++ communication)
    QFile webChannelJs(":/qtwebchannel/qwebchannel.js");
    if (webChannelJs.open(QIODevice::ReadOnly)) {
        QString script = webChannelJs.readAll();
        view-&gt;page()-&gt;runJavaScript(script);
    } else {
        qWarning() &lt;&lt; "Failed to load qwebchannel.js";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>WebChannel Script Injection:</strong>
* Qt WebEngine requires <code>qwebchannel.js</code> to be injected into the page
* Script is typically bundled with Qt WebEngine module (resource file)
* Script must be injected before any JavaScript code that uses WebChannel
* Script enables JavaScript-to-C++ communication via <code>SmartbookBridge</code> object</p>
</div>
<div class="paragraph">
<p><strong>JavaScript Usage:</strong>
* After script injection, JavaScript can access: <code>new QWebChannel(qt.webChannelTransport, function(channel) { &#8230;&#8203; })</code>
* Access bridge object: <code>channel.objects.SmartbookBridge</code>
* Call C++ methods: <code>SmartbookBridge.saveFormData(&#8230;&#8203;)</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling_configuration">20.6. Error Handling Configuration</h3>
<div class="sect3">
<h4 id="_javascript_console_error_handling">20.6.1. JavaScript Console Error Handling</h4>
<div class="paragraph">
<p><strong>Console Message Handler:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ReaderViewInstance::setupErrorHandling(QWebEnginePage* page) {
    // Connect to JavaScript console messages
    connect(page, &amp;QWebEnginePage::javascriptConsoleMessage,
            this, &amp;ReaderViewInstance::onJavaScriptConsoleMessage);
}

void ReaderViewInstance::onJavaScriptConsoleMessage(
    QWebEnginePage::JavaScriptConsoleMessageLevel level,
    const QString&amp; message,
    int lineNumber,
    const QString&amp; sourceID) {

    // Log JavaScript errors and warnings
    if (level == QWebEnginePage::ErrorMessageLevel) {
        qWarning() &lt;&lt; "JavaScript Error:" &lt;&lt; message
                   &lt;&lt; "at line" &lt;&lt; lineNumber
                   &lt;&lt; "in" &lt;&lt; sourceID;
        // Log to application log file with ERROR level
    } else if (level == QWebEnginePage::WarningMessageLevel) {
        qInfo() &lt;&lt; "JavaScript Warning:" &lt;&lt; message;
        // Log to application log file with WARN level
    }

    // Optionally display error overlay in UI for critical errors
    if (level == QWebEnginePage::ErrorMessageLevel) {
        // Show non-intrusive error indicator
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_webengine_process_crash_handling">20.6.2. WebEngine Process Crash Handling</h4>
<div class="paragraph">
<p><strong>Crash Detection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ReaderViewInstance::setupCrashHandling(QWebEngineView* view) {
    // Connect to render process terminated signal
    connect(view-&gt;page(), &amp;QWebEnginePage::renderProcessTerminated,
            this, &amp;ReaderViewInstance::onRenderProcessTerminated);
}

void ReaderViewInstance::onRenderProcessTerminated(
    QWebEnginePage::RenderProcessTerminationStatus status,
    int exitCode) {

    QString statusText;
    switch (status) {
        case QWebEnginePage::NormalTerminationStatus:
            statusText = "Normal termination";
            break;
        case QWebEnginePage::AbnormalTerminationStatus:
            statusText = "Abnormal termination (crash)";
            break;
        case QWebEnginePage::CrashedTerminationStatus:
            statusText = "Process crashed";
            break;
        case QWebEnginePage::KilledTerminationStatus:
            statusText = "Process killed";
            break;
    }

    qCritical() &lt;&lt; "WebEngine process terminated:" &lt;&lt; statusText
                &lt;&lt; "Exit code:" &lt;&lt; exitCode;

    // Log to application log file with ERROR level
    // Display recovery dialog to user
    showRecoveryDialog();
}

void ReaderViewInstance::showRecoveryDialog() {
    QMessageBox dialog(this);
    dialog.setIcon(QMessageBox::Critical);
    dialog.setWindowTitle("Content Viewer Error");
    dialog.setText("The content viewer encountered an error.");
    dialog.setInformativeText("What would you like to do?");
    dialog.addButton("Reload Page", QMessageBox::ActionRole);
    dialog.addButton("Close Cartridge", QMessageBox::ActionRole);
    dialog.addButton("Continue", QMessageBox::ActionRole);

    int result = dialog.exec();

    switch (result) {
        case 0: // Reload Page
            reloadPage();
            break;
        case 1: // Close Cartridge
            close();
            break;
        case 2: // Continue
            // Attempt to continue (may not work if process crashed)
            break;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Recovery Options:</strong>
* <strong>Reload Page:</strong> Reloads the page content (creates new renderer process)
* <strong>Close Cartridge:</strong> Closes the Reader View Window
* <strong>Continue:</strong> Attempts to continue (may not work if process crashed)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_performance_configuration">20.7. Performance Configuration</h3>
<div class="sect3">
<h4 id="_memory_management">20.7.1. Memory Management</h4>
<div class="paragraph">
<p><strong>Memory Usage:</strong>
* Each <code>QWebEngineView</code> instance uses approximately 50-100MB RAM
* Monitor memory usage for multiple simultaneous views
* Implement view lifecycle management (destroy unused views)
* Set memory warnings if system memory is low</p>
</div>
<div class="paragraph">
<p><strong>View Lifecycle:</strong>
* Create views on-demand (lazy loading)
* Destroy views when cartridge is closed
* Reuse views when possible (but maintain isolation for embedded apps)</p>
</div>
<div class="paragraph">
<p><strong>Memory Monitoring:</strong>
* Track memory usage per view
* Display warning if total memory usage exceeds threshold (e.g., 500MB)
* Offer to close other cartridges to free memory</p>
</div>
</div>
<div class="sect3">
<h4 id="_cache_configuration">20.7.2. Cache Configuration</h4>
<div class="paragraph">
<p><strong>HTTP Cache:</strong>
* <strong>Content Rendering:</strong> 50MB disk cache
* <strong>Creator Tool:</strong> 100MB disk cache
* <strong>Embedded Apps:</strong> No cache (prevents service workers)</p>
</div>
<div class="paragraph">
<p><strong>Cache Location:</strong>
* Platform-specific cache directories:
  * Windows: <code>%LOCALAPPDATA%\SmartBook\cache\</code>
  * macOS: <code>~/Library/Caches/SmartBook/</code>
  * Linux: <code>~/.cache/SmartBook/</code></p>
</div>
<div class="paragraph">
<p><strong>Cache Cleanup:</strong>
* Clear cache on application exit (optional, user preference)
* Clear cache on cartridge deletion (if cartridge-specific cache)
* Manual cache clear option in settings</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_htmlcss_standards_support">20.8. HTML/CSS Standards Support</h3>
<div class="sect3">
<h4 id="_html5_support">20.8.1. HTML5 Support</h4>
<div class="paragraph">
<p><strong>Supported Features:</strong>
* HTML5 semantic elements (<code>&lt;article&gt;</code>, <code>&lt;section&gt;</code>, <code>&lt;nav&gt;</code>, <code>&lt;header&gt;</code>, <code>&lt;footer&gt;</code>, etc.)
* HTML5 form elements and validation
* HTML5 media elements (<code>&lt;audio&gt;</code>, <code>&lt;video&gt;</code>)
* HTML5 canvas and SVG
* HTML5 Web Components (Custom Elements, Shadow DOM)</p>
</div>
<div class="paragraph">
<p><strong>Standards Compliance:</strong>
* Chromium&#8217;s HTML5 implementation (typically 95%+ compliance)
* Specific compliance level depends on Chromium version
* Document exact Chromium version and compliance level in application</p>
</div>
</div>
<div class="sect3">
<h4 id="_css3_support">20.8.2. CSS3 Support</h4>
<div class="paragraph">
<p><strong>Supported Features:</strong>
* CSS3 selectors (attribute selectors, pseudo-classes, pseudo-elements)
* CSS3 properties (flexbox, grid, transforms, animations, transitions)
* CSS3 media queries
* CSS3 variables (custom properties)
* CSS3 modules (as implemented by Chromium)</p>
</div>
<div class="paragraph">
<p><strong>Standards Compliance:</strong>
* Chromium&#8217;s CSS3 implementation (typically 90%+ compliance)
* Specific compliance level depends on Chromium version
* Document exact Chromium version and compliance level in application</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_engine_configuration">20.9. JavaScript Engine Configuration</h3>
<div class="sect3">
<h4 id="_v8_engine_features">20.9.1. V8 Engine Features</h4>
<div class="paragraph">
<p><strong>Supported ECMAScript Versions:</strong>
* ECMAScript 2022 (ES13) - Full support
* ECMAScript 2021 (ES12) - Full support
* ECMAScript 2020 (ES11) - Full support
* ECMAScript 2019 (ES10) - Full support
* ECMAScript 2018 (ES9) - Full support
* ECMAScript 2017 (ES8) - Full support
* ECMAScript 2016 (ES7) - Full support
* ECMAScript 2015 (ES6) - Full support</p>
</div>
<div class="paragraph">
<p><strong>JavaScript Features:</strong>
* Classes, modules (ES6 modules), async/await
* Promises, generators, iterators
* Arrow functions, template literals
* Destructuring, spread operator
* Proxy, Reflect, Symbol
* WebAssembly support</p>
</div>
<div class="paragraph">
<p><strong>V8 Engine Version Detection:</strong>
* Document exact V8 version at build time
* V8 version determined by Chromium version
* Can be queried at runtime (if needed): Check Qt WebEngine version information</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_additional_settings">20.10. Additional Settings</h3>
<div class="sect3">
<h4 id="_accessibility_settings">20.10.1. Accessibility Settings</h4>
<div class="paragraph">
<p><strong>Screen Reader Support:</strong>
* Enable accessibility features: <code>QWebEngineSettings::ScreenReaderEnabled</code>
* Ensure ARIA labels are properly rendered
* Support keyboard navigation</p>
</div>
<div class="paragraph">
<p><strong>High Contrast Mode:</strong>
* Respect system high contrast settings
* Apply high contrast CSS when system setting is enabled</p>
</div>
</div>
<div class="sect3">
<h4 id="_developer_tools_optional">20.10.2. Developer Tools (Optional)</h4>
<div class="paragraph">
<p><strong>Developer Console:</strong>
* Disable in production builds: <code>QWebEngineSettings::DeveloperExtrasEnabled = false</code>
* Enable in debug builds for development
* Access via: Right-click context menu or keyboard shortcut (if enabled)</p>
</div>
<div class="paragraph">
<p><strong>Remote Debugging:</strong>
* Disable in production (security risk)
* Enable only in development builds
* Use <code>QWebEngineProfile::setHttpUserAgent()</code> for identification</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sqlite_configuration_implementation">21. SQLite Configuration Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section specifies the detailed SQLite configuration for the Reader and Creator Tool applications, including version requirements, WAL mode configuration, database optimization settings, connection management, and maintenance operations.</p>
</div>
<div class="sect2">
<h3 id="_sqlite_version_requirements">21.1. SQLite Version Requirements</h3>
<div class="paragraph">
<p><strong>Minimum Version:</strong> SQLite 3.51</p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* SQLite 3.51 (released 2024) includes important bug fixes and performance improvements
* WAL mode improvements and checkpoint optimizations
* Better handling of large databases
* Enhanced foreign key constraint support
* Improved query optimizer</p>
</div>
<div class="paragraph">
<p><strong>Version Detection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::checkSQLiteVersion() {
    QSqlDatabase db = QSqlDatabase::database();
    QVariant versionVar = db.driver()-&gt;property("SQLiteVersion");
    QString sqliteVersion = versionVar.toString();

    qInfo() &lt;&lt; "SQLite version:" &lt;&lt; sqliteVersion;

    // Parse version string (format: "3.51.0" or similar)
    QStringList parts = sqliteVersion.split(".");
    if (parts.size() &gt;= 2) {
        int major = parts[0].toInt();
        int minor = parts[1].toInt();

        if (major &lt; 3 || (major == 3 &amp;&amp; minor &lt; 51)) {
            qCritical() &lt;&lt; "SQLite version" &lt;&lt; sqliteVersion
                        &lt;&lt; "is below minimum required version 3.51";
            // Display error dialog to user
            QMessageBox::critical(nullptr, "SQLite Version Error",
                QString("SQLite version %1 is below minimum required version 3.51.\n"
                       "Please update SQLite or contact support.").arg(sqliteVersion));
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Version Documentation:</strong>
* Log SQLite version at application startup
* Include version in About dialog (optional)
* Document version in application logs
* Store version information for debugging</p>
</div>
</div>
<div class="sect2">
<h3 id="_wal_mode_configuration">21.2. WAL Mode Configuration</h3>
<div class="sect3">
<h4 id="_wal_mode_overview">21.2.1. WAL Mode Overview</h4>
<div class="paragraph">
<p><strong>Write-Ahead Logging (WAL) Benefits:</strong>
* Better concurrency (readers don&#8217;t block writers, writers don&#8217;t block readers)
* Improved performance for mixed read/write workloads
* Reduced lock contention
* Better for multi-threaded applications
* Faster checkpoint operations</p>
</div>
<div class="paragraph">
<p><strong>WAL Mode Trade-offs:</strong>
* Slightly larger database files (WAL file exists alongside database)
* Requires checkpointing to maintain WAL file size
* WAL file must be present for database to function (both files needed)</p>
</div>
</div>
<div class="sect3">
<h4 id="_wal_mode_implementation">21.2.2. WAL Mode Implementation</h4>
<div class="paragraph">
<p><strong>Enable WAL Mode for Local Database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::enableWALMode() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Check current journal mode
    if (query.exec("PRAGMA journal_mode")) {
        if (query.next()) {
            QString mode = query.value(0).toString().toUpper();
            if (mode != "WAL") {
                // Enable WAL mode
                if (query.exec("PRAGMA journal_mode=WAL")) {
                    qInfo() &lt;&lt; "WAL mode enabled for local database";
                } else {
                    qWarning() &lt;&lt; "Failed to enable WAL mode:" &lt;&lt; query.lastError();
                }
            } else {
                qInfo() &lt;&lt; "Database already in WAL mode";
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Enable WAL Mode for Cartridge Files:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void CartridgeDBConnector::enableWALMode() {
    QSqlDatabase db = database();
    if (!isWritable()) {
        qInfo() &lt;&lt; "Cartridge is read-only, skipping WAL mode enable";
        return;
    }

    QSqlQuery query(db);
    if (query.exec("PRAGMA journal_mode=WAL")) {
        qInfo() &lt;&lt; "WAL mode enabled for cartridge";
    } else {
        qWarning() &lt;&lt; "Failed to enable WAL mode:" &lt;&lt; query.lastError();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>WAL Checkpoint Configuration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::configureWALCheckpoint() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Set WAL autocheckpoint threshold (1000 pages = ~4MB with 4KB pages)
    if (!query.exec("PRAGMA wal_autocheckpoint=1000")) {
        qWarning() &lt;&lt; "Failed to set WAL autocheckpoint:" &lt;&lt; query.lastError();
    }

    qInfo() &lt;&lt; "WAL autocheckpoint configured: 1000 pages";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>WAL File Size Monitoring and Manual Checkpoint:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">qint64 LocalDBManager::getWALFileSize() {
    QString dbPath = QSqlDatabase::database().databaseName();
    QString walPath = dbPath + "-wal";
    QFileInfo walFile(walPath);
    if (walFile.exists()) {
        return walFile.size();
    }
    return 0;
}

void LocalDBManager::checkWALSize() {
    qint64 walSize = getWALFileSize();
    const qint64 maxWALSize = 10 * 1024 * 1024; // 10MB

    if (walSize &gt; maxWALSize) {
        qInfo() &lt;&lt; "WAL file size:" &lt;&lt; walSize &lt;&lt; "bytes, performing checkpoint";
        performWALCheckpoint();
    }
}

void LocalDBManager::performWALCheckpoint() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Perform checkpoint (truncates WAL file)
    if (query.exec("PRAGMA wal_checkpoint(TRUNCATE)")) {
        qInfo() &lt;&lt; "WAL checkpoint completed";
    } else {
        qWarning() &lt;&lt; "WAL checkpoint failed:" &lt;&lt; query.lastError();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>WAL Checkpoint Strategy:</strong>
* Automatic checkpoint: When WAL file exceeds 10MB or 1000 pages written
* Manual checkpoint: After bulk operations, before backups
* Periodic checkpoint: During idle time (optional)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_database_optimization_configuration">21.3. Database Optimization Configuration</h3>
<div class="sect3">
<h4 id="_page_size_configuration">21.3.1. Page Size Configuration</h4>
<div class="paragraph">
<p><strong>Page Size: 4096 bytes (4KB)</strong></p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* 4KB matches modern OS page size (optimal for memory mapping)
* Good balance between performance and memory usage
* Standard size for most SQLite databases
* Optimal for cache efficiency</p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::createDatabase() {
    QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE", "LocalDB");
    db.setDatabaseName(localDatabasePath());

    if (!db.open()) {
        qCritical() &lt;&lt; "Failed to open local database";
        return;
    }

    QSqlQuery query(db);

    // Set page size (must be done before creating tables, only for new databases)
    if (!query.exec("PRAGMA page_size=4096")) {
        qWarning() &lt;&lt; "Failed to set page size:" &lt;&lt; query.lastError();
    }

    // Verify page size was set
    if (query.exec("PRAGMA page_size")) {
        if (query.next()) {
            int pageSize = query.value(0).toInt();
            qInfo() &lt;&lt; "Database page size:" &lt;&lt; pageSize &lt;&lt; "bytes";
        }
    }

    // Create schema...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Page size can only be set for new databases. Existing databases retain their original page size. To change page size of existing database, use <code>VACUUM INTO</code> (SQLite 3.27+).</p>
</div>
</div>
<div class="sect3">
<h4 id="_cache_size_configuration">21.3.2. Cache Size Configuration</h4>
<div class="paragraph">
<p><strong>Cache Size Settings:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::configureCache() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Set cache size to 2000 pages (8MB with 4KB pages)
    // Negative value = pages (absolute value in KB)
    if (!query.exec("PRAGMA cache_size=-2000")) {
        qWarning() &lt;&lt; "Failed to set cache size:" &lt;&lt; query.lastError();
    }

    // Verify cache size
    if (query.exec("PRAGMA cache_size")) {
        if (query.next()) {
            int cacheSize = query.value(0).toInt();
            qInfo() &lt;&lt; "Cache size configured:" &lt;&lt; cacheSize &lt;&lt; "pages";
        }
    }
}

void CartridgeDBConnector::configureCache() {
    QSqlDatabase db = database();
    QSqlQuery query(db);

    // Set cache size to 1000 pages (4MB with 4KB pages)
    if (!query.exec("PRAGMA cache_size=-1000")) {
        qWarning() &lt;&lt; "Failed to set cache size:" &lt;&lt; query.lastError();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Cache Size Rationale:</strong>
* Local database: 2000 pages (8MB) - larger cache for frequently accessed manifest data
* Cartridge files: 1000 pages (4MB) - smaller cache per cartridge, multiple cartridges may be open simultaneously
* Cache size is per-connection, so each cartridge connection has its own cache</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronous_configuration">21.3.3. Synchronous Configuration</h4>
<div class="paragraph">
<p><strong>Synchronous Mode: NORMAL (for WAL mode)</strong></p>
</div>
<div class="paragraph">
<p><strong>Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::configureSynchronous() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Set synchronous mode to NORMAL (safe with WAL mode)
    if (!query.exec("PRAGMA synchronous=NORMAL")) {
        qWarning() &lt;&lt; "Failed to set synchronous mode:" &lt;&lt; query.lastError();
    }

    // Verify synchronous mode
    if (query.exec("PRAGMA synchronous")) {
        if (query.next()) {
            int syncMode = query.value(0).toInt();
            // 1 = NORMAL, 2 = FULL, 0 = OFF
            qInfo() &lt;&lt; "Synchronous mode:" &lt;&lt; syncMode &lt;&lt; "(1=NORMAL)";
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Synchronous Mode Options:</strong>
* <code>OFF</code> (0) - Fastest but unsafe (data loss risk on power failure) - <strong>NOT RECOMMENDED</strong>
* <code>NORMAL</code> (1) - Safe with WAL mode, good performance - <strong>RECOMMENDED</strong>
* <code>FULL</code> (2) - Safest but slower - <strong>NOT NEEDED with WAL mode</strong></p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* WAL mode provides durability guarantees even with NORMAL synchronous mode
* NORMAL mode with WAL is safe and performant
* FULL mode adds unnecessary overhead with WAL (double-write protection not needed)</p>
</div>
</div>
<div class="sect3">
<h4 id="_foreign_key_constraints">21.3.4. Foreign Key Constraints</h4>
<div class="paragraph">
<p><strong>Enable Foreign Key Enforcement:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::enableForeignKeys() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    // Enable foreign key constraints (must be done per connection)
    if (!query.exec("PRAGMA foreign_keys=ON")) {
        qWarning() &lt;&lt; "Failed to enable foreign keys:" &lt;&lt; query.lastError();
        return;
    }

    // Verify foreign keys are enabled
    if (query.exec("PRAGMA foreign_keys")) {
        if (query.next()) {
            int enabled = query.value(0).toInt();
            if (enabled != 1) {
                qWarning() &lt;&lt; "Foreign keys not enabled (expected 1, got" &lt;&lt; enabled &lt;&lt; ")";
            } else {
                qInfo() &lt;&lt; "Foreign key constraints enabled";
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Foreign Key Benefits:</strong>
* Data integrity enforcement at database level
* Prevents orphaned records
* Automatic referential integrity checks
* Cascading deletes/updates (if defined in schema)</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Foreign keys must be enabled per connection (not persistent in database). Must be enabled after each connection is opened.</p>
</div>
</div>
<div class="sect3">
<h4 id="_query_optimizer_configuration">21.3.5. Query Optimizer Configuration</h4>
<div class="paragraph">
<p><strong>Enable Query Optimizer Statistics:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::updateStatistics() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    qInfo() &lt;&lt; "Updating query optimizer statistics";

    // Update query optimizer statistics
    if (!query.exec("ANALYZE")) {
        qWarning() &lt;&lt; "Failed to update statistics:" &lt;&lt; query.lastError();
    } else {
        qInfo() &lt;&lt; "Statistics updated successfully";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>When to Run ANALYZE:</strong>
* After bulk imports (cartridge imports)
* After significant data changes (bulk deletes, updates)
* Periodically (e.g., weekly) for local database
* After schema changes that affect indexes
* After VACUUM operations</p>
</div>
<div class="paragraph">
<p><strong>Automatic Statistics Update:</strong>
* Run ANALYZE after import operations complete
* Run ANALYZE after bulk deletes (e.g., cartridge deletion)
* Consider running during idle time (background task)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connection_configuration">21.4. Connection Configuration</h3>
<div class="sect3">
<h4 id="_connection_setup">21.4.1. Connection Setup</h4>
<div class="paragraph">
<p><strong>Local Database Connection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::initializeConnection() {
    QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE", "LocalDB");
    db.setDatabaseName(localDatabasePath());

    // Set connection options (optional)
    // db.setConnectOptions("QSQLITE_ENABLE_REGEXP"); // Enable regexp function

    // Set busy timeout (5 seconds)
    db.setConnectOptions("QSQLITE_BUSY_TIMEOUT=5000");

    if (!db.open()) {
        qCritical() &lt;&lt; "Failed to open local database:" &lt;&lt; db.lastError();
        return;
    }

    // Configure database settings
    enableWALMode();
    configureCache();
    configureSynchronous();
    enableForeignKeys();
    configureWALCheckpoint();

    qInfo() &lt;&lt; "Local database connection established and configured";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Cartridge Database Connection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void CartridgeDBConnector::openCartridge(const QString&amp; filePath) {
    QString connectionName = QString("Cartridge_%1").arg(QUuid::createUuid().toString());
    QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE", connectionName);
    db.setDatabaseName(filePath);

    // Set connection timeout (30 seconds) and busy timeout (5 seconds)
    db.setConnectOptions("QSQLITE_BUSY_TIMEOUT=5000");

    if (!db.open()) {
        qCritical() &lt;&lt; "Failed to open cartridge:" &lt;&lt; db.lastError();
        return;
    }

    // Configure database settings (if writable)
    if (isWritable()) {
        enableWALMode();
        configureCache();
        configureSynchronous();
        enableForeignKeys();
    }

    qInfo() &lt;&lt; "Cartridge database connection established:" &lt;&lt; filePath;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Connection Cleanup:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void CartridgeDBConnector::closeConnection() {
    QSqlDatabase db = database();
    QString connectionName = db.connectionName();

    db.close();
    QSqlDatabase::removeDatabase(connectionName);

    qInfo() &lt;&lt; "Cartridge database connection closed";
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_management">21.5. Transaction Management</h3>
<div class="sect3">
<h4 id="_transaction_usage">21.5.1. Transaction Usage</h4>
<div class="paragraph">
<p><strong>Form Data Save Transaction:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool CartridgeDBConnector::saveFormData(const QString&amp; formKey, const QJsonObject&amp; data) {
    QSqlDatabase db = database();

    if (!db.transaction()) {
        qWarning() &lt;&lt; "Failed to start transaction";
        return false;
    }

    try {
        QSqlQuery query(db);

        // Delete existing data
        query.prepare("DELETE FROM User_Data WHERE form_key = ?");
        query.addBindValue(formKey);
        if (!query.exec()) {
            throw std::runtime_error("Failed to delete existing data");
        }

        // Insert new data
        query.prepare("INSERT INTO User_Data (form_key, serialized_data, timestamp) VALUES (?, ?, ?)");
        query.addBindValue(formKey);
        query.addBindValue(QJsonDocument(data).toJson());
        query.addBindValue(QDateTime::currentDateTime().toSecsSinceEpoch());
        if (!query.exec()) {
            throw std::runtime_error("Failed to insert data");
        }

        if (!db.commit()) {
            throw std::runtime_error("Failed to commit transaction");
        }

        return true;
    } catch (const std::exception&amp; e) {
        db.rollback();
        qWarning() &lt;&lt; "Transaction rolled back:" &lt;&lt; e.what();
        return false;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Atomic Cartridge Deletion:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool LocalDBManager::deleteCartridge(const QString&amp; cartridgeGuid) {
    QSqlDatabase db = QSqlDatabase::database();

    if (!db.transaction()) {
        qWarning() &lt;&lt; "Failed to start transaction";
        return false;
    }

    try {
        QSqlQuery query(db);

        // Delete from manifest
        query.prepare("DELETE FROM Local_Library_Manifest WHERE cartridge_guid = ?");
        query.addBindValue(cartridgeGuid);
        if (!query.exec()) {
            throw std::runtime_error("Failed to delete from manifest");
        }

        // Delete from trust registry
        query.prepare("DELETE FROM Local_Trust_Registry WHERE cartridge_guid = ?");
        query.addBindValue(cartridgeGuid);
        if (!query.exec()) {
            throw std::runtime_error("Failed to delete from trust registry");
        }

        if (!db.commit()) {
            throw std::runtime_error("Failed to commit transaction");
        }

        return true;
    } catch (const std::exception&amp; e) {
        db.rollback();
        qWarning() &lt;&lt; "Transaction rolled back:" &lt;&lt; e.what();
        return false;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_savepoint_usage">21.5.2. Savepoint Usage</h4>
<div class="paragraph">
<p><strong>Form Version Migration with Savepoints:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool CartridgeDBConnector::migrateFormData(const QString&amp; formKey, int fromVersion, int toVersion) {
    QSqlDatabase db = database();

    if (!db.transaction()) {
        return false;
    }

    QSqlQuery query(db);

    // Create savepoint
    if (!query.exec("SAVEPOINT migration")) {
        db.rollback();
        return false;
    }

    try {
        // Step 1: Load existing data
        // Step 2: Transform data
        // Step 3: Validate transformed data
        // If any step fails, rollback to savepoint

        // Release savepoint (all steps succeeded)
        if (!query.exec("RELEASE SAVEPOINT migration")) {
            throw std::runtime_error("Failed to release savepoint");
        }

        if (!db.commit()) {
            throw std::runtime_error("Failed to commit transaction");
        }

        return true;
    } catch (const std::exception&amp; e) {
        // Rollback to savepoint (partial rollback)
        query.exec("ROLLBACK TO SAVEPOINT migration");
        db.rollback();
        qWarning() &lt;&lt; "Migration rolled back:" &lt;&lt; e.what();
        return false;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_database_maintenance">21.6. Database Maintenance</h3>
<div class="sect3">
<h4 id="_vacuum_operation">21.6.1. Vacuum Operation</h4>
<div class="paragraph">
<p><strong>Vacuum Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void LocalDBManager::vacuumDatabase() {
    QSqlDatabase db = QSqlDatabase::database();
    QSqlQuery query(db);

    qInfo() &lt;&lt; "Starting VACUUM operation";

    // VACUUM requires exclusive lock
    if (query.exec("VACUUM")) {
        qInfo() &lt;&lt; "VACUUM completed successfully";

        // Update statistics after vacuum
        query.exec("ANALYZE");
    } else {
        qWarning() &lt;&lt; "VACUUM failed:" &lt;&lt; query.lastError();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>When to Run VACUUM:</strong>
* After large deletions (e.g., bulk cartridge deletion)
* Periodically (e.g., monthly) for local database
* When database file size is significantly larger than data size
* User-initiated optimization (Settings → Optimize Database)</p>
</div>
<div class="paragraph">
<p><strong>VACUUM Considerations:</strong>
* Requires exclusive database lock (blocks all other operations)
* Can take time for large databases (show progress if possible)
* Reduces database file size by removing free space
* Rebuilds entire database file (creates new file, replaces old)</p>
</div>
</div>
<div class="sect3">
<h4 id="_integrity_checks">21.6.2. Integrity Checks</h4>
<div class="paragraph">
<p><strong>Quick Integrity Check:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool CartridgeDBConnector::quickIntegrityCheck() {
    QSqlDatabase db = database();
    QSqlQuery query(db);

    if (query.exec("PRAGMA quick_check")) {
        if (query.next()) {
            QString result = query.value(0).toString();
            if (result == "ok") {
                qInfo() &lt;&lt; "Quick integrity check passed";
                return true;
            } else {
                qWarning() &lt;&lt; "Quick check failed:" &lt;&lt; result;
                return false;
            }
        }
    }
    return false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Full Integrity Check:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool CartridgeDBConnector::fullIntegrityCheck() {
    QSqlDatabase db = database();
    QSqlQuery query(db);

    qInfo() &lt;&lt; "Starting full integrity check";

    if (query.exec("PRAGMA integrity_check")) {
        QStringList errors;
        while (query.next()) {
            QString result = query.value(0).toString();
            if (result == "ok") {
                qInfo() &lt;&lt; "Full integrity check passed";
                return true;
            } else {
                errors &lt;&lt; result;
            }
        }

        if (!errors.isEmpty()) {
            qCritical() &lt;&lt; "Integrity check failed:" &lt;&lt; errors;
            return false;
        }
    }
    return false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Integrity Check Strategy:</strong>
* Quick check on cartridge open (fast, catches most issues)
* Full check when corruption is suspected (slower, comprehensive)
* Log all integrity check results
* Display error to user if corruption detected</p>
</div>
</div>
<div class="sect3">
<h4 id="_backup_and_restore">21.6.3. Backup and Restore</h4>
<div class="paragraph">
<p><strong>Backup Implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">bool LocalDBManager::backupDatabase(const QString&amp; backupPath) {
    QSqlDatabase db = QSqlDatabase::database();
    QString dbPath = db.databaseName();

    QSqlQuery query(db);

    // Use VACUUM INTO (SQLite 3.27+) for backup
    QString vacuumSql = QString("VACUUM INTO '%1'").arg(backupPath);
    if (query.exec(vacuumSql)) {
        qInfo() &lt;&lt; "Database backed up to:" &lt;&lt; backupPath;
        return true;
    } else {
        qWarning() &lt;&lt; "Backup failed:" &lt;&lt; query.lastError();
        return false;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Backup Strategy:</strong>
* Create backup before schema migrations
* Create backup before major operations (bulk deletes, etc.)
* Store backups in backup directory: <code>{app_data}/backups/</code>
* Backup naming: <code>local_reader.sqlite.backup.YYYY-MM-DD_HH-MM-SS</code>
* Retain backups for 7 days
* Automatic cleanup of old backups</p>
</div>
<div class="paragraph">
<p><strong>Backup Directory:</strong>
* Windows: <code>%APPDATA%\SmartBook\backups\</code>
* macOS: <code>~/Library/Application Support/SmartBook/backups/</code>
* Linux: <code>~/.local/share/SmartBook/backups/</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_platform_specific_considerations_implementation">22. Platform-Specific Considerations Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section specifies platform-specific implementation details for the Reader and Creator Tool applications, including platform detection, UI framework configuration, secure storage, certificate validation, universal binary support, and file associations.</p>
</div>
<div class="sect2">
<h3 id="_platform_detection_and_configuration">22.1. Platform Detection and Configuration</h3>
<div class="paragraph">
<p><strong>Platform Detection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;QtGlobal&gt;

enum class Platform {
    Windows,
    macOS,
    Linux
};

Platform getPlatform() {
#ifdef Q_OS_WIN
    return Platform::Windows;
#elif defined(Q_OS_MACOS)
    return Platform::macOS;
#elif defined(Q_OS_LINUX)
    return Platform::Linux;
#else
    #error "Unsupported platform"
#endif
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Architecture Detection:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;QtGlobal&gt;

enum class Architecture {
    X86_64,
    ARM64,
    Unknown
};

Architecture getArchitecture() {
#if defined(Q_PROCESSOR_X86_64)
    return Architecture::X86_64;
#elif defined(Q_PROCESSOR_ARM_64) || defined(Q_PROCESSOR_ARM_V8)
    return Architecture::ARM64;
#else
    return Architecture::Unknown;
#endif
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_qt_fusion_widget_set_configuration">22.2. Qt Fusion Widget Set Configuration</h3>
<div class="paragraph">
<p><strong>Apply Fusion Style:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;QApplication&gt;
#include &lt;QStyleFactory&gt;

void applyFusionStyle(QApplication* app) {
    // Set Fusion style for uniform appearance
    app-&gt;setStyle(QStyleFactory::create("Fusion"));

    // Optional: Apply custom palette for theming
    QPalette palette;
    palette.setColor(QPalette::Window, QColor(240, 240, 240));
    palette.setColor(QPalette::WindowText, QColor(0, 0, 0));
    palette.setColor(QPalette::Base, QColor(255, 255, 255));
    palette.setColor(QPalette::AlternateBase, QColor(245, 245, 245));
    palette.setColor(QPalette::ToolTipBase, QColor(255, 255, 220));
    palette.setColor(QPalette::ToolTipText, QColor(0, 0, 0));
    palette.setColor(QPalette::Text, QColor(0, 0, 0));
    palette.setColor(QPalette::Button, QColor(240, 240, 240));
    palette.setColor(QPalette::ButtonText, QColor(0, 0, 0));
    palette.setColor(QPalette::BrightText, QColor(255, 0, 0));
    palette.setColor(QPalette::Link, QColor(0, 0, 255));
    palette.setColor(QPalette::Highlight, QColor(0, 120, 215));
    palette.setColor(QPalette::HighlightedText, QColor(255, 255, 255));

    app-&gt;setPalette(palette);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Application Initialization:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">int main(int argc, char *argv[]) {
    QApplication app(argc, argv);

    // Apply Fusion style for uniform appearance
    applyFusionStyle(&amp;app);

    // Platform-specific initialization
    Platform platform = getPlatform();
    switch (platform) {
        case Platform::macOS:
            // macOS-specific initialization
            // Set up menu bar integration
            break;
        case Platform::Windows:
            // Windows-specific initialization
            // Set up system tray (if needed)
            break;
        case Platform::Linux:
            // Linux-specific initialization
            // Set up system tray (if needed)
            break;
    }

    // Continue application startup...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_platform_specific_data_directories">22.3. Platform-Specific Data Directories</h3>
<div class="paragraph">
<p><strong>Directory Path Resolution:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;QStandardPaths&gt;
#include &lt;QDir&gt;

QString getApplicationDataDirectory() {
    QString basePath = QStandardPaths::writableLocation(QStandardPaths::AppDataLocation);

    // Ensure directory exists
    QDir dir(basePath);
    if (!dir.exists()) {
        dir.mkpath(".");
    }

    return basePath;
}

QString getCacheDirectory() {
    QString cachePath = QStandardPaths::writableLocation(QStandardPaths::CacheLocation);
    QDir dir(cachePath);
    if (!dir.exists()) {
        dir.mkpath(".");
    }
    return cachePath;
}

QString getLogDirectory() {
    QString logPath = getApplicationDataDirectory() + "/logs";
    QDir dir(logPath);
    if (!dir.exists()) {
        dir.mkpath(".");
    }
    return logPath;
}

QString getBackupDirectory() {
    QString backupPath = getApplicationDataDirectory() + "/backups";
    QDir dir(backupPath);
    if (!dir.exists()) {
        dir.mkpath(".");
    }
    return backupPath;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Platform-Specific Paths:</strong>
* <strong>Windows:</strong>
  * Application Data: <code>%APPDATA%\SmartBook\</code> (via <code>QStandardPaths::AppDataLocation</code>)
  * Cache: <code>%LOCALAPPDATA%\SmartBook\cache\</code> (via <code>QStandardPaths::CacheLocation</code>)
* <strong>macOS:</strong>
  * Application Data: <code>~/Library/Application Support/SmartBook/</code> (via <code>QStandardPaths::AppDataLocation</code>)
  * Cache: <code>~/Library/Caches/SmartBook/</code> (via <code>QStandardPaths::CacheLocation</code>)
* <strong>Linux:</strong>
  * Application Data: <code>~/.local/share/SmartBook/</code> (via <code>QStandardPaths::AppDataLocation</code>)
  * Cache: <code>~/.cache/SmartBook/</code> (via <code>QStandardPaths::CacheLocation</code>)</p>
</div>
</div>
<div class="sect2">
<h3 id="_platform_specific_secure_storage">22.4. Platform-Specific Secure Storage</h3>
<div class="paragraph">
<p><strong>Secure Storage Interface:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class SecureStorage {
public:
    static bool storeCredential(const QString&amp; key, const QString&amp; value);
    static QString retrieveCredential(const QString&amp; key);
    static bool deleteCredential(const QString&amp; key);

private:
    static QString getServiceName() { return "SmartBook"; }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Windows Implementation (Credential Manager):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#ifdef Q_OS_WIN
#include &lt;windows.h&gt;
#include &lt;wincred.h&gt;

bool SecureStorage::storeCredential(const QString&amp; key, const QString&amp; value) {
    QString targetName = getServiceName() + "/" + key;
    QByteArray targetNameUtf8 = targetName.toUtf8();
    QByteArray valueUtf8 = value.toUtf8();

    CREDENTIAL cred = {0};
    cred.Type = CRED_TYPE_GENERIC;
    cred.TargetName = const_cast&lt;LPSTR&gt;(targetNameUtf8.data());
    cred.CredentialBlobSize = valueUtf8.size();
    cred.CredentialBlob = reinterpret_cast&lt;LPBYTE&gt;(const_cast&lt;char*&gt;(valueUtf8.data()));
    cred.Persist = CRED_PERSIST_LOCAL_MACHINE;
    cred.UserName = const_cast&lt;LPSTR&gt;("SmartBook");

    return CredWrite(&amp;cred, 0) == TRUE;
}

QString SecureStorage::retrieveCredential(const QString&amp; key) {
    QString targetName = getServiceName() + "/" + key;
    QByteArray targetNameUtf8 = targetName.toUtf8();

    PCREDENTIAL cred = nullptr;
    if (CredRead(targetNameUtf8.data(), CRED_TYPE_GENERIC, 0, &amp;cred)) {
        QByteArray blob(reinterpret_cast&lt;const char*&gt;(cred-&gt;CredentialBlob),
                       cred-&gt;CredentialBlobSize);
        CredFree(cred);
        return QString::fromUtf8(blob);
    }
    return QString();
}
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>macOS Implementation (Keychain):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#ifdef Q_OS_MACOS
#include &lt;Security/Security.h&gt;

bool SecureStorage::storeCredential(const QString&amp; key, const QString&amp; value) {
    QString service = getServiceName();
    QByteArray serviceUtf8 = service.toUtf8();
    QByteArray keyUtf8 = key.toUtf8();
    QByteArray valueUtf8 = value.toUtf8();

    OSStatus status = SecKeychainAddGenericPassword(
        nullptr,
        serviceUtf8.length(),
        serviceUtf8.data(),
        keyUtf8.length(),
        keyUtf8.data(),
        valueUtf8.length(),
        valueUtf8.data(),
        nullptr
    );

    // If item exists, update it
    if (status == errSecDuplicateItem) {
        SecKeychainItemRef itemRef = nullptr;
        status = SecKeychainFindGenericPassword(
            nullptr,
            serviceUtf8.length(),
            serviceUtf8.data(),
            keyUtf8.length(),
            keyUtf8.data(),
            nullptr,
            nullptr,
            &amp;itemRef
        );

        if (status == errSecSuccess) {
            status = SecKeychainItemModifyContent(
                itemRef,
                nullptr,
                valueUtf8.length(),
                valueUtf8.data()
            );
            CFRelease(itemRef);
        }
    }

    return status == errSecSuccess;
}

QString SecureStorage::retrieveCredential(const QString&amp; key) {
    QString service = getServiceName();
    QByteArray serviceUtf8 = service.toUtf8();
    QByteArray keyUtf8 = key.toUtf8();

    void* passwordData = nullptr;
    UInt32 passwordLength = 0;

    OSStatus status = SecKeychainFindGenericPassword(
        nullptr,
        serviceUtf8.length(),
        serviceUtf8.data(),
        keyUtf8.length(),
        keyUtf8.data(),
        &amp;passwordLength,
        &amp;passwordData,
        nullptr
    );

    if (status == errSecSuccess) {
        QByteArray password(reinterpret_cast&lt;const char*&gt;(passwordData), passwordLength);
        SecKeychainItemFreeContent(nullptr, passwordData);
        return QString::fromUtf8(password);
    }

    return QString();
}
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux Implementation (libsecret):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#ifdef Q_OS_LINUX
#include &lt;libsecret/secret.h&gt;

bool SecureStorage::storeCredential(const QString&amp; key, const QString&amp; value) {
    const SecretSchema* schema = secret_schema_new(
        "com.smartbook.credential",
        SECRET_SCHEMA_DONT_MATCH_NAME,
        "key", SECRET_SCHEMA_ATTRIBUTE_STRING,
        nullptr
    );

    GError* error = nullptr;
    secret_password_store_sync(
        schema,
        SECRET_COLLECTION_DEFAULT,
        getServiceName().toUtf8().constData(),
        value.toUtf8().constData(),
        nullptr,
        &amp;error,
        "key", key.toUtf8().constData(),
        nullptr
    );

    secret_schema_unref(schema);

    if (error) {
        g_error_free(error);
        return false;
    }

    return true;
}

QString SecureStorage::retrieveCredential(const QString&amp; key) {
    const SecretSchema* schema = secret_schema_new(
        "com.smartbook.credential",
        SECRET_SCHEMA_DONT_MATCH_NAME,
        "key", SECRET_SCHEMA_ATTRIBUTE_STRING,
        nullptr
    );

    GError* error = nullptr;
    gchar* password = secret_password_lookup_sync(
        schema,
        nullptr,
        &amp;error,
        "key", key.toUtf8().constData(),
        nullptr
    );

    secret_schema_unref(schema);

    if (error) {
        g_error_free(error);
        return QString();
    }

    if (password) {
        QString result = QString::fromUtf8(password);
        secret_password_free(password);
        return result;
    }

    return QString();
}
#endif</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_certificate_validation">22.5. Certificate Validation</h3>
<div class="paragraph">
<p><strong>Platform-Specific Certificate Store:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;QSslSocket&gt;
#include &lt;QSslCertificate&gt;

void configureCertificateValidation() {
    Platform platform = getPlatform();

    switch (platform) {
        case Platform::Windows:
            // Windows uses Windows Certificate Store automatically via Qt
            // QSslSocket::defaultCaCertificates() uses system store
            break;
        case Platform::macOS:
            // macOS uses Keychain automatically via Qt
            // QSslSocket::defaultCaCertificates() uses system store
            break;
        case Platform::Linux:
            // Linux: Use system CA bundle
            QStringList possiblePaths = {
                "/etc/ssl/certs/ca-certificates.crt",
                "/etc/pki/tls/certs/ca-bundle.crt",
                "/usr/share/ca-certificates/ca-certificates.crt"
            };

            QString caBundlePath;
            for (const QString&amp; path : possiblePaths) {
                if (QFile::exists(path)) {
                    caBundlePath = path;
                    break;
                }
            }

            if (!caBundlePath.isEmpty()) {
                QList&lt;QSslCertificate&gt; certs = QSslCertificate::fromPath(caBundlePath);
                QSslSocket::setDefaultCaCertificates(certs);
            }
            break;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_universal_binary_support_macos">22.6. Universal Binary Support (macOS)</h3>
<div class="paragraph">
<p><strong>CMake Configuration for Universal Binary:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">if(APPLE)
    # Check if building for universal binary
    if(CMAKE_OSX_ARCHITECTURES)
        # Already specified
    else
        # Set to build universal binary (ARM64 + X86_64)
        set(CMAKE_OSX_ARCHITECTURES "arm64;x86_64")
    endif()

    # Set minimum macOS version
    set(CMAKE_OSX_DEPLOYMENT_TARGET "26.1")

    # Code signing (if certificate available)
    set(CMAKE_OSX_CODE_SIGN_IDENTITY "Developer ID Application")
endif()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Verify Universal Binary:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Verify architectures in binary
lipo -info build/SmartBook.app/Contents/MacOS/SmartBook

# Expected output:
# Architectures in the fat file: build/SmartBook.app/Contents/MacOS/SmartBook are: arm64 x86_64</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_associations">22.7. File Associations</h3>
<div class="paragraph">
<p><strong>Windows File Association (Registry):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-reg" data-lang="reg">Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\Software\Classes\.sqlite]
@="SmartBook.Cartridge"

[HKEY_CURRENT_USER\Software\Classes\SmartBook.Cartridge]
@="SmartBook Cartridge"

[HKEY_CURRENT_USER\Software\Classes\SmartBook.Cartridge\DefaultIcon]
@="C:\\Program Files\\SmartBook\\SmartBook.exe,0"

[HKEY_CURRENT_USER\Software\Classes\SmartBook.Cartridge\shell\open\command]
@="\"C:\\Program Files\\SmartBook\\SmartBook.exe\" \"%1\""</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>macOS File Association (Info.plist):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;key&gt;CFBundleDocumentTypes&lt;/key&gt;
&lt;array&gt;
    &lt;dict&gt;
        &lt;key&gt;CFBundleTypeExtensions&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;sqlite&lt;/string&gt;
        &lt;/array&gt;
        &lt;key&gt;CFBundleTypeIconFile&lt;/key&gt;
        &lt;string&gt;CartridgeIcon&lt;/string&gt;
        &lt;key&gt;CFBundleTypeName&lt;/key&gt;
        &lt;string&gt;SmartBook Cartridge&lt;/string&gt;
        &lt;key&gt;CFBundleTypeRole&lt;/key&gt;
        &lt;string&gt;Viewer&lt;/string&gt;
        &lt;key&gt;LSItemContentTypes&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;com.smartbook.cartridge&lt;/string&gt;
        &lt;/array&gt;
    &lt;/dict&gt;
&lt;/array&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux File Association (.desktop file):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[Desktop Entry]
Version=1.0
Type=Application
Name=SmartBook
Comment=SmartBook Cartridge Reader
Exec=/usr/bin/smartbook %f
Icon=smartbook
MimeType=application/x-sqlite3;application/vnd.sqlite3;
Terminal=false
Categories=Office;Viewer;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_url_scheme_handling">22.8. URL Scheme Handling</h3>
<div class="paragraph">
<p><strong>macOS URL Scheme (Info.plist):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;key&gt;CFBundleURLTypes&lt;/key&gt;
&lt;array&gt;
    &lt;dict&gt;
        &lt;key&gt;CFBundleURLName&lt;/key&gt;
        &lt;string&gt;com.smartbook.cartridge&lt;/string&gt;
        &lt;key&gt;CFBundleURLSchemes&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;smartbook&lt;/string&gt;
        &lt;/array&gt;
    &lt;/dict&gt;
&lt;/array&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Windows URL Scheme (Registry):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-reg" data-lang="reg">Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\Software\Classes\smartbook]
@="URL:SmartBook Protocol"
"URL Protocol"=""

[HKEY_CURRENT_USER\Software\Classes\smartbook\shell\open\command]
@="\"C:\\Program Files\\SmartBook\\SmartBook.exe\" \"%1\""</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux URL Scheme (.desktop file):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[Desktop Entry]
...
MimeType=application/x-sqlite3;application/vnd.sqlite3;x-scheme-handler/smartbook;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_series_and_edition_grouping_implementation">23. Series and Edition Grouping Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how series, edition, and custom collection grouping is implemented in the Reader application.</p>
</div>
<div class="sect2">
<h3 id="_series_and_edition_metadata">23.1. Series and Edition Metadata</h3>
<div class="paragraph">
<p><strong>Metadata Fields:</strong>
* <code>series_name</code> (TEXT, nullable): Series identifier (e.g., "Lensman Series")
* <code>edition_name</code> (TEXT, nullable): Edition identifier (e.g., "Classic Traveller")
* <code>series_order</code> (INTEGER, nullable): Position within series for ordering</p>
</div>
<div class="paragraph">
<p><strong>Metadata Usage:</strong>
* Metadata fields are set by Creator Tool during cartridge creation/editing
* Metadata fields are read by Library Manager for auto-grouping
* Metadata fields are stored in cartridge database (portable across systems)</p>
</div>
</div>
<div class="sect2">
<h3 id="_auto_grouping_by_series">23.2. Auto-Grouping by Series</h3>
<div class="paragraph">
<p><strong>Series Detection:</strong>
. On library load or cartridge import, query <code>Local_Library_Manifest</code>:
   <code>SELECT DISTINCT series_name FROM Local_Library_Manifest WHERE series_name IS NOT NULL</code>
. For each unique <code>series_name</code>, create or update <code>Local_Cartridge_Groups</code> entry:
   * <code>group_type</code> = "series"
   * <code>group_name</code> = series_name
   * Auto-created groups are read-only (managed by system)</p>
</div>
<div class="paragraph">
<p><strong>Series Membership:</strong>
. Query cartridges for series:
   <code>SELECT cartridge_guid FROM Local_Library_Manifest WHERE series_name = ?</code>
. For each cartridge, ensure membership in series group:
   * Query <code>Local_Cartridge_Group_Members</code> for existing membership
   * If not exists, insert membership record
   * Use <code>series_order</code> from metadata for <code>display_order</code> (if available)</p>
</div>
<div class="paragraph">
<p><strong>Series Display:</strong>
. Load series groups: <code>SELECT * FROM Local_Cartridge_Groups WHERE group_type = 'series' ORDER BY group_name</code>
. For selected series, load members:
   <code>`
   SELECT m.*, g.display_order
   FROM Local_Library_Manifest m
   JOIN Local_Cartridge_Group_Members gm ON m.cartridge_guid = gm.cartridge_guid
   JOIN Local_Cartridge_Groups g ON gm.group_id = g.group_id
   WHERE g.group_name = ? AND g.group_type = 'series'
   ORDER BY COALESCE(g.display_order, m.series_order, m.title)
   </code>`</p>
</div>
</div>
<div class="sect2">
<h3 id="_auto_grouping_by_edition">23.3. Auto-Grouping by Edition</h3>
<div class="paragraph">
<p><strong>Edition Detection:</strong>
. On library load or cartridge import, query <code>Local_Library_Manifest</code>:
   <code>SELECT DISTINCT edition_name FROM Local_Library_Manifest WHERE edition_name IS NOT NULL</code>
. For each unique <code>edition_name</code>, create or update <code>Local_Cartridge_Groups</code> entry:
   * <code>group_type</code> = "edition"
   * <code>group_name</code> = edition_name
   * Auto-created groups are read-only (managed by system)</p>
</div>
<div class="paragraph">
<p><strong>Edition Membership:</strong>
. Query cartridges for edition:
   <code>SELECT cartridge_guid FROM Local_Library_Manifest WHERE edition_name = ?</code>
. For each cartridge, ensure membership in edition group:
   * Query <code>Local_Cartridge_Group_Members</code> for existing membership
   * If not exists, insert membership record
   * <code>display_order</code> is NULL (alphabetical by title)</p>
</div>
<div class="paragraph">
<p><strong>Edition Display:</strong>
. Load edition groups: <code>SELECT * FROM Local_Cartridge_Groups WHERE group_type = 'edition' ORDER BY group_name</code>
. For selected edition, load members:
   <code>`
   SELECT m.*
   FROM Local_Library_Manifest m
   JOIN Local_Cartridge_Group_Members gm ON m.cartridge_guid = gm.cartridge_guid
   JOIN Local_Cartridge_Groups g ON gm.group_id = g.group_id
   WHERE g.group_name = ? AND g.group_type = 'edition'
   ORDER BY m.title
   </code>`</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_collections">23.4. Custom Collections</h3>
<div class="paragraph">
<p><strong>Create Custom Collection:</strong>
. User provides collection name (and optional description)
. Insert into <code>Local_Cartridge_Groups</code>:
   <code><code>sql
   INSERT INTO Local_Cartridge_Groups (group_name, group_type, created_timestamp, last_modified_timestamp, description)
   VALUES (?, 'custom_collection', ?, ?, ?)
   </code></code>
. Return <code>group_id</code> for adding members</p>
</div>
<div class="paragraph">
<p><strong>Add Cartridge to Collection:</strong>
. User selects cartridge(s) and target collection
. For each cartridge, insert into <code>Local_Cartridge_Group_Members</code>:
   <code><code>sql
   INSERT INTO Local_Cartridge_Group_Members (group_id, cartridge_guid, added_timestamp, display_order)
   VALUES (?, ?, ?, ?)
   </code></code>
. Update collection&#8217;s <code>last_modified_timestamp</code></p>
</div>
<div class="paragraph">
<p><strong>Remove Cartridge from Collection:</strong>
. User selects cartridge and collection
. Delete membership:
   <code><code>sql
   DELETE FROM Local_Cartridge_Group_Members
   WHERE group_id = ? AND cartridge_guid = ?
   </code></code>
. Update collection&#8217;s <code>last_modified_timestamp</code></p>
</div>
<div class="paragraph">
<p><strong>Rename Custom Collection:</strong>
. User provides new name
. Update <code>Local_Cartridge_Groups</code>:
   <code><code>sql
   UPDATE Local_Cartridge_Groups
   SET group_name = ?, last_modified_timestamp = ?
   WHERE group_id = ? AND group_type = 'custom_collection'
   </code></code></p>
</div>
<div class="paragraph">
<p><strong>Delete Custom Collection:</strong>
. User confirms deletion
. Delete all memberships:
   <code><code>sql
   DELETE FROM Local_Cartridge_Group_Members WHERE group_id = ?
   </code></code>
. Delete collection:
   <code><code>sql
   DELETE FROM Local_Cartridge_Groups WHERE group_id = ? AND group_type = 'custom_collection'
   </code></code></p>
</div>
<div class="paragraph">
<p><strong>Display Custom Collection:</strong>
. Load collection: <code>SELECT * FROM Local_Cartridge_Groups WHERE group_id = ?</code>
. Load members:
   <code>`
   SELECT m.*, gm.display_order
   FROM Local_Library_Manifest m
   JOIN Local_Cartridge_Group_Members gm ON m.cartridge_guid = gm.cartridge_guid
   WHERE gm.group_id = ?
   ORDER BY COALESCE(gm.display_order, m.title)
   </code>`</p>
</div>
</div>
<div class="sect2">
<h3 id="_grouping_ui_implementation">23.5. Grouping UI Implementation</h3>
<div class="paragraph">
<p><strong>Browse by Series View:</strong>
. Display list of all series (from <code>Local_Cartridge_Groups</code> where <code>group_type = 'series'</code>)
. User selects series
. Display all cartridges in series (ordered by <code>series_order</code> or title)
. User can open cartridges from series view</p>
</div>
<div class="paragraph">
<p><strong>Browse by Edition View:</strong>
. Display list of all editions (from <code>Local_Cartridge_Groups</code> where <code>group_type = 'edition'</code>)
. User selects edition
. Display all cartridges in edition (ordered alphabetically by title)
. User can open cartridges from edition view</p>
</div>
<div class="paragraph">
<p><strong>Custom Collections View:</strong>
. Display list of all custom collections (from <code>Local_Cartridge_Groups</code> where <code>group_type = 'custom_collection'</code>)
. User can:
   * Create new collection
   * Select collection to view members
   * Add/remove cartridges from collection
   * Rename/delete collection</p>
</div>
<div class="paragraph">
<p><strong>Grouping Filters:</strong>
. Add filter dropdown or sidebar to Library Manager
. Filter options:
   * "All Cartridges" (default)
   * "By Series" (shows series list)
   * "By Edition" (shows edition list)
   * "Custom Collections" (shows user collections)
. When filter selected, update library view to show filtered content</p>
</div>
<div class="paragraph">
<p><strong>Search by Series/Edition:</strong>
. Add search field with autocomplete
. Search suggestions include:
   * Series names
   * Edition names
   * Custom collection names
. On selection, filter library view to matching group</p>
</div>
</div>
<div class="sect2">
<h3 id="_grouping_maintenance">23.6. Grouping Maintenance</h3>
<div class="paragraph">
<p><strong>On Cartridge Import:</strong>
. After importing cartridge, check metadata for <code>series_name</code> and <code>edition_name</code>
. If <code>series_name</code> present:
   * Ensure series group exists in <code>Local_Cartridge_Groups</code>
   * Add cartridge to series group membership
. If <code>edition_name</code> present:
   * Ensure edition group exists in <code>Local_Cartridge_Groups</code>
   * Add cartridge to edition group membership</p>
</div>
<div class="paragraph">
<p><strong>On Cartridge Deletion:</strong>
. Before deleting cartridge, remove from all group memberships:
   <code><code>sql
   DELETE FROM Local_Cartridge_Group_Members WHERE cartridge_guid = ?
   </code></code>
. Delete cartridge from library
. If series/edition group becomes empty, optionally remove group (or keep for future imports)</p>
</div>
<div class="paragraph">
<p><strong>On Cartridge Metadata Update:</strong>
. If <code>series_name</code> or <code>edition_name</code> changes:
   * Remove from old group memberships
   * Add to new group memberships (if applicable)
. If <code>series_order</code> changes:
   * Update <code>display_order</code> in group membership (for series groups)</p>
</div>
</div>
<div class="sect2">
<h3 id="_performance_considerations">23.7. Performance Considerations</h3>
<div class="paragraph">
<p><strong>Grouping Queries:</strong>
* All grouping queries use <code>Local_Library_Manifest</code> (fast, indexed)
* Group memberships are cached or queried efficiently
* Grouping operations complete within &lt; 500ms (NFR-3.1)</p>
</div>
<div class="paragraph">
<p><strong>Indexes:</strong>
* Index on <code>Local_Cartridge_Groups.group_type</code> for filtering
* Index on <code>Local_Cartridge_Group_Members(group_id, cartridge_guid)</code> for membership queries
* Index on <code>Local_Library_Manifest.series_name</code> and <code>edition_name</code> for auto-grouping</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_help_system_and_user_manual_implementation">24. Help System and User Manual Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section specifies the implementation of the help system and user manual for both Reader and Creator Tool applications.</p>
</div>
<div class="sect2">
<h3 id="_help_system_architecture">24.1. Help System Architecture</h3>
<div class="paragraph">
<p><strong>Help Content Structure:</strong>
* <strong>Source Format:</strong> AsciiDoc source documents (single source of truth)
* <strong>HTML Output:</strong> Generated HTML for integrated help viewer
* <strong>PDF Output:</strong> Generated PDF for distribution and offline reading
* <strong>Content Location:</strong> <code>{install_dir}/help/</code> or <code>{install_dir}/Resources/help/</code> (macOS)</p>
</div>
<div class="paragraph">
<p><strong>Help Content Organization:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>help/
├── index.html (or index.adoc)
├── getting-started/
│   ├── installation.html
│   ├── first-launch.html
│   └── basic-operations.html
├── reader/
│   ├── library-management.html
│   ├── reading.html
│   ├── navigation.html
│   ├── search.html
│   ├── forms.html
│   └── embedded-apps.html
├── creator/
│   ├── content-authoring.html
│   ├── form-building.html
│   ├── cartridge-creation.html
│   ├── signing.html
│   └── export.html
├── security/
│   ├── trust-levels.html
│   ├── consent-dialogs.html
│   └── certificates.html
├── reference/
│   ├── keyboard-shortcuts.html
│   └── faq.html
└── troubleshooting/
    └── common-issues.html</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_help_system_access_implementation">24.2. Help System Access Implementation</h3>
<div class="paragraph">
<p><strong>Help Menu Integration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void MainWindow::setupHelpMenu() {
    QMenu* helpMenu = menuBar()-&gt;addMenu(tr("&amp;Help"));

    // User Manual (HTML)
    QAction* userManualAction = helpMenu-&gt;addAction(tr("&amp;User Manual"));
    userManualAction-&gt;setShortcut(QKeySequence::HelpContents); // F1
    connect(userManualAction, &amp;QAction::triggered, this, &amp;MainWindow::showUserManual);

    // User Manual (PDF)
    QAction* pdfManualAction = helpMenu-&gt;addAction(tr("User Manual (&amp;PDF)"));
    connect(pdfManualAction, &amp;QAction::triggered, this, &amp;MainWindow::openPDFManual);

    helpMenu-&gt;addSeparator();

    // About
    QAction* aboutAction = helpMenu-&gt;addAction(tr("&amp;About SmartBook"));
    connect(aboutAction, &amp;QAction::triggered, this, &amp;MainWindow::showAboutDialog);
}

void MainWindow::showUserManual() {
    QString helpPath = getHelpDirectory() + "/index.html";
    QUrl helpUrl = QUrl::fromLocalFile(helpPath);

    // Open in integrated help viewer or external browser
    if (useIntegratedHelpViewer()) {
        showHelpViewer(helpUrl);
    } else {
        QDesktopServices::openUrl(helpUrl);
    }
}

void MainWindow::openPDFManual() {
    QString pdfPath = getPDFManualPath();
    if (QFile::exists(pdfPath)) {
        QDesktopServices::openUrl(QUrl::fromLocalFile(pdfPath));
    } else {
        QMessageBox::warning(this, tr("Manual Not Found"),
            tr("User manual PDF not found at:\n%1").arg(pdfPath));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Platform-Specific Help Paths:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">QString MainWindow::getHelpDirectory() {
    QString basePath = QCoreApplication::applicationDirPath();

#ifdef Q_OS_MACOS
    // macOS: Resources directory in app bundle
    basePath += "/../Resources/help";
#else
    // Windows/Linux: help directory in install directory
    basePath += "/help";
#endif

    return QDir(basePath).canonicalPath();
}

QString MainWindow::getPDFManualPath() {
    QString basePath = QCoreApplication::applicationDirPath();

#ifdef Q_OS_MACOS
    // macOS: Resources directory
    basePath += "/../Resources/SmartBook_User_Manual.pdf";
#elif defined(Q_OS_WIN)
    // Windows: docs directory
    basePath += "/docs/SmartBook_User_Manual.pdf";
#else
    // Linux: share/doc directory or install directory
    basePath = "/usr/share/doc/smartbook/SmartBook_User_Manual.pdf";
    if (!QFile::exists(basePath)) {
        basePath = QCoreApplication::applicationDirPath() + "/SmartBook_User_Manual.pdf";
    }
#endif

    return basePath;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integrated_help_viewer">24.3. Integrated Help Viewer</h3>
<div class="paragraph">
<p><strong>Help Viewer Window:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class HelpViewer : public QMainWindow {
    Q_OBJECT
public:
    explicit HelpViewer(QWidget* parent = nullptr);
    void loadHelpContent(const QUrl&amp; url);

private slots:
    void onLinkClicked(const QUrl&amp; url);
    void goBack();
    void goForward();
    void goHome();
    void searchHelp();

private:
    QWebEngineView* m_webView;
    QToolBar* m_toolbar;
    QLineEdit* m_addressBar;
    QAction* m_backAction;
    QAction* m_forwardAction;
    QAction* m_homeAction;
    QAction* m_searchAction;
    QUrl m_homeUrl;
};

HelpViewer::HelpViewer(QWidget* parent)
    : QMainWindow(parent) {
    setWindowTitle(tr("SmartBook Help"));
    setMinimumSize(800, 600);

    // Create WebEngine view for HTML help content
    m_webView = new QWebEngineView(this);
    setCentralWidget(m_webView);

    // Setup toolbar
    m_toolbar = addToolBar(tr("Navigation"));
    m_backAction = m_toolbar-&gt;addAction(tr("Back"));
    m_forwardAction = m_toolbar-&gt;addAction(tr("Forward"));
    m_homeAction = m_toolbar-&gt;addAction(tr("Home"));
    m_toolbar-&gt;addSeparator();
    m_searchAction = m_toolbar-&gt;addAction(tr("Search"));

    // Address bar
    m_addressBar = new QLineEdit(this);
    m_toolbar-&gt;addWidget(m_addressBar);

    // Connect signals
    connect(m_webView, &amp;QWebEngineView::urlChanged,
            this, [this](const QUrl&amp; url) {
        m_addressBar-&gt;setText(url.toString());
    });

    connect(m_webView, &amp;QWebEngineView::linkClicked,
            this, &amp;HelpViewer::onLinkClicked);

    connect(m_backAction, &amp;QAction::triggered, this, &amp;HelpViewer::goBack);
    connect(m_forwardAction, &amp;QAction::triggered, this, &amp;HelpViewer::goForward);
    connect(m_homeAction, &amp;QAction::triggered, this, &amp;HelpViewer::goHome);
    connect(m_searchAction, &amp;QAction::triggered, this, &amp;HelpViewer::searchHelp);

    // Load home page
    m_homeUrl = QUrl::fromLocalFile(getHelpDirectory() + "/index.html");
    loadHelpContent(m_homeUrl);
}

void HelpViewer::loadHelpContent(const QUrl&amp; url) {
    m_webView-&gt;setUrl(url);
}

void HelpViewer::onLinkClicked(const QUrl&amp; url) {
    // Only allow local file URLs (help content)
    if (url.scheme() == "file" || url.scheme().isEmpty()) {
        loadHelpContent(url);
    } else {
        // External links - open in system browser
        QDesktopServices::openUrl(url);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pdf_manual_generation">24.4. PDF Manual Generation</h3>
<div class="paragraph">
<p><strong>PDF Generation Process:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Generate PDF from AsciiDoc source
asciidoctor-pdf -a pdf-style=theme.yml \
                -a pdf-fontsdir=fonts \
                -a imagesdir=images \
                -o SmartBook_User_Manual.pdf \
                user-manual.adoc</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>PDF Generation Requirements:</strong>
* <strong>Source:</strong> Single AsciiDoc source document (<code>user-manual.adoc</code>)
* <strong>Tool:</strong> Asciidoctor PDF or similar
* <strong>Output:</strong> <code>SmartBook_User_Manual.pdf</code>
* <strong>Format:</strong> PDF/A compliant for long-term archival
* <strong>Features:</strong> Table of contents, bookmarks, cross-references, images, code syntax highlighting</p>
</div>
<div class="paragraph">
<p><strong>PDF Distribution:</strong>
* <strong>Windows:</strong> Include in installer, install to <code>{install_dir}/docs/</code>
* <strong>macOS:</strong> Include in app bundle at <code>SmartBook.app/Contents/Resources/</code> or DMG
* <strong>Linux:</strong> Include in package, install to <code>/usr/share/doc/smartbook/</code> or user-accessible location</p>
</div>
</div>
<div class="sect2">
<h3 id="_context_sensitive_help">24.5. Context-Sensitive Help</h3>
<div class="paragraph">
<p><strong>Dialog Help Integration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void SettingsDialog::setupHelp() {
    // Add help button to dialog
    QPushButton* helpButton = new QPushButton(tr("&amp;Help"), this);
    connect(helpButton, &amp;QPushButton::clicked, this, &amp;SettingsDialog::showHelp);

    // Add to button box
    QDialogButtonBox* buttonBox = findChild&lt;QDialogButtonBox*&gt;();
    if (buttonBox) {
        buttonBox-&gt;addButton(helpButton, QDialogButtonBox::HelpRole);
    }
}

void SettingsDialog::showHelp() {
    // Open help to relevant section
    QUrl helpUrl = QUrl::fromLocalFile(getHelpDirectory() + "/reference/settings.html");
    QDesktopServices::openUrl(helpUrl);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Tooltip Help:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void MainWindow::setupTooltips() {
    // Add tooltips to UI elements
    m_libraryView-&gt;setToolTip(tr("Double-click a cartridge to open it. Right-click for options."));
    m_searchButton-&gt;setToolTip(tr("Search cartridges in your library (Ctrl+F)"));
    m_importButton-&gt;setToolTip(tr("Import cartridge files into your library"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>"What&#8217;s This?" Mode:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void MainWindow::enableWhatsThis() {
    // Enable Qt's "What's This?" mode
    QAction* whatsThisAction = QWhatsThis::createAction(this);
    whatsThisAction-&gt;setShortcut(QKeySequence(Qt::SHIFT | Qt::Key_F1));
    helpMenu()-&gt;addAction(whatsThisAction);

    // Add "What's This?" help text to widgets
    m_libraryView-&gt;setWhatsThis(tr(
        "The library view displays all cartridges in your library. "
        "Double-click to open, right-click for options, or use the toolbar buttons."
    ));
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_platform_specific_help_integration">24.6. Platform-Specific Help Integration</h3>
<div class="paragraph">
<p><strong>macOS Help Book:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Info.plist entries for macOS Help Book --&gt;
&lt;key&gt;CFBundleHelpBookFolder&lt;/key&gt;
&lt;string&gt;SmartBook.help&lt;/string&gt;
&lt;key&gt;CFBundleHelpBookName&lt;/key&gt;
&lt;string&gt;com.smartbook.help&lt;/string&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Help Book Structure (macOS):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>SmartBook.app/Contents/Resources/
└── SmartBook.help/
    ├── Contents/
    │   ├── Info.plist
    │   └── Resources/
    │       ├── index.html
    │       ├── getting-started/
    │       ├── reader/
    │       └── ...
    └── SmartBook_User_Manual.pdf</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Windows Help Integration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#ifdef Q_OS_WIN
void MainWindow::setupWindowsHelp() {
    // Register help file with Windows Help system
    QString helpFile = getHelpDirectory() + "/index.html";

    // Windows Help integration (optional)
    // Can use HTML Help Workshop (.chm) or simple HTML help
}
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux Desktop Integration:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini"># .desktop file entry for help
[Desktop Entry]
...
X-GNOME-Help=smartbook</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_user_manual_content_specification">24.7. User Manual Content Specification</h3>
<div class="paragraph">
<p><strong>Manual Structure:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Introduction</strong></p>
<div class="ulist">
<ul>
<li>
<p>What is SmartBook</p>
</li>
<li>
<p>System requirements</p>
</li>
<li>
<p>Installation instructions</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Getting Started</strong></p>
<div class="ulist">
<ul>
<li>
<p>First launch</p>
</li>
<li>
<p>Library setup</p>
</li>
<li>
<p>Importing cartridges</p>
</li>
<li>
<p>Opening cartridges</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Reader Application</strong></p>
<div class="ulist">
<ul>
<li>
<p>Library management</p>
</li>
<li>
<p>Reading cartridges</p>
</li>
<li>
<p>Navigation (TOC, bookmarks, history)</p>
</li>
<li>
<p>Search (document and in-page)</p>
</li>
<li>
<p>Forms (filling, saving, loading)</p>
</li>
<li>
<p>Embedded applications</p>
</li>
<li>
<p>Theming</p>
</li>
<li>
<p>Printing</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Creator Tool</strong></p>
<div class="ulist">
<ul>
<li>
<p>Content authoring</p>
</li>
<li>
<p>Page and chapter management</p>
</li>
<li>
<p>Form building</p>
</li>
<li>
<p>Embedded app creation</p>
</li>
<li>
<p>Cartridge creation and signing</p>
</li>
<li>
<p>Export and publishing</p>
</li>
<li>
<p>Templates and imports</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Security and Trust</strong></p>
<div class="ulist">
<ul>
<li>
<p>Trust levels explained</p>
</li>
<li>
<p>Consent dialogs</p>
</li>
<li>
<p>Certificate management</p>
</li>
<li>
<p>Trust revocation</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Reference</strong></p>
<div class="ulist">
<ul>
<li>
<p>Keyboard shortcuts</p>
</li>
<li>
<p>File formats</p>
</li>
<li>
<p>Troubleshooting</p>
</li>
<li>
<p>FAQ</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Appendix</strong></p>
<div class="ulist">
<ul>
<li>
<p>Glossary</p>
</li>
<li>
<p>Technical specifications</p>
</li>
<li>
<p>Support information</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_help_content_maintenance">24.8. Help Content Maintenance</h3>
<div class="paragraph">
<p><strong>Version Control:</strong>
* Help content version SHALL match application version
* Help content SHALL be versioned independently for updates
* Version information SHALL be displayed in help viewer or About dialog</p>
</div>
<div class="paragraph">
<p><strong>Update Mechanism:</strong>
* Help content MAY be updated via application update
* Help content MAY be updated independently (separate download)
* Users SHALL be notified if help content is outdated</p>
</div>
<div class="paragraph">
<p><strong>Build Integration:</strong>
* Help content generation SHALL be part of build process
* PDF generation SHALL be automated
* Help content SHALL be included in distribution packages</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_error_handling_and_logging_implementation">25. Error Handling and Logging Implementation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_error_handling_strategy">25.1. Error Handling Strategy</h3>
<div class="paragraph">
<p>The Reader and Creator Tool applications implement comprehensive error handling with graceful degradation, user-friendly error messages, and detailed logging for debugging.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reader_application_error_handling">25.2. Reader Application Error Handling</h3>
<div class="sect3">
<h4 id="_cartridge_file_errors">25.2.1. Cartridge File Errors</h4>
<div class="paragraph">
<p><strong>Detection:</strong>
* File existence check before opening
* SQLite format validation
* File corruption detection via SQLite integrity checks</p>
</div>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>File Not Found:</strong> Display user-friendly error: "Cartridge file not found. It may have been moved or deleted."
* <strong>Invalid SQLite Format:</strong> Display error: "Invalid cartridge format. The file may be corrupted."
* <strong>File Corruption:</strong> Attempt SQLite recovery if possible. If recovery fails, display error with option to delete corrupted cartridge.
* <strong>Permission Errors:</strong> Display error: "Cannot access cartridge file. Check file permissions."</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong> All cartridge file errors SHALL be logged with ERROR level, including file path and error details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_database_connection_errors">25.2.2. Database Connection Errors</h4>
<div class="paragraph">
<p><strong>Detection:</strong>
* Connection attempt with timeout
* SQLite error code checking
* Disk space monitoring</p>
</div>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>Database Locked:</strong> Retry with exponential backoff (max 3 retries). If still locked, display error: "Cartridge is in use by another application."
* <strong>Disk Full:</strong> Display error: "Insufficient disk space. Free up space and try again."
* <strong>SQLite Corruption:</strong> Attempt recovery using <code>PRAGMA integrity_check</code>. If recovery fails, display error with option to delete corrupted cartridge.
* <strong>Connection Timeout:</strong> Display error: "Database connection timeout. The cartridge may be on a slow storage device."</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong> Database errors SHALL be logged with ERROR level, including SQLite error codes and operation context.</p>
</div>
</div>
<div class="sect3">
<h4 id="_signature_verification_errors">25.2.3. Signature Verification Errors</h4>
<div class="paragraph">
<p><strong>Error Types and Messages:</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Error Type</th>
<th class="tableblock halign-center valign-middle">User Message</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid Signature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Cartridge signature is invalid. The content may have been tampered with or corrupted."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expired Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"The cartridge&#8217;s security certificate has expired. Contact the publisher for an updated version."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Untrusted CA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"The cartridge&#8217;s security certificate is not from a trusted authority. Proceed with caution."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Corrupted Security Data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Cartridge security data is corrupted. The file may be damaged."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash Mismatch (Tampering)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Cartridge integrity check failed. The file has been modified since it was signed. For security reasons, execution is blocked."</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Handling:</strong>
* All signature verification errors SHALL block app execution
* Hash mismatch errors SHALL be logged as security events with WARN level
* User SHALL be informed of the specific error type</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_system_errors">25.2.4. File System Errors</h4>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>Disk Full:</strong> Check available disk space before operations. Display error: "Insufficient disk space. Free up [X] MB and try again."
* <strong>Permission Denied:</strong> Display error: "Permission denied. Check file permissions or run as administrator."
* <strong>Path Too Long:</strong> Display error: "File path is too long. Move the cartridge to a shorter path."
* <strong>Invalid Characters:</strong> Sanitize paths and display warning if sanitization occurred.</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong> File system errors SHALL be logged with WARN or ERROR level depending on severity.</p>
</div>
</div>
<div class="sect3">
<h4 id="_manifest_update_error_handling">25.2.5. Manifest Update Error Handling</h4>
<div class="paragraph">
<p><strong>Two Types of Manifests:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Embedded App Manifest</strong> (<code>Embedded_App_Manifest</code> JSON in <code>Embedded_Apps.manifest_json</code>):</p>
<div class="ulist">
<ul>
<li>
<p>Created/updated when cartridge is created/updated by Creator Tool</p>
</li>
<li>
<p>Stored within the cartridge database itself</p>
</li>
<li>
<p>Failures typically occur during cartridge creation/update in Creator Tool</p>
</li>
<li>
<p>Error handling: See "Creator Tool Manifest Error Handling" below</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Local Library Manifest</strong> (<code>Local_Library_Manifest</code> table in Reader&#8217;s local database):</p>
<div class="ulist">
<ul>
<li>
<p>Updated when cartridge is added/updated/removed from library</p>
</li>
<li>
<p>Stored in Reader&#8217;s local database (<code>local_reader.sqlite</code>)</p>
</li>
<li>
<p>Failures typically due to disk space or file permissions</p>
</li>
<li>
<p>Error handling: See "Local Library Manifest Error Handling" below</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_creator_tool_embedded_app_manifest_error_handling">Creator Tool: Embedded App Manifest Error Handling</h5>
<div class="paragraph">
<p><strong>When Manifest is Created/Updated:</strong>
* During cartridge creation: When author defines embedded applications
* During cartridge update: When author modifies embedded application definitions
* Manifest is validated before being saved to cartridge database</p>
</div>
<div class="paragraph">
<p><strong>Error Scenarios:</strong>
* JSON validation errors (invalid manifest structure)
* Schema validation errors (missing required fields, invalid field types)
* Database write errors (cartridge file locked, disk full, permissions)</p>
</div>
<div class="paragraph">
<p><strong>Error Dialog Requirements:</strong>
* Display error dialog to user with:
  * <strong>Operation:</strong> "Create Embedded App Manifest" or "Update Embedded App Manifest"
  * <strong>App ID:</strong> The <code>app_id</code> of the embedded app being created/updated
  * <strong>Error Type:</strong> Brief description (e.g., "JSON Validation Error", "Database Write Error")
  * <strong>Error Message:</strong> Detailed error message from validation or database operation
  * <strong>Context:</strong> Cartridge file path, operation timestamp
  * <strong>Suggested Resolution:</strong> Actionable steps to resolve the error
* Error dialog should include "Copy Error Details" button to copy full error information for debugging
* Error dialog should allow user to retry operation or cancel</p>
</div>
<div class="paragraph">
<p><strong>Error Dialog Example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Title: "Failed to Save Embedded App Manifest"

Message:
"Failed to save embedded app manifest for app 'character_generator'.

Error: JSON validation failed - missing required field 'appId'

Cartridge: /path/to/cartridge.sqlite
Operation: Create Embedded App Manifest
Timestamp: 2025-12-14 10:30:45

Suggested Resolution:
. Check that all required fields are present in the manifest
. Verify JSON structure is valid
. Try saving again

[Copy Error Details] [Retry] [Cancel]"</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Logging:</strong>
* Log error with ERROR level
* Include: operation type, app ID, error message, cartridge path, stack trace (if available)</p>
</div>
</div>
<div class="sect4">
<h5 id="_reader_local_library_manifest_error_handling">Reader: Local Library Manifest Error Handling</h5>
<div class="paragraph">
<p><strong>When Manifest is Updated:</strong>
* <strong>On Cartridge Import:</strong> When new cartridge is added to library
* <strong>On Cartridge Open:</strong> When cartridge is opened and content hash (H2) is recalculated
* <strong>On Cartridge Update:</strong> When cartridge file is detected at new path or with changed content
* <strong>On Cartridge Deletion:</strong> When cartridge is removed from library</p>
</div>
<div class="paragraph">
<p><strong>Error Scenarios:</strong>
* <strong>Disk Space Exhaustion:</strong> Insufficient disk space to write to local database
* <strong>File Permissions:</strong> No write permission to local database file or directory
* <strong>Database Locked:</strong> Local database file is locked by another process
* <strong>Database Corruption:</strong> Local database file is corrupted or inaccessible
* <strong>Path Issues:</strong> Invalid or inaccessible local database path</p>
</div>
<div class="paragraph">
<p><strong>Error Handling Strategy:</strong>
* If manifest update fails, operation SHALL continue (non-blocking for cartridge operations)
* Error SHALL be logged with ERROR level
* User SHALL be notified via error dialog with sufficient information to reproduce and debug</p>
</div>
<div class="paragraph">
<p><strong>Error Dialog Requirements:</strong>
* Display error dialog to user with:
  * <strong>Operation:</strong> "Update Library Manifest" or "Add to Library" or "Remove from Library"
  * <strong>Cartridge:</strong> Cartridge title and <code>cartridge_guid</code>
  * <strong>Error Type:</strong> Brief description (e.g., "Disk Space Error", "Permission Denied")
  * <strong>Error Message:</strong> Detailed error message from database operation
  * <strong>Context:</strong> Local database path, operation timestamp, SQLite error code (if applicable)
  * <strong>Suggested Resolution:</strong> Actionable steps to resolve the error
* Error dialog should include "Copy Error Details" button to copy full error information for debugging
* Error dialog should allow user to retry operation or dismiss</p>
</div>
<div class="paragraph">
<p><strong>Error Dialog Example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Title: "Failed to Update Library Manifest"

Message:
"Failed to update library manifest for cartridge 'D&amp;D 5e Player's Handbook'.

Error: SQLite error 14 - unable to open database file
SQLite Error Code: 14
Error Message: disk I/O error

Cartridge GUID: abc-123-def-456
Local Database: /Users/username/.local/share/SmartBook/local_reader.sqlite
Operation: Update Library Manifest
Timestamp: 2025-12-14 10:30:45

Suggested Resolution:
. Check that you have write permissions to the database directory
. Verify sufficient disk space is available
. Ensure the database file is not locked by another process
. Try restarting the application

[Copy Error Details] [Retry] [Dismiss]"</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Logging:</strong>
* Log error with ERROR level
* Include: operation type, cartridge_guid, error message, local database path, SQLite error code, stack trace (if available)</p>
</div>
<div class="paragraph">
<p><strong>Retry Strategy:</strong>
* Update SHALL be retried on next application launch
* If retry fails, error dialog is displayed again
* User can manually retry via error dialog</p>
</div>
<div class="paragraph">
<p><strong>Non-Blocking Behavior:</strong>
* Cartridge operations (open, import, delete) continue even if manifest update fails
* Library view may show stale data until manifest update succeeds
* User is informed that library data may be out of date</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cartridge_import_process_specification">26. Cartridge Import Process Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines the complete workflow for importing cartridges into the Reader&#8217;s library.</p>
</div>
<div class="sect2">
<h3 id="_import_mechanisms">26.1. Import Mechanisms</h3>
<div class="paragraph">
<p><strong>Drag-and-Drop:</strong>
* Users can drag one or more <code>.sqlite</code> cartridge files from the file system
* Drop target: Library Manager window (main library view area)
* Visual feedback: Highlight drop target area when files are dragged over window
* Accepts: Files with <code>.sqlite</code> extension
* Rejects: Non-cartridge files (display error message)</p>
</div>
<div class="paragraph">
<p><strong>File Picker Dialog:</strong>
* Accessible via: Menu item (File → Import) or toolbar button
* Native file picker dialog (Qt&#8217;s <code>QFileDialog</code>)
* Supports: Single file selection or multiple file selection
* File filter: "SmartBook Cartridges (<strong>.sqlite)" or "All Files (</strong>)"
* Default directory: Last used import directory or user&#8217;s Documents folder</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_storage_location">26.2. Import Storage Location</h3>
<div class="paragraph">
<p><strong>Default Library Directory:</strong>
* <strong>Windows:</strong> <code>%USERPROFILE%\Documents\SmartBook\Library\</code>
* <strong>macOS:</strong> <code>~/Documents/SmartBook/Library/</code>
* <strong>Linux:</strong> <code>~/Documents/SmartBook/Library/</code></p>
</div>
<div class="paragraph">
<p><strong>Rationale:</strong>
* Follows operating system standards for user document storage
* Documents folder is typically backed up by OS backup systems
* Accessible to users for manual file management
* Consistent across platforms</p>
</div>
<div class="paragraph">
<p><strong>User Configuration:</strong>
* Users can configure custom library directory via application settings
* Setting stored in application configuration (QSettings)
* Library directory preference persists across sessions
* If custom directory doesn&#8217;t exist, create it on first import
* If custom directory becomes inaccessible, fall back to default directory and notify user</p>
</div>
<div class="paragraph">
<p><strong>Storage Strategy:</strong>
* Imported cartridges are copied to the library directory
* Original file location is not required after import
* Cartridge files are stored with their original filename (or renamed if duplicate filename exists)
* Library directory structure is flat (no subdirectories) for simplicity</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_progress_dialog">26.3. Import Progress Dialog</h3>
<div class="paragraph">
<p><strong>Dialog Components:</strong>
* <strong>Title:</strong> "Importing Cartridges"
* <strong>Progress Bar:</strong> Shows overall progress (percentage or file count)
* <strong>Status Text:</strong> Current operation description (e.g., "Copying file: example.sqlite")
* <strong>File List:</strong> List of files being imported with status indicators (pending, in progress, completed, failed)
* <strong>Cancel Button:</strong> Abort import operation (closes dialog, stops import)</p>
</div>
<div class="paragraph">
<p><strong>Progress Updates:</strong>
* Update progress bar as each file is processed
* Update status text for each operation step
* Update file list with status indicators
* Enable cancel button throughout import process</p>
</div>
<div class="paragraph">
<p><strong>Cancel Behavior:</strong>
* If user clicks Cancel:
  * Stop processing remaining files
  * Complete current file operation (if in progress)
  * Roll back any partial imports (delete copied files, remove manifest entries)
  * Close progress dialog
  * Display summary: "Import cancelled. X of Y files imported."</p>
</div>
</div>
<div class="sect2">
<h3 id="_duplicate_detection_and_handling">26.4. Duplicate Detection and Handling</h3>
<div class="paragraph">
<p><strong>Duplicate Detection:</strong>
* After copying file to library directory, open cartridge and read <code>cartridge_guid</code> from <code>Metadata</code> table
* Query <code>Local_Library_Manifest</code> table for existing entry with same <code>cartridge_guid</code>
* If duplicate found, display confirmation dialog before proceeding</p>
</div>
<div class="paragraph">
<p><strong>Duplicate Confirmation Dialog:</strong>
* <strong>Title:</strong> "Duplicate Cartridge Detected"
* <strong>Message:</strong> "A cartridge with the same identifier already exists in your library."
* <strong>Existing Cartridge Information:</strong>
  * Title
  * Author
  * File path
  * File size
  * Last modified date
* <strong>New Cartridge Information:</strong>
  * Title
  * Author
  * File path (source)
  * File size
  * Last modified date
* <strong>Options:</strong>
  * <strong>Replace:</strong> Delete existing cartridge file, import new cartridge, update manifest entry
  * <strong>Skip:</strong> Abort import for this cartridge, continue with next file (if multiple)
  * <strong>Keep Both:</strong> Rename new file (add suffix like "_1", "_2") and import as separate entry
* <strong>Checkbox (if multiple files):</strong> "Apply this choice to all duplicates" - allows batch handling</p>
</div>
<div class="paragraph">
<p><strong>Replace Operation:</strong>
* Delete existing cartridge file from library directory
* Copy new cartridge file to library directory
* Update manifest entry (new path, new hash, new metadata)
* Preserve trust registry entry (if exists) - user&#8217;s trust decision remains
* Preserve user settings (if exists) - user preferences remain
* Preserve bookmarks and reading position (if exists) - user data remains</p>
</div>
<div class="paragraph">
<p><strong>Skip Operation:</strong>
* Do not copy new cartridge file
* Do not update manifest
* Continue with next file in import batch
* Log skipped duplicate for user reference</p>
</div>
<div class="paragraph">
<p><strong>Keep Both Operation:</strong>
* Generate unique filename: <code>{original_name}_{suffix}.sqlite</code> where suffix is incremented until unique
* Copy new cartridge file with new filename
* Create new manifest entry (different <code>local_path</code>, same <code>cartridge_guid</code>)
* Note: This creates two entries with same <code>cartridge_guid</code> but different paths
* User can manually delete one later if desired</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_validation">26.5. Import Validation</h3>
<div class="paragraph">
<p><strong>Validation Steps:</strong>
. <strong>File Format Validation:</strong>
   * Verify file exists and is readable
   * Verify file has <code>.sqlite</code> extension (or is valid SQLite database)
   * Attempt to open as SQLite database
   * If fails: Display error "Invalid cartridge file format" and skip</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Schema Validation:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Verify <code>Metadata</code> table exists</p>
</li>
<li>
<p>Verify <code>cartridge_guid</code> column exists and contains valid UUID v4</p>
</li>
<li>
<p>Verify <code>schema_version</code> column exists</p>
</li>
<li>
<p>Verify required tables exist (<code>Content_Pages</code>, etc.)</p>
</li>
<li>
<p>If fails: Display error "Invalid cartridge structure" and skip</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Version Compatibility:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Read <code>schema_version</code> from <code>Metadata</code> table</p>
</li>
<li>
<p>Compare with Reader&#8217;s supported format versions</p>
</li>
<li>
<p>If newer version: Display error "Cartridge requires newer Reader version" and skip</p>
</li>
<li>
<p>If older version: Proceed (migration handled during load)</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Metadata Extraction:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Read <code>title</code>, <code>author</code>, <code>publication_year</code> from <code>Metadata</code> table</p>
</li>
<li>
<p>Read <code>cover_image_path</code> and load cover image data</p>
</li>
<li>
<p>Verify required metadata fields are present</p>
</li>
<li>
<p>If fails: Display error "Missing required metadata" and skip</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Validation Error Handling:</strong>
* Display error dialog for each validation failure
* Include: File name, error type, error details
* Allow user to continue with other files (if batch import)
* Log all validation errors</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_workflow_algorithm">26.6. Import Workflow Algorithm</h3>
<div class="paragraph">
<p><strong>Step 1: File Selection</strong>
. User initiates import (drag-drop or file picker)
. Collect list of files to import
. Filter to only <code>.sqlite</code> files (warn about non-cartridge files)</p>
</div>
<div class="paragraph">
<p><strong>Step 2: Progress Dialog Display</strong>
. Display import progress dialog
. Initialize progress bar to 0%
. Add all files to file list with "pending" status</p>
</div>
<div class="paragraph">
<p><strong>Step 3: Process Each File</strong>
For each file in import list:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Update Status:</strong> Set file status to "in progress" in progress dialog</p>
</li>
<li>
<p><strong>Validate File:</strong> Perform import validation (see "Import Validation" above)</p>
</li>
<li>
<p><strong>If Validation Fails:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Set file status to "failed" in progress dialog</p>
</li>
<li>
<p>Display error dialog</p>
</li>
<li>
<p>Continue with next file</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>If Validation Succeeds:</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Check for Duplicate:</strong></p>
</li>
<li>
<p>Read <code>cartridge_guid</code> from cartridge</p>
</li>
<li>
<p>Query manifest for existing entry</p>
</li>
<li>
<p>If duplicate found:</p>
</li>
<li>
<p>Display duplicate confirmation dialog</p>
</li>
<li>
<p>Wait for user choice</p>
</li>
<li>
<p>If "Skip": Set status to "skipped", continue next file</p>
</li>
<li>
<p>If "Replace": Proceed with replace operation</p>
</li>
<li>
<p>If "Keep Both": Generate unique filename</p>
</li>
<li>
<p><strong>Copy File:</strong></p>
</li>
<li>
<p>Determine destination path (library directory + filename)</p>
</li>
<li>
<p>Copy file to library directory</p>
</li>
<li>
<p>Update progress: "Copying file&#8230;&#8203;"</p>
</li>
<li>
<p><strong>Extract Metadata:</strong></p>
</li>
<li>
<p>Read metadata from cartridge</p>
</li>
<li>
<p>Load cover image data</p>
</li>
<li>
<p>Calculate content hash (H2)</p>
</li>
<li>
<p>Update progress: "Extracting metadata&#8230;&#8203;"</p>
</li>
<li>
<p><strong>Create Manifest Entry:</strong></p>
</li>
<li>
<p>Insert/update entry in <code>Local_Library_Manifest</code> table</p>
</li>
<li>
<p>Update progress: "Updating library&#8230;&#8203;"</p>
</li>
<li>
<p><strong>Set Status:</strong> Set file status to "completed" in progress dialog</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Step 4: Completion</strong>
. Update progress bar to 100%
. Close progress dialog (or show completion summary)
. Refresh library view to display imported cartridges
. Display success notification (optional): "Successfully imported X cartridges"</p>
</div>
<div class="paragraph">
<p><strong>Step 5: Error Summary (if any failures)</strong>
. If any files failed validation or were skipped:
. Display summary dialog: "Import completed with X errors. Y files imported successfully, Z files skipped/failed."
. Provide option to view error log</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_error_handling">26.7. Import Error Handling</h3>
<div class="paragraph">
<p><strong>File Access Errors:</strong>
* <strong>File Not Found:</strong> Display error "File not found. It may have been moved or deleted."
* <strong>Permission Denied:</strong> Display error "Permission denied. Check file permissions."
* <strong>Disk Full:</strong> Display error "Insufficient disk space. Free up space and try again."</p>
</div>
<div class="paragraph">
<p><strong>Database Errors:</strong>
* <strong>Invalid SQLite Format:</strong> Display error "Invalid cartridge format. The file may be corrupted."
* <strong>Database Locked:</strong> Display error "Cartridge file is locked. Close other applications using this file."
* <strong>Corruption:</strong> Display error "Cartridge file is corrupted. Cannot import."</p>
</div>
<div class="paragraph">
<p><strong>Manifest Update Errors:</strong>
* If manifest update fails during import:
  * File is copied but manifest entry not created
  * Display error dialog (see "Manifest Update Error Handling" section)
  * User can retry manifest update later
  * File remains in library directory but won&#8217;t appear in library view until manifest is updated</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong>
* Log all import operations with INFO level
* Log validation errors with WARN level
* Log file operation errors with ERROR level
* Include: file paths, cartridge_guid, error details, timestamps</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_migration_strategy">27. Database Migration Strategy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section defines how database schema migrations are handled for both cartridge format versions and the Reader&#8217;s local database schema.</p>
</div>
<div class="sect2">
<h3 id="_cartridge_format_version_migration">27.1. Cartridge Format Version Migration</h3>
<div class="paragraph">
<p>Cartridge format version is stored in the <code>Metadata.schema_version</code> field and indicates the Smartbook Format Specification version used when the cartridge was created.</p>
</div>
<div class="sect3">
<h4 id="_version_detection">27.1.1. Version Detection</h4>
<div class="paragraph">
<p><strong>When Cartridge is Opened:</strong>
. Reader reads <code>schema_version</code> from <code>Metadata</code> table
. Reader compares cartridge <code>schema_version</code> with current supported format version
. If versions match: Cartridge is loaded normally
. If versions don&#8217;t match: Migration process is triggered</p>
</div>
<div class="paragraph">
<p><strong>Supported Versions:</strong>
* <strong>Phase 1:</strong> Format version "1.0" is the initial and only supported version
* Future phases may introduce new format versions (e.g., "1.1", "2.0")
* Reader must support all format versions from Phase 1 forward (backward compatibility)</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_strategy">27.1.2. Migration Strategy</h4>
<div class="paragraph">
<p><strong>Backward Compatibility:</strong>
* Reader SHALL support reading cartridges from all previous format versions
* Reader SHALL NOT modify cartridge files during migration (cartridges are read-only from Reader perspective)
* Migration is performed in-memory during cartridge loading
* Original cartridge file remains unchanged</p>
</div>
<div class="paragraph">
<p><strong>Forward Compatibility:</strong>
* Reader SHALL detect cartridges with newer format versions than it supports
* Reader SHALL display error message: "This cartridge requires a newer version of SmartBook Reader. Please update the application."
* Reader SHALL NOT attempt to load cartridges with unsupported newer format versions</p>
</div>
<div class="paragraph">
<p><strong>Migration Process:</strong>
. <strong>Detect Version:</strong> Read <code>schema_version</code> from cartridge <code>Metadata</code> table
. <strong>Check Compatibility:</strong> Compare with Reader&#8217;s supported format versions
. <strong>If Older Version:</strong>
   a. Determine migration path (e.g., 1.0 → 1.1 → 2.0)
   b. Apply migration transformations in-memory
   c. Load cartridge with migrated schema
   d. Log migration operation
. <strong>If Same Version:</strong> Load cartridge normally
. <strong>If Newer Version:</strong> Display error and refuse to load</p>
</div>
</div>
<div class="sect3">
<h4 id="_format_version_changes">27.1.3. Format Version Changes</h4>
<div class="paragraph">
<p><strong>Breaking Changes (Require Version Increment):</strong>
* Table schema changes (columns added/removed/renamed, data type changes)
* Table structure changes (new tables, removed tables)
* Required field additions
* Data format changes (JSON structure changes, encoding changes)</p>
</div>
<div class="paragraph">
<p><strong>Non-Breaking Changes (No Version Increment):</strong>
* Optional field additions
* New optional tables
* Extended validation rules (more restrictive)
* Additional metadata fields</p>
</div>
<div class="paragraph">
<p><strong>Version Numbering:</strong>
* Format: <code>MAJOR.MINOR</code> (e.g., "1.0", "1.1", "2.0")
* <strong>MAJOR</strong> increment: Breaking changes that require migration
* <strong>MINOR</strong> increment: Non-breaking changes, backward compatible</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_transformations">27.1.4. Migration Transformations</h4>
<div class="paragraph">
<p><strong>Table Schema Migrations:</strong>
* <strong>Add Column:</strong> Add new column with default value or NULL
* <strong>Remove Column:</strong> Drop column (data loss, but backward compatible for reading)
* <strong>Rename Column:</strong> Map old column name to new column name
* <strong>Change Data Type:</strong> Transform data type (e.g., TEXT to INTEGER with parsing)
* <strong>Add Table:</strong> Create new table structure in-memory
* <strong>Remove Table:</strong> Ignore table if not present in older version</p>
</div>
<div class="paragraph">
<p><strong>Data Transformations:</strong>
* <strong>JSON Structure Changes:</strong> Transform JSON data to match new schema
* <strong>Encoding Changes:</strong> Convert text encoding if needed
* <strong>Default Values:</strong> Apply default values for new required fields</p>
</div>
<div class="paragraph">
<p><strong>Migration Rules:</strong>
* Migration rules are defined in Reader code (not stored in cartridges)
* Each format version transition has specific migration code
* Migration code is tested and validated before release</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_error_handling">27.1.5. Migration Error Handling</h4>
<div class="paragraph">
<p><strong>Migration Failures:</strong>
* If migration fails, Reader SHALL display error dialog:
  * "Failed to migrate cartridge from format version X to version Y"
  * Include cartridge title, format version, error details
  * Suggest updating cartridge with Creator Tool or contacting publisher
* Reader SHALL log migration errors with full context
* Reader SHALL NOT attempt to load cartridge if migration fails</p>
</div>
<div class="paragraph">
<p><strong>Partial Migration:</strong>
* If migration partially succeeds (some data cannot be migrated):
  * Reader SHALL load cartridge with available data
  * Reader SHALL display warning: "Some data could not be migrated. Some features may not work correctly."
  * Reader SHALL log which data could not be migrated</p>
</div>
<div class="paragraph">
<p><strong>Migration Validation:</strong>
* After migration, validate migrated schema against current format version
* Verify all required tables and columns are present
* Verify data integrity (foreign keys, constraints)
* If validation fails, treat as migration failure</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reader_local_database_schema_migration">27.2. Reader Local Database Schema Migration</h3>
<div class="paragraph">
<p>The Reader&#8217;s local database (<code>local_reader.sqlite</code>) contains the <code>Local_Library_Manifest</code>, <code>Local_Trust_Registry</code>, and <code>Local_User_Settings</code> tables. The schema may change between Reader application versions.</p>
</div>
<div class="sect3">
<h4 id="_version_tracking">27.2.1. Version Tracking</h4>
<div class="paragraph">
<p><strong>Database Version Table:</strong>
* Reader SHALL maintain a <code>_schema_version</code> table in the local database
* Table structure:
  * <code>version</code> (TEXT, PRIMARY KEY): Schema version number (e.g., "1.0")
  * <code>applied_date</code> (INTEGER): Timestamp when migration was applied
* If <code>_schema_version</code> table doesn&#8217;t exist, database is treated as version "1.0" (initial schema)</p>
</div>
<div class="paragraph">
<p><strong>Version Detection:</strong>
* On application startup, Reader checks <code>_schema_version</code> table
* Compares stored version with current schema version
* If versions don&#8217;t match, migration process is triggered</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_process">27.2.2. Migration Process</h4>
<div class="paragraph">
<p><strong>Migration on Startup:</strong>
. <strong>Check Version:</strong> Query <code>_schema_version</code> table for current database version
. <strong>Compare Versions:</strong> Compare with Reader&#8217;s current schema version
. <strong>If Versions Match:</strong> Continue normal startup
. <strong>If Versions Don&#8217;t Match:</strong>
   a. Determine migration path (e.g., 1.0 → 1.1 → 2.0)
   b. Create backup of local database
   c. Apply migration transformations sequentially
   d. Update <code>_schema_version</code> table
   e. Validate migrated database
   f. If validation fails, restore from backup and display error</p>
</div>
<div class="paragraph">
<p><strong>Migration Transformations:</strong>
* <strong>Add Column:</strong> <code>ALTER TABLE table_name ADD COLUMN column_name TYPE DEFAULT value</code>
* <strong>Remove Column:</strong> SQLite doesn&#8217;t support DROP COLUMN directly - use table recreation:
  * Create new table with desired schema
  * Copy data from old table (excluding removed columns)
  * Drop old table
  * Rename new table to original name
* <strong>Rename Column:</strong> Use table recreation (same as remove column)
* <strong>Add Table:</strong> <code>CREATE TABLE new_table (&#8230;&#8203;)</code>
* <strong>Remove Table:</strong> <code>DROP TABLE old_table</code> (with data loss warning)
* <strong>Modify Constraints:</strong> Use table recreation</p>
</div>
<div class="paragraph">
<p><strong>Migration Backup:</strong>
* Before migration, create backup: <code>local_reader.sqlite.backup</code>
* Backup is created in same directory as database
* If migration fails, restore from backup
* Backup is kept until next successful migration or user manually deletes it</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration_error_handling_2">27.2.3. Migration Error Handling</h4>
<div class="paragraph">
<p><strong>Migration Failures:</strong>
* If migration fails, Reader SHALL:
  * Restore database from backup
  * Display error dialog:
    * "Failed to migrate local database from version X to version Y"
    * Include error details, backup location
    * Suggest manual database repair or contacting support
  * Log migration error with full context
  * Continue with previous schema version (may limit functionality)</p>
</div>
<div class="paragraph">
<p><strong>Migration Validation:</strong>
* After migration, validate database schema:
  * Verify all expected tables exist
  * Verify all expected columns exist
  * Verify data integrity (run PRAGMA integrity_check)
  * If validation fails, restore from backup</p>
</div>
<div class="paragraph">
<p><strong>User Notification:</strong>
* If migration succeeds, optionally display brief notification: "Database updated successfully"
* If migration fails, display error dialog (see above)
* User can continue using application with previous schema (with limitations)</p>
</div>
</div>
<div class="sect3">
<h4 id="_schema_version_history">27.2.4. Schema Version History</h4>
<div class="paragraph">
<p><strong>Version 1.0 (Phase 1 - Initial Schema):</strong>
* <code>Local_Library_Manifest</code> table with columns: manifest_id, cartridge_guid, cartridge_hash, local_path, title, author, version, publication_year, cover_image_data, last_opened, location_status
* <code>Local_Trust_Registry</code> table with columns: registry_id, cartridge_guid, app_trust_policy, trust_timestamp, content_hash_at_trust
* <code>Local_User_Settings</code> table with columns: setting_id, cartridge_guid, setting_key, setting_value
* <code>Local_Bookmarks</code> table with columns: bookmark_id, cartridge_guid, bookmark_name, page_id, anchor_id, created_timestamp
* <code>Local_Reading_Position</code> table with columns: position_id, cartridge_guid, page_id, anchor_id, scroll_position, last_access_timestamp</p>
</div>
<div class="paragraph">
<p><strong>Future Versions:</strong>
* Schema changes will be documented here as they are introduced
* Each version will include migration instructions</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_older_format_cartridges">27.3. Handling Older Format Cartridges</h3>
<div class="paragraph">
<p><strong>Detection:</strong>
* Reader detects older format cartridges by reading <code>schema_version</code> from <code>Metadata</code> table
* Reader compares with supported format versions</p>
</div>
<div class="paragraph">
<p><strong>Loading Strategy:</strong>
* <strong>Supported Older Versions:</strong> Apply migration transformations and load
* <strong>Unsupported Older Versions:</strong> Display error: "This cartridge format is no longer supported. Please contact the publisher for an updated version."
* <strong>Newer Versions:</strong> Display error: "This cartridge requires a newer version of SmartBook Reader. Please update the application."</p>
</div>
<div class="paragraph">
<p><strong>User Experience:</strong>
* Migration is transparent to user (automatic, in-memory)
* User is only notified if migration fails or if cartridge format is unsupported
* Cartridge loading may be slightly slower if migration is required</p>
</div>
<div class="paragraph">
<p><strong>Creator Tool Compatibility:</strong>
* Creator Tool can open and migrate older format cartridges
* Creator Tool can save cartridges in current format version
* Creator Tool can optionally save in older format versions (for compatibility testing)</p>
</div>
<div class="sect3">
<h4 id="_webengine_errors">27.3.1. WebEngine Errors</h4>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>JavaScript Errors:</strong> Logged but do not crash application. Display error overlay in WebEngine view with option to reload.
* <strong>WebEngine Crash:</strong> Catch crash signals, log error, display recovery dialog: "The content viewer encountered an error. Reload page or close cartridge?"
* <strong>Memory Exhaustion:</strong> Monitor memory usage, display warning if approaching limits, offer to close other cartridges.</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong> WebEngine errors SHALL be logged with ERROR level, including JavaScript console output where available.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creator_tool_error_handling">27.4. Creator Tool Error Handling</h3>
<div class="sect3">
<h4 id="_content_validation_errors">27.4.1. Content Validation Errors</h4>
<div class="paragraph">
<p><strong>Validation Points:</strong>
* Before saving cartridge
* Before exporting cartridge
* On form definition creation
* On embedded app definition</p>
</div>
<div class="paragraph">
<p><strong>Error Messages:</strong>
* <strong>Invalid HTML:</strong> "Invalid HTML detected at line [X]. Fix syntax errors before saving."
* <strong>Malformed JSON:</strong> "Form schema JSON is invalid: [error details]"
* <strong>Missing Metadata:</strong> "Required metadata field '[field]' is missing."
* <strong>Invalid Form Definition:</strong> "Form definition validation failed: [specific field errors]"
* <strong>Resource Reference Error:</strong> "Referenced resource '[path]' not found."</p>
</div>
<div class="paragraph">
<p><strong>Handling:</strong>
* Validation errors SHALL prevent save/export operations
* Errors SHALL be displayed in validation panel with line numbers and details
* User SHALL be able to fix errors and retry</p>
</div>
</div>
<div class="sect3">
<h4 id="_cartridge_creation_errors">27.4.2. Cartridge Creation Errors</h4>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>Database Initialization Failure:</strong> Roll back any partial changes, display error: "Failed to create cartridge database. Check disk space and permissions."
* <strong>GUID Generation Failure:</strong> Retry GUID generation. If persistent failure, display error: "Failed to generate unique identifier. Try again."
* <strong>Schema Creation Error:</strong> Roll back database, display error: "Failed to create cartridge structure. The cartridge file may be corrupted."</p>
</div>
<div class="paragraph">
<p><strong>Logging:</strong> All creation errors SHALL be logged with ERROR level.</p>
</div>
</div>
<div class="sect3">
<h4 id="_signing_errors">27.4.3. Signing Errors</h4>
<div class="paragraph">
<p><strong>Error Messages:</strong>
* <strong>Invalid Certificate Format:</strong> "Certificate file is invalid or corrupted. Select a valid certificate file."
* <strong>Expired Certificate:</strong> "Certificate has expired. Use a valid certificate or generate a new one."
* <strong>Missing Private Key:</strong> "Private key file not found. Provide the private key for signing."
* <strong>Signing Failure:</strong> "Failed to sign cartridge. Check certificate and key files."
* <strong>Certificate Import Error:</strong> "Failed to import certificate. Verify the certificate file format."</p>
</div>
<div class="paragraph">
<p><strong>Handling:</strong>
* Signing errors SHALL prevent export
* User SHALL be able to correct certificate/key issues and retry
* Errors SHALL be displayed with actionable guidance</p>
</div>
</div>
<div class="sect3">
<h4 id="_export_errors">27.4.4. Export Errors</h4>
<div class="paragraph">
<p><strong>Handling:</strong>
* <strong>File Write Error:</strong> Display error: "Failed to write cartridge file. Check disk space and permissions."
* <strong>Disk Full:</strong> Display error: "Insufficient disk space. Free up [X] MB and try again."
* <strong>Permission Error:</strong> Display error: "Permission denied. Check file permissions or choose a different location."
* <strong>Hash Calculation Failure:</strong> Display error: "Failed to calculate content hash. Try exporting again."</p>
</div>
<div class="paragraph">
<p><strong>Recovery:</strong>
* Export errors SHALL NOT affect the working cartridge
* User SHALL be able to retry export after resolving the issue
* Working cartridge state SHALL be preserved</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_implementation">27.5. Logging Implementation</h3>
<div class="sect3">
<h4 id="_logging_framework">27.5.1. Logging Framework</h4>
<div class="paragraph">
<p><strong>Requirements:</strong>
* Minimal logging: Only errors, warnings, and critical security events
* Automatic log rotation: When file reaches 10MB or daily (whichever comes first)
* Maximum retention: 5 rotated log files before deletion
* Platform-appropriate log locations</p>
</div>
</div>
<div class="sect3">
<h4 id="_log_file_locations">27.5.2. Log File Locations</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Platform</th>
<th class="tableblock halign-center valign-middle">Log Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%APPDATA%\SmartBook\logs\</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">macOS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/Library/Application Support/SmartBook/logs/</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/.local/share/SmartBook/logs/</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Log File Naming:</strong>
* Current log: <code>smartbook.log</code>
* Rotated logs: <code>smartbook.log.1</code>, <code>smartbook.log.2</code>, etc. (oldest deleted first)</p>
</div>
</div>
<div class="sect3">
<h4 id="_log_format">27.5.3. Log Format</h4>
<div class="paragraph">
<p><strong>Format:</strong> <code>[TIMESTAMP] [LEVEL] [COMPONENT] MESSAGE</code></p>
</div>
<div class="paragraph">
<p><strong>Example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[2025-12-14 10:23:45.123] [ERROR] [CartridgeDBConnector] Failed to open cartridge: /path/to/file.sqlite - SQLite error: database disk image is malformed
[2025-12-14 10:23:46.456] [WARN] [SignatureVerifier] Hash mismatch detected for cartridge_guid: abc-123-def
[2025-12-14 10:23:47.789] [INFO] [LocalDBManager] Manifest updated: 5 entries</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Fields:</strong>
* <strong>TIMESTAMP:</strong> ISO 8601 format with milliseconds
* <strong>LEVEL:</strong> ERROR, WARN, INFO (DEBUG excluded in production)
* <strong>COMPONENT:</strong> Component name (e.g., CartridgeDBConnector, SignatureVerifier)
* <strong>MESSAGE:</strong> Human-readable error message with context</p>
</div>
</div>
<div class="sect3">
<h4 id="_log_rotation_algorithm">27.5.4. Log Rotation Algorithm</h4>
<div class="paragraph">
<p><strong>Trigger Conditions:</strong>
. Log file size &gt;= 10MB
. Daily rotation (at midnight or application start if &gt;24 hours since last rotation)</p>
</div>
<div class="paragraph">
<p><strong>Rotation Process:</strong>
. Close current log file
. Rename existing rotated files: <code>smartbook.log.N</code> → <code>smartbook.log.N+1</code>
. Rename current log: <code>smartbook.log</code> → <code>smartbook.log.1</code>
. Delete <code>smartbook.log.6</code> if it exists (keep only 5 rotated files)
. Create new <code>smartbook.log</code> file
. Continue logging to new file</p>
</div>
<div class="paragraph">
<p><strong>Implementation Notes:</strong>
* Rotation SHALL be atomic (no log entries lost)
* Rotation SHALL occur automatically without user intervention
* Rotation SHALL be logged (one INFO entry per rotation)</p>
</div>
</div>
<div class="sect3">
<h4 id="_log_levels">27.5.5. Log Levels</h4>
<div class="paragraph">
<p><strong>ERROR:</strong> Critical errors that prevent operation or indicate security issues
* Database failures
* File system errors
* Signature verification failures
* Security violations (path traversal, tampering)</p>
</div>
<div class="paragraph">
<p><strong>WARN:</strong> Non-critical issues that may affect functionality
* Hash mismatches (tampering detection)
* Manifest update failures
* Resource not found (non-critical)
* Performance warnings</p>
</div>
<div class="paragraph">
<p><strong>INFO:</strong> Important operational events
* Application startup/shutdown
* Cartridge import/export
* Log rotation
* Trust decisions</p>
</div>
<div class="paragraph">
<p><strong>DEBUG:</strong> Detailed debugging information (excluded from production logs unless explicitly enabled)</p>
</div>
</div>
<div class="sect3">
<h4 id="_error_context_logging">27.5.6. Error Context Logging</h4>
<div class="paragraph">
<p>When logging errors, the following context SHALL be included:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Error code (if applicable)</p>
</li>
<li>
<p>Component name</p>
</li>
<li>
<p>Operation being performed</p>
</li>
<li>
<p>Relevant identifiers (cartridge_guid, app_id, form_id, etc.)</p>
</li>
<li>
<p>File paths (sanitized to avoid sensitive data)</p>
</li>
<li>
<p>Error message</p>
</li>
<li>
<p>Stack trace (where available)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Sensitive Data Exclusion:</strong>
* User data (form data, file contents) SHALL NOT be logged
* File paths SHALL be sanitized (remove user home directory, show relative paths)
* Passwords and keys SHALL NEVER be logged</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_suite_requirements_and_acceptance_criteria_expanded">28. Test Suite Requirements and Acceptance Criteria (EXPANDED)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This suite ensures validation of all critical security, trust persistence, and architectural isolation requirements from the SRS.</p>
</div>
<div class="sect2">
<h3 id="_security_and_trust_verification">28.1. Security and Trust Verification</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Test Case ID</th>
<th class="tableblock halign-center valign-middle">Requirement</th>
<th class="tableblock halign-center valign-middle">Acceptance Criteria (AC)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-SEC-01</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commercial Trust (FR-2.3.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load an L1 (CA-Signed) cartridge. <strong>AC:</strong> The content renders immediately, and the <code>requestAppConsent</code> call returns TRUE without displaying the native dialog.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-SEC-02</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial Consent (FR-2.3.2/2.3.3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load an L2 (Self-Signed) or L3 (Unsigned) cartridge. <strong>AC:</strong> The content renders, and the first <code>requestAppConsent</code> call triggers the native modal dialog defined in DDD 11.2.1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-SEC-03</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistent Trust (FR-2.4.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute T-SEC-02. Select "Always Trust this cartridge." <strong>AC:</strong> A new record is written to <code>Local_Trust_Registry</code> with <code>app_trust_policy: PERSISTENT</code>. Subsequent loads skip the dialog.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-SEC-04</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tampering Detection (FR-2.4.4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load a persistently trusted cartridge, manually corrupt the file (changing content tables). <strong>AC:</strong> Verification Phase 3 (H1 vs. H2 check) fails, the load is blocked, and an "Rejected (Tampered)" error is displayed <strong>before</strong> any content rendering or application execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-SEC-05</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trust Revocation (FR-2.4.3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revoke persistent trust for a cartridge via the UI. <strong>AC:</strong> The corresponding entry in <code>Local_Trust_Registry</code> is updated to <code>app_trust_policy: REVOKED</code>. The next load forces the user to re-consent (T-SEC-02).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_architectural_and_persistence_validation">28.2. Architectural and Persistence Validation</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Test Case ID</th>
<th class="tableblock halign-center valign-middle">Requirement</th>
<th class="tableblock halign-center valign-middle">Acceptance Criteria (AC)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-PERS-01</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manifest Creation (FR-2.5.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Import a new cartridge file. <strong>AC:</strong> A new entry is created in <code>Local_Library_Manifest</code> containing the correct <code>cartridge_guid</code>, <code>cartridge_hash</code>, <code>title</code>, and the newly required <code>publication_year</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-PERS-02</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi-Window Isolation (FR-2.1.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Cartridge A and Cartridge B simultaneously. Save form data in B, then load data in A. <strong>AC:</strong> Data saved in B is isolated to B&#8217;s <code>User_Data</code> table and does not corrupt or appear in A&#8217;s session. Both Reader View Instances remain fully responsive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-PERS-03</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cartridge Deletion (FR-2.5.5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete a cartridge via the List-View context menu. <strong>AC:</strong> The cartridge file is deleted from the file system. Its records are removed from both the <code>Local_Library_Manifest</code> and the <code>Local_Trust_Registry</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-UI-01</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Library Performance (NFR-3.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open the Library Manager containing 100 cartridges. <strong>AC:</strong> The Library View (Bookshelf or List) loads and displays all required metadata fields within 500 milliseconds, demonstrating reliance on the manifest data, not file parsing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T-UI-02</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UI Dual View (DDD 11.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Toggle between the Bookshelf and List-View. <strong>AC:</strong> Both views load instantly. The List-View displays the required columns: Title, Author, Edition/Version, and Year of Publication, sourced correctly from the manifest.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>